var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var card_main=function(_super){function card_main(){var _this=_super.call(this)||this;return _this.m_pdata_ins=null,_this.m_gamemain_ins=null,_this.m_turn_start=!1,_this.m_game_start=!1,_this}return __extends(card_main,_super),card_main.prototype.start=function(){_super.prototype.start.call(this),this.register_event(game_event.EVENT_TIMER_TICK_1S,this.on_1s_tick),this.m_pdata_ins=data.get_data(data_enum.DATA_CARD),this.m_gamemain_ins=game.get_module(module_enum.MODULE_MAIN),this.register_net_event(protocol_def.S2C_CARDS_ARR,this.on_cards_arr),this.register_net_event(protocol_def.S2C_CARDS_START,this.on_cards_start),this.register_net_event(protocol_def.S2C_CARDS_END,this.on_cards_end),this.register_net_event(protocol_def.S2C_CARDS_HANDS,this.on_cards_hands),this.register_net_event(protocol_def.S2C_CARDS_PLAYERINFO,this.on_cards_pinfo),this.register_net_event(protocol_def.S2C_CARDS_ATK,this.on_cards_atk),this.register_net_event(protocol_def.S2C_CARDS_DEL,this.on_cards_del),this.register_net_event(protocol_def.S2C_CARDS_OPEN,this.on_cards_open),this.register_net_event(protocol_def.S2C_CARDS_CHANGED,this.on_cards_changed),this.register_net_event(protocol_def.S2C_CARDS_TURNSTART,this.on_cards_turnstart),this.register_net_event(protocol_def.S2C_CARDS_TURNEND,this.on_cards_turnend),this.register_net_event(protocol_def.S2C_CARDS_ENTERDLV,this.on_cards_enterdlv),this.register_net_event(protocol_def.S2C_CARDS_DELHAND,this.on_cards_delhand),this.register_event(game_event.EVENT_CARD_REQ_START,this.on_req_start)},card_main.prototype.on_cards_enterdlv=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_enterdlv ",ud);var lv=ud.lv;this.m_pdata_ins.m_dlv=lv,this.m_pdata_ins.reset_map(),this.m_pdata_ins.clear_cards(),this.fire_event(game_event.EVENT_CARD_UPDATEDLV)},card_main.prototype.on_cards_delhand=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_delhand ",ud);var id=ud.id;this.m_pdata_ins.del_hands(id),this.fire_event(game_event.EVENT_CARD_UPDATEHANDS)},card_main.prototype.on_cards_changed=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_changed ",ud);var id=ud.id,shape=ud.shape,atk=ud.atk,hp=ud.hp,duration=ud.duration;this.m_pdata_ins.update_cardsorhands(id,shape,atk,hp,duration),this.fire_event(game_event.EVENT_CARD_CARDCHANGED,id)},card_main.prototype.on_cards_turnstart=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_turnstart ",ud),this.m_turn_start=!0},card_main.prototype.on_cards_turnend=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_turnend ",ud),this.m_turn_start=!1},card_main.prototype.on_cards_atk=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_atk ",ud);var srcid=ud.srcid,dstid=ud.dstid,value=ud.value;this.fire_event(game_event.EVENT_CARD_ATTACK,[srcid,dstid,value])},card_main.prototype.on_cards_del=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_del ",ud);var id=ud.id;this.m_pdata_ins.del_cards(id),this.fire_event(game_event.EVENT_CARD_DELCARD,id)},card_main.prototype.on_cards_open=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_open ",ud);var id=ud.id,shape=ud.shape;this.m_pdata_ins.open_card(id,shape),this.fire_event(game_event.EVENT_CARD_OPENCARD,id)},card_main.prototype.on_cards_hands=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_hands ",ud);var idlist=ud.idlist,shapelist=ud.shapelist,hplist=ud.hplist,atklist=ud.atklist,durationlist=ud.durationlist;this.m_pdata_ins.clear_hands();for(var i=0;i<idlist.length;++i)this.m_pdata_ins.add_hands(idlist[i],shapelist[i],atklist[i],hplist[i],durationlist[i]);this.fire_event(game_event.EVENT_CARD_UPDATEHANDS)},card_main.prototype.on_cards_pinfo=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_pinfo ",ud);var hp=ud.hp,stamina=ud.stamina,armor=ud.armor,atk=ud.atk,exp=ud.exp,dlv=ud.dlv,clv=ud.clv,hpmax=ud.hpmax,staminamax=ud.staminamax;this.m_pdata_ins.m_hp=hp,this.m_pdata_ins.m_stamina=stamina,this.m_pdata_ins.m_armor=armor,this.m_pdata_ins.m_atk=atk,this.m_pdata_ins.m_exp=exp,this.m_pdata_ins.m_dlv=dlv,this.m_pdata_ins.m_clv=clv,this.m_pdata_ins.m_hpmax=hpmax,this.m_pdata_ins.m_staminamax=staminamax,this.fire_event(game_event.EVENT_CARD_PLAYERINFO)},card_main.prototype.on_cards_start=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_start ",ud),this.m_game_start=!0,utils.widget_ins().show_widget(widget_enum.WIDGET_CARDUI,!0)},card_main.prototype.on_cards_end=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_end ",ud),this.m_game_start=!1,this.fire_event(game_event.EVENT_CARD_END)},card_main.prototype.on_cards_arr=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_cards_arr ",ud);var idlist=ud.idlist,shapelist=ud.shapelist,hplist=ud.hplist,atklist=ud.atklist,durationlist=ud.durationlist;this.m_pdata_ins.update_cards(idlist,shapelist,atklist,hplist,durationlist),this.fire_event(game_event.EVENT_CARD_UPDATECARDS)},card_main.prototype.on_req_start=function(ud){void 0===ud&&(ud=null),this.m_game_start||this.req_start()},card_main.prototype.req_start=function(){net.net_ins().send(protocol_def.C2S_CARDS_START,{})},card_main.prototype.req_quit=function(){this.m_game_start&&net.net_ins().send(protocol_def.C2S_CARDS_QUIT,{})},card_main.prototype.req_del_card=function(id){this.m_game_start&&this.m_turn_start&&net.net_ins().send(protocol_def.C2S_CARDS_DEL,{id:id})},card_main.prototype.req_click_card=function(id){this.m_game_start&&this.m_turn_start&&net.net_ins().send(protocol_def.C2S_CARDS_CLICK,{id:id})},card_main.prototype.req_flip_card=function(id){this.m_game_start&&this.m_turn_start&&net.net_ins().send(protocol_def.C2S_CARDS_FLIP,{id:id})},card_main.prototype.req_use_card=function(srcid,dstid){this.m_game_start&&this.m_turn_start&&net.net_ins().send(protocol_def.C2S_CARDS_USE,{srcid:srcid,dstid:dstid})},card_main.prototype.on_1s_tick=function(ud){void 0===ud&&(ud=null)},card_main.prototype.dispose=function(){_super.prototype.dispose.call(this)},card_main}(utils.game_module);game.card_main=card_main}(game||(game={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var chat_msg=function(_super){function chat_msg(){var _this=_super.call(this)||this;return _this.m_btn_y=800,_this}return __extends(chat_msg,_super),chat_msg.prototype.start=function(){_super.prototype.start.call(this),this.register_net_event(protocol_def.S2C_CHAT,this.on_net_chat),this.register_net_event(protocol_def.S2C_CHAT_SYSTEM,this.on_sys_msg),this.register_event(game_event.EVENT_CHATWND_SIZE,this.on_chatwnd_size),this.register_event(game_event.EVENT_CHATWND_SYSMSG,this.on_sys_msg),this.register_event(game_event.EVENT_CHAT_HYPERLINK,this.onPlayerInfo),utils.widget_ins().show_widget(widget_enum.WIDGET_CHAT_BOX,!0)},chat_msg.prototype.on_chatwnd_size=function(ud){void 0===ud&&(ud=null),this.m_btn_y=ud},chat_msg.prototype.on_net_chat=function(user_data){var ch=user_data.ch,svrid=user_data.srvid,pid=user_data.pid,shape=user_data.shape,vip=user_data.vip,name=user_data.name,msg=user_data.msg;this.chat(ch,pid,shape,vip,name,msg,svrid)},chat_msg.prototype.chat=function(ch,pid,shape,vip,name,msg,svrid){var c_data=data.get_data(data_enum.DATA_CHAT);c_data.set_chat_msg(ch,pid,shape,vip,name,msg,svrid),this.fire_event(game_event.EVENT_CHAT,c_data.get_new_chat())},chat_msg.prototype.on_sys_msg=function(user_data){var ch=user_data.ch,msg=user_data.msg;this.chat(ch,0,0,0,"",msg,0)},chat_msg.prototype.send_msg=function(content,channel){void 0===channel&&(channel=base.CHANNEL_WORLD),net.net_ins().send(protocol_def.C2S_CHAT,{ch:channel,msg:content})},chat_msg.prototype.onPlayerInfo=function(ud){if(void 0===ud&&(ud=null),null!=ud&&ud.hyperlink_type==base.HYPERLINK_TYPE.TYPE_OPEN_PLAYER_INFO){var pid=ud.u1;utils.data_ins().get_data(data_enum.DATA_PLAYER).m_pid==pid?utils.widget_ins().show_widget(widget_enum.WIDGET_MAINPLAYER_INFO,!0):net.net_ins().send(protocol_def.C2S_ROLE_INFO,{id:pid})}},chat_msg.prototype.dispose=function(){_super.prototype.dispose.call(this)},chat_msg}(utils.game_module);game.chat_msg=chat_msg}(game||(game={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var combatloadingmgr=function(_super){function combatloadingmgr(){var _this=_super.call(this)||this;return _this.m_assets=null,_this.m_caller=null,_this.m_min_time=1e3,_this.m_start_time=0,_this.m_cur_progress=0,_this.m_start_loading=!1,_this.m_alreadyloaded=!1,_this.m_alreadyload_recorder=new Object,_this.m_delay=0,_this}return __extends(combatloadingmgr,_super),combatloadingmgr.prototype.start=function(){_super.prototype.start.call(this),core.combat_tiplog("combatloadingmgr start"),timer.timer_ins().add_timer(50,this,this.on_time_func)},combatloadingmgr.prototype.on_time_func=function(){if(this.m_start_loading){var cur_time=helper.get_cur_milltime();if(this.m_alreadyloaded&&cur_time>=this.m_start_time+this.m_min_time)return void this.notify_end();this.m_cur_progress+=.05,1<this.m_cur_progress&&(this.m_cur_progress=1),this.fire_event_next_frame(game_event.EVENT_COMBATLOADINGUI_PROGRESS,this.m_cur_progress)}},combatloadingmgr.prototype.add_loadedres=function(path){this.m_alreadyload_recorder[path]=!0},combatloadingmgr.prototype.clear_loadedres_recorder=function(){this.m_alreadyload_recorder=new Object},combatloadingmgr.prototype.start_load=function(assets,caller){if(null==this.m_caller)if(assets.length<=0)this.notify_end();else{for(var need_load=new Array,_i=0,assets_1=assets;_i<assets_1.length;_i++){var i=assets_1[_i];0==this.m_alreadyload_recorder.hasOwnProperty(i.url)&&(this.m_alreadyload_recorder[i.url]=!0,need_load.push(i),core.combat_tiplog("assets ",i.type,i.url))}need_load.length<=0?this.notify_end():(this.m_caller=caller,this.m_assets=need_load,core.combat_tiplog("combat loading 加载开始 ",this.m_assets,this.m_assets.length,this.m_caller,this.m_assets.toString()),this.m_start_time=helper.get_cur_milltime(),this.m_cur_progress=0,this.m_start_loading=!0,this.m_alreadyloaded=!1,core.myload(this.m_assets,laya.utils.Handler.create(this,this.on_load),laya.utils.Handler.create(this,this.on_progress,null,!1)),Laya.loader.on(Laya.Event.ERROR,this,this.onError),utils.widget_ins().show_widget(widget_enum.WIDGET_COMBATLOADING_UI,!0))}},combatloadingmgr.prototype.is_loading=function(){return null!=this.m_caller},combatloadingmgr.prototype.end_load=function(){utils.widget_ins().show_widget(widget_enum.WIDGET_COMBATLOADING_UI,!1),this.m_start_loading=!1,this.m_alreadyloaded=!1,this.m_caller=null},combatloadingmgr.prototype.on_progress=function(v){core.combat_tiplog("combatloading 加载进度 ",v,this.m_assets),v<=this.m_cur_progress||(this.m_cur_progress=v,1<this.m_cur_progress&&(this.m_cur_progress=1),this.fire_event_next_frame(game_event.EVENT_COMBATLOADINGUI_PROGRESS,this.m_cur_progress))},combatloadingmgr.prototype.on_load=function(ud){void 0===ud&&(ud=null),Laya.loader.off(Laya.Event.ERROR,this,this.onError),core.combat_tiplog("combatloading 加载完成 ",this.m_assets),helper.get_cur_milltime()<this.m_start_time+this.m_min_time?this.m_alreadyloaded=!0:this.notify_end()},combatloadingmgr.prototype.notify_end=function(){this.fire_event(game_event.EVENT_COMBATLOADINGMGR_COMPLETE,this.m_caller),this.m_start_loading=!1,this.m_alreadyloaded=!1,this.m_caller=null},combatloadingmgr.prototype.onError=function(err){Laya.loader.off(Laya.Event.ERROR,this,this.onError),core.combat_tiplog("combatloading 加载失败 ",err,this.m_assets),this.fire_event(game_event.EVENT_COMBATLOADINGMGR_ERROR,this.m_caller)},combatloadingmgr.prototype.dispose=function(){_super.prototype.dispose.call(this)},combatloadingmgr}(utils.game_module);game.combatloadingmgr=combatloadingmgr;var combatloadingmgrV2=function(_super){function combatloadingmgrV2(){var _this=_super.call(this)||this;return _this.m_assets=null,_this.m_min_time=500,_this.m_start_time=0,_this.m_start_loading=!1,_this}return __extends(combatloadingmgrV2,_super),combatloadingmgrV2.prototype.start=function(){_super.prototype.start.call(this),core.combat_tiplog("combatloadingmgrV2 start"),timer.timer_ins().add_timer(50,this,this.on_time_func)},combatloadingmgrV2.prototype.on_time_func=function(){if(this.m_start_loading&&helper.get_cur_milltime()>=this.m_start_time+this.m_min_time)return void this.notify_end()},combatloadingmgrV2.prototype.start_load=function(assets){assets.length<=0||(this.m_assets=assets,core.combat_tiplog("combatloadingmgrV2 加载开始 ",this.m_assets,this.m_assets.length,this.m_assets.toString()),this.m_start_time=helper.get_cur_milltime(),this.m_start_loading=!0,Laya.loader.load(this.m_assets,laya.utils.Handler.create(this,this.on_load),null,null,0),Laya.loader.on(Laya.Event.ERROR,this,this.onError))},combatloadingmgrV2.prototype.is_loading=function(){return this.m_start_loading},combatloadingmgrV2.prototype.end_load=function(){this.m_start_loading=!1},combatloadingmgrV2.prototype.on_load=function(ud){void 0===ud&&(ud=null),Laya.loader.off(Laya.Event.ERROR,this,this.onError),core.combat_tiplog("combatloadingmgrV2 加载完成 ",this.m_assets),this.notify_end()},combatloadingmgrV2.prototype.notify_end=function(){this.m_start_loading&&this.fire_event_next_frame(game_event.EVENT_COMBATLOADINGMGRV2_COMPLETE),this.m_start_loading=!1},combatloadingmgrV2.prototype.onError=function(err){Laya.loader.off(Laya.Event.ERROR,this,this.onError),core.combat_tiplog("combatloadingmgrV2 加载失败 ",err,this.m_assets)},combatloadingmgrV2.prototype.dispose=function(){_super.prototype.dispose.call(this)},combatloadingmgrV2}(utils.game_module);game.combatloadingmgrV2=combatloadingmgrV2}(game||(game={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var COMBAT_STATE;game.War_AttackedBehave_Normal=0,game.War_AttackedBehave_Hit=1,game.War_AttackedBehave_Defence=2,game.War_AttackedBehave_Dodge=3,game.War_AttackedBehave_BLOOD=4,game.War_AttackType_Crack=1,game.War_AttackedResult_Normal=0,game.War_AttackedResult_Dead=1,game.War_AttackedResult_FlyAway=2,game.WARTYPE_NORMAL=0,game.WARTYPE_GUAJI=1,game.WARTYPE_BOSS=2,game.WARTYPE_GAME=10,game.WARTYPE_PK=11,game.WARTYPE_CATCHSUMMON=4294967295,game.WARSUBTYPE_NONE=0,game.WARSUBTYPE_GANGPK=1,game.WARSUBTYPE_SVRPK=2,game.WARSUBTYPE_MIBAO=3,game.WARSUBTYPE_TIANTING=4,game.WARSUBTYPE_DAYAN=5,game.WARSUBTYPE_BEST=6,game.WARSUBTYPE_COMMONBOSS=7,game.WARSUBTYPE_ESCORT_PLUNDER=9,game.WARSUBTYPE_ESCORT_REVENGE=10,game.WARSUBTYPE_FENGYAO=11,game.WARSUBTYPE_SCENEPASS=12,game.WARSUBTYPE_MATERIALFB=13,game.WARSUBTYPE_PERSONALBOSS=14,game.WARSUBTYPE_PDYW=15,game.WARSUBTYPE_WB_ROLE=16,game.WARSUBTYPE_WB_BOSS=17,game.WARSUBTYPE_GANG_BOSS=18,game.WARSUBTYPE_GANG_FUBNE=19,game.WARSUBTYPE_TEAMFB=20,game.WARSUBTYPE_SCENEPASS_HELP=21,game.WARSUBTYPE_WULINHEAD=22,game.WARSUBTYPE_FUMO=24,game.WAR_PLAYTYPE_CANJUMP=0,game.WAR_PLAYTYPE_CANNOTJUMP=1,function(COMBAT_STATE){COMBAT_STATE[COMBAT_STATE.STATE_IDLE=0]="STATE_IDLE",COMBAT_STATE[COMBAT_STATE.STATE_RECVPROTOCOL=1]="STATE_RECVPROTOCOL",COMBAT_STATE[COMBAT_STATE.STATE_LOADING=2]="STATE_LOADING",COMBAT_STATE[COMBAT_STATE.STATE_PLAYING=3]="STATE_PLAYING"}(COMBAT_STATE||(COMBAT_STATE={}));var combatmgr=function(_super){function combatmgr(){var _this=_super.call(this)||this;return _this.m_combat=null,_this.m_num_path="res/atlas/combat_num.atlas",_this.m_cmd_arr=new Array,_this.m_b_in_war=!1,_this.m_b_warstart_cmd=!0,_this.m_b_excluded=!1,_this.m_savecmd_list=new Array,_this.m_time_id=0,_this.m_b_preend=!1,_this.m_wartype=0,_this.m_warsubtype=0,_this.m_state=COMBAT_STATE.STATE_IDLE,_this.m_combatplayer=null,_this.m_combatloading=null,_this.m_combatloadingv2=null,_this.m_load_assets=new Array,_this.m_combat_id=0,_this.m_max_bout=0,_this.m_can_skip=0,_this.m_skip_resload=0,_this}return __extends(combatmgr,_super),combatmgr.prototype.start=function(){_super.prototype.start.call(this),core.combat_tiplog("combatmgr start");var game_ins=game.get_module(module_enum.MODULE_MAIN);this.m_combat=game_ins.get_combat_render(),this.m_combat.m_scene.m_render.set_avatar_config(config.Avatarinfo.create_Avatarinfo),this.m_combat.m_scene.m_render.set_map_config(config.Mapinfo.create_Mapinfo),this.m_combat.m_scene.m_render.set_ani_config(config.Aniinfo.create_Aniinfo),this.m_combat.m_scene.m_render.set_eff_config(config.Effectinfo.create_Effectinfo),this.register_event(game_event.EVENT_TESTCOMBATPROTO,this._on_test_combat_protocol),this.register_event(game_event.EVENT_COMBATLOADINGMGR_COMPLETE,this.on_load_complete),this.register_event(game_event.EVENT_COMBATLOADINGMGRV2_COMPLETE,this.on_load_completev2),this.register_event(game_event.EVENT_COMBATLOADINGMGR_ERROR,this.on_load_err),this.register_event(game_event.EVENT_COMBATGO2NEXT,this._on_go2next),this.register_net_event(protocol_def.S2C_WAR_START,this.on_war_start),this.register_net_event(protocol_def.S2C_WAR_END,this.on_war_end),this.register_net_event(protocol_def.S2C_WAR_PREEND,this.on_war_preend),this.register_net_event(protocol_def.S2C_WAR_NEXT,this.on_war_turnstart),this.register_net_event(protocol_def.S2C_WAR_TURN,this.on_war_turnend),this.register_net_event(protocol_def.S2C_WAR_ADD,this.on_war_add),this.register_net_event(protocol_def.S2C_WAR_LEAVE,this.on_war_del),this.register_net_event(protocol_def.S2C_WAR_STATUS,this.on_war_status),this.register_net_event(protocol_def.S2C_WAR_ATTACK_NORMAL,this.on_war_attack),this.register_net_event(protocol_def.S2C_WAR_ATTACK_END,this.on_war_attackend),this.register_net_event(protocol_def.S2C_WAR_PERFORM,this.on_war_skill),this.register_net_event(protocol_def.S2C_WAR_PERFORM_END,this.on_war_skillend),this.register_net_event(protocol_def.S2C_WAR_PARTNER_ATTACK,this.on_war_partneratk),this.register_net_event(protocol_def.S2C_WAR_BACKATTACK,this.on_war_backatk),this.register_net_event(protocol_def.S2C_WAR_BACKATTACK_END,this.on_war_backatkend),this.register_net_event(protocol_def.S2C_WAR_SHAKE,this.on_war_shake),this.register_net_event(protocol_def.S2C_WAR_PROTECT,this.on_war_protect),this.register_net_event(protocol_def.S2C_WAR_ATTACK_STATUS,this.on_war_atkstatus),this.register_net_event(protocol_def.S2C_WAR_BUFF_ADD,this.on_war_buff),this.register_net_event(protocol_def.S2C_WAR_BUFF_DEL,this.on_war_buffdel),this.register_net_event(protocol_def.S2C_WAR_DEFEAT,this.on_war_defeat),this.register_net_event(protocol_def.S2C_WAR_SERIAL,this.on_war_serial),this.m_time_id=timer.timer_ins().add_timer(1e3,this,this.on_wait_warend),this.m_combatplayer=game.get_module(module_enum.MODULE_COMBATPLAYER),this.m_combatplayer.start(),this.m_combatloading=game.get_module(module_enum.MODULE_COMBATLOADING),this.m_combatloadingv2=game.get_module(module_enum.MODULE_COMBATLOADINGV2)},combatmgr.prototype.push_cmd=function(cmd,ud){this.m_cmd_arr.push({cmd:cmd,ud:ud})},combatmgr.prototype.on_wait_warend=function(){this.m_state==COMBAT_STATE.STATE_PLAYING&&null!=this.m_combatplayer&&this.m_combatplayer.is_turnend()&&this.m_combatplayer.is_playerend()&&this.m_combatplayer.get_preend_cmd()&&(this.force_end(),this.do_nextwar_cmd())},combatmgr.prototype.force_end=function(){this.m_cmd_arr.length=0,this.m_combatplayer.force_end(),this.m_combatloading.end_load(),this.m_combatloadingv2.end_load(),this.m_b_in_war=!1,net.net_ins().send(protocol_def.C2S_WAR_PLAYEND,{id:this.m_combat_id}),this.fire_event(game_event.EVENT_OUTCOMBAT,[this.m_wartype,this.m_warsubtype,this.m_combat_id]),this.m_wartype=0,this.m_warsubtype=0,this.m_state=COMBAT_STATE.STATE_IDLE},combatmgr.prototype.end_war=function(all_clear){void 0===all_clear&&(all_clear=!1),this.force_end(),all_clear?this.clear_cachewar_cmd():this.do_nextwar_cmd()},combatmgr.prototype._on_go2next=function(ud){void 0===ud&&(ud=null),this.go2next()},combatmgr.prototype.go2next=function(){this.m_state==COMBAT_STATE.STATE_PLAYING&&null!=this.m_combatplayer&&(this.force_end(),this.do_nextwar_cmd())},combatmgr.prototype.in_combat=function(){return this.m_b_in_war},combatmgr.prototype.is_guaji_combat=function(){return this.m_b_in_war&&(this.m_wartype==game.WARTYPE_GUAJI||this.m_warsubtype==game.WARSUBTYPE_SCENEPASS)},combatmgr.prototype.is_not_guaji_combat=function(){return this.m_b_in_war&&this.m_wartype!=game.WARTYPE_GUAJI&&this.m_warsubtype!=game.WARSUBTYPE_SCENEPASS},combatmgr.prototype.get_combat_res=function(){var assets=[];return assets.push({url:"res/atlas/ani_res/cryout.atlas",type:Laya.Loader.ATLAS}),assets.push({url:"game_ani/combat/cryout.ani",type:Laya.Loader.JSON}),assets.push({url:"res/atlas/ani_res/crack.atlas",type:Laya.Loader.ATLAS}),assets.push({url:"game_ani/combat/crack.ani",type:Laya.Loader.JSON}),assets.push({url:"res/atlas/combat_num.atlas",type:Laya.Loader.ATLAS}),assets},combatmgr.prototype.get_effect_res=function(eid){var assets=[],eff_cfg=config.Effectinfo.get_Effectinfo(eid);return null!=eff_cfg&&(assets.push({url:eff_cfg.res,type:Laya.Loader.ATLAS}),assets.push({url:eff_cfg.path,type:Laya.Loader.JSON})),assets},combatmgr.prototype.get_skilleffect_res=function(pid){var assets=[],skill_perform_cfg=config.Skillperform.get_Skillperform(pid);if(null!=skill_perform_cfg)for(var _i=0,_a=skill_perform_cfg.data;_i<_a.length;_i++){var i=_a[_i];if("effect"==i.action){var effid=parseInt(i.param1),eff_path=this.get_effect_res(effid);0<eff_path.length&&(assets=assets.concat(eff_path))}}return assets},combatmgr.prototype.get_skill_res=function(skillid,skilllv){var assets=[],skill_cfg=config.Skillperformconfig.get_Skillperformconfig(skillid);if(null!=skill_cfg)for(var _i=0,_a=skill_cfg.data;_i<_a.length;_i++){var i=_a[_i];if(i.skilllv==skilllv){var cid1=i.config1,cid2=i.config2;assets=(assets=assets.concat(this.get_skilleffect_res(cid1))).concat(this.get_skilleffect_res(cid2))}}return assets},combatmgr.prototype.get_cmd_res=function(){for(var assets=[],_i=0,_a=this.m_cmd_arr;_i<_a.length;_i++){var i=_a[_i],cmd=i.cmd,ud=i.ud;if(cmd==protocol_def.S2C_WAR_ADD){var shape=ud.shape,desc=ud.desc;0<desc.length&&(assets=(assets=(assets=(assets=(assets=(assets=assets.concat(helper.get_avatar_res(desc,shape,1))).concat(helper.get_avatar_res(desc,shape,0))).concat(helper.get_avatar_res(desc,shape,3))).concat(helper.get_avatar_res(desc,shape,4))).concat(helper.get_avatar_res(desc,shape,7))).concat(helper.get_avatar_res(desc,shape,5)))}else if(cmd==protocol_def.S2C_WAR_PERFORM){var skillid=ud.skillid,skilllv=ud.lv;assets=assets.concat(this.get_skill_res(skillid,skilllv))}else if(cmd==protocol_def.S2C_WAR_BACKATTACK){skillid=ud.skillid,skilllv=ud.lv;assets=assets.concat(this.get_skill_res(skillid,skilllv))}}return assets},combatmgr.prototype.start_load_res=function(){this.m_state=COMBAT_STATE.STATE_LOADING;var assets=this.get_combat_res();if(assets=assets.concat(this.get_cmd_res()),core.combat_tiplog("start_load_res ",assets),assets.length<=0)return this.start_playing(),void this.fire_event(game_event.EVENT_COMBATPLAYING,[this.m_wartype,this.m_warsubtype,this.m_combat_id,this.m_max_bout,this.m_can_skip]);this.m_combatloadingv2.start_load(assets)},combatmgr.prototype.on_load_completev2=function(ud){void 0===ud&&(ud=null),core.combat_tiplog("on_load_complete "),this.m_combatloadingv2.end_load();for(var assets=[],_i=0,_a=this.m_cmd_arr;_i<_a.length;_i++){var cmd=(i=_a[_i]).cmd,ud_1=i.ud;if(cmd==protocol_def.S2C_WAR_ADD){var shape=ud_1.shape,desc=ud_1.desc;0<desc.length&&(assets=(assets=(assets=(assets=(assets=(assets=assets.concat(helper.get_avatar_res(desc,shape,1))).concat(helper.get_avatar_res(desc,shape,0))).concat(helper.get_avatar_res(desc,shape,3))).concat(helper.get_avatar_res(desc,shape,4))).concat(helper.get_avatar_res(desc,shape,7))).concat(helper.get_avatar_res(desc,shape,5)))}else if(cmd==protocol_def.S2C_WAR_PERFORM){var skillid=ud_1.skillid,skilllv=ud_1.lv;assets=assets.concat(this.get_skill_res(skillid,skilllv))}else if(cmd==protocol_def.S2C_WAR_BACKATTACK){skillid=ud_1.skillid,skilllv=ud_1.lv;assets=assets.concat(this.get_skill_res(skillid,skilllv))}}for(var _b=0,assets_1=assets;_b<assets_1.length;_b++){var i=assets_1[_b];this.m_combat.m_scene.m_render.preload_matres(i.url)}this.start_playing(),this.fire_event(game_event.EVENT_COMBATPLAYING,[this.m_wartype,this.m_warsubtype,this.m_combat_id,this.m_max_bout,this.m_can_skip])},combatmgr.prototype.on_load_complete=function(ud){void 0===ud&&(ud=null),core.combat_tiplog("on_load_complete "),this.m_combatloading.end_load(),this.start_playing(),this.fire_event(game_event.EVENT_COMBATPLAYING,[this.m_wartype,this.m_warsubtype,this.m_combat_id,this.m_max_bout,this.m_can_skip])},combatmgr.prototype.on_load_err=function(ud){void 0===ud&&(ud=null),core.combat_errlog("on_load_err ",this.m_load_assets)},combatmgr.prototype.start_playing=function(){core.combat_tiplog("start_playing"),this.m_state=COMBAT_STATE.STATE_PLAYING;for(var _i=0,_a=this.m_cmd_arr;_i<_a.length;_i++){var i=_a[_i],cmd=i.cmd,ud=i.ud;this.run_cmd(cmd,ud)}this.m_cmd_arr.length=0},combatmgr.prototype.run_cmd=function(cmd,ud){switch(core.combat_tiplog("run_cmd ",cmd,ud),cmd){case protocol_def.S2C_WAR_START:this.m_combatplayer.on_war_start(ud);break;case protocol_def.S2C_WAR_END:this.m_combatplayer.on_war_end(ud);break;case protocol_def.S2C_WAR_PREEND:this.m_combatplayer.on_war_preend(ud);break;case protocol_def.S2C_WAR_NEXT:this.m_combatplayer.on_war_turnstart(ud);break;case protocol_def.S2C_WAR_TURN:this.m_combatplayer.on_war_turnend(ud);break;case protocol_def.S2C_WAR_ADD:this.m_combatplayer.on_war_add(ud);break;case protocol_def.S2C_WAR_LEAVE:this.m_combatplayer.on_war_del(ud);break;case protocol_def.S2C_WAR_STATUS:this.m_combatplayer.on_war_status(ud);break;case protocol_def.S2C_WAR_ATTACK_NORMAL:this.m_combatplayer.on_war_attack(ud);break;case protocol_def.S2C_WAR_ATTACK_END:this.m_combatplayer.on_war_attackend(ud);break;case protocol_def.S2C_WAR_PERFORM:this.m_combatplayer.on_war_skill(ud);break;case protocol_def.S2C_WAR_PERFORM_END:this.m_combatplayer.on_war_skillend(ud);break;case protocol_def.S2C_WAR_PARTNER_ATTACK:this.m_combatplayer.on_war_partneratk(ud);break;case protocol_def.S2C_WAR_BACKATTACK:this.m_combatplayer.on_war_backatk(ud);break;case protocol_def.S2C_WAR_BACKATTACK_END:this.m_combatplayer.on_war_backatkend(ud);break;case protocol_def.S2C_WAR_SHAKE:this.m_combatplayer.on_war_shake(ud);break;case protocol_def.S2C_WAR_PROTECT:this.m_combatplayer.on_war_protect(ud);break;case protocol_def.S2C_WAR_ATTACK_STATUS:this.m_combatplayer.on_war_atkstatus(ud);break;case protocol_def.S2C_WAR_BUFF_ADD:this.m_combatplayer.on_war_buff(ud);break;case protocol_def.S2C_WAR_BUFF_DEL:this.m_combatplayer.on_war_buffdel(ud);break;default:core.combat_errlog("run_cmd error cmd! ",cmd,ud)}},combatmgr.prototype.is_saving_cmd=function(){return this.m_b_in_war&&this.m_b_excluded&&!this.m_b_warstart_cmd},combatmgr.prototype.save_war_cmd=function(cmd,ud){core.combat_tiplog("save_war_cmd ",cmd,ud,this.m_savecmd_list.length),this.m_savecmd_list[this.m_savecmd_list.length-1].push({cmd:cmd,ud:ud})},combatmgr.prototype.do_nextwar_cmd=function(){for(core.combat_tiplog("do_nextwar_cmd ");0<this.m_savecmd_list.length;){var arr=this.m_savecmd_list.shift();if(1<arr.length){var first_cmd=arr[0];if(first_cmd.cmd==protocol_def.S2C_WAR_START){var ud=first_cmd.ud;if(null!=ud.playmode&&ud.playmode!=game.WAR_PLAYTYPE_CANJUMP||!(0<this.m_savecmd_list.length)){for(var _i=0,arr_1=arr;_i<arr_1.length;_i++){var i=arr_1[_i];this.pop_war_cmd(i.cmd,i.ud)}return}}}}},combatmgr.prototype.clear_cachewar_cmd=function(){core.combat_tiplog("clear_cachewar_cmd "),this.m_savecmd_list=new Array},combatmgr.prototype.pop_war_cmd=function(cmd,ud){switch(core.combat_tiplog("pop_war_cmd ",cmd,ud),cmd){case protocol_def.S2C_WAR_START:this.on_war_start(ud);break;case protocol_def.S2C_WAR_END:this.on_war_end(ud);break;case protocol_def.S2C_WAR_PREEND:this.on_war_preend(ud);break;case protocol_def.S2C_WAR_NEXT:this.on_war_turnstart(ud);break;case protocol_def.S2C_WAR_TURN:this.on_war_turnend(ud);break;case protocol_def.S2C_WAR_ADD:this.on_war_add(ud);break;case protocol_def.S2C_WAR_LEAVE:this.on_war_del(ud);break;case protocol_def.S2C_WAR_STATUS:this.on_war_status(ud);break;case protocol_def.S2C_WAR_ATTACK_NORMAL:this.on_war_attack(ud);break;case protocol_def.S2C_WAR_ATTACK_END:this.on_war_attackend(ud);break;case protocol_def.S2C_WAR_PERFORM:this.on_war_skill(ud);break;case protocol_def.S2C_WAR_PERFORM_END:this.on_war_skillend(ud);break;case protocol_def.S2C_WAR_PARTNER_ATTACK:this.on_war_partneratk(ud);break;case protocol_def.S2C_WAR_BACKATTACK:this.on_war_backatk(ud);break;case protocol_def.S2C_WAR_BACKATTACK_END:this.on_war_backatkend(ud);break;case protocol_def.S2C_WAR_SHAKE:this.on_war_shake(ud);break;case protocol_def.S2C_WAR_PROTECT:this.on_war_protect(ud);break;case protocol_def.S2C_WAR_ATTACK_STATUS:this.on_war_atkstatus(ud);break;case protocol_def.S2C_WAR_BUFF_ADD:this.on_war_buff(ud);break;case protocol_def.S2C_WAR_BUFF_DEL:this.on_war_buffdel(ud);break;default:core.combat_errlog("run_cmd error cmd! ",cmd,ud)}},combatmgr.prototype.is_skip_preloadres=function(){return 0<this.m_skip_resload},combatmgr.prototype.skip_preloadres=function(){this.m_skip_resload-=1},combatmgr.prototype.on_war_start=function(ud){if(core.combat_tiplog("on_war_start ",ud),this.m_b_in_war){if(this.m_b_excluded)return this.m_savecmd_list.push(new Array),void this.save_war_cmd(protocol_def.S2C_WAR_START,ud);this.force_end()}this.m_b_warstart_cmd=!0,this.m_b_preend=!1;var wartype=ud.type,warsubtype=ud.subtype;null!=ud.id?this.m_combat_id=ud.id:this.m_combat_id=0,null!=ud.skip?this.m_can_skip=ud.skip:this.m_can_skip=0,null!=ud.playmode&&ud.playmode==game.WAR_PLAYTYPE_CANNOTJUMP?this.m_b_excluded=!0:this.m_b_excluded=!1;var max_bout=999;null!=ud.maxbout&&(max_bout=ud.maxbout),this.m_max_bout=max_bout,this.m_wartype=wartype,this.m_warsubtype=warsubtype,this.m_b_in_war=!0,this.fire_event(game_event.EVENT_ENTERCOMBAT,[this.m_wartype,this.m_warsubtype,this.m_combat_id,this.m_max_bout,this.m_can_skip]),this.m_state=COMBAT_STATE.STATE_RECVPROTOCOL,this.m_cmd_arr.length=0,this.push_cmd(protocol_def.S2C_WAR_START,ud),this.is_skip_preloadres()&&(this.start_playing(),this.fire_event(game_event.EVENT_COMBATPLAYING,[this.m_wartype,this.m_warsubtype,this.m_combat_id,this.m_max_bout,this.m_can_skip]))},combatmgr.prototype.on_war_end=function(ud){core.combat_tiplog("on_war_end ",ud.force),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_END,ud):(this.m_b_warstart_cmd=!1,1!=ud.force?(this.push_cmd(protocol_def.S2C_WAR_END,ud),this.is_skip_preloadres()?(this.skip_preloadres(),this.start_playing()):this.start_load_res()):this.force_end())},combatmgr.prototype.on_war_preend=function(ud){core.combat_tiplog("on_war_preend ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_PREEND,ud):(this.m_b_preend=!0,this.push_cmd(protocol_def.S2C_WAR_PREEND,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_turnstart=function(ud){core.combat_tiplog("on_war_turnstart ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_NEXT,ud):(this.push_cmd(protocol_def.S2C_WAR_NEXT,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_turnend=function(ud){core.combat_tiplog("on_war_turnend ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_TURN,ud):(this.push_cmd(protocol_def.S2C_WAR_TURN,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_add=function(ud){core.combat_tiplog("on_war_add ",ud,ud.warid,ud.shape,ud.name,this.m_wartype),1==ud.zoomlvl?ud.scale=1.5:ud.scale=1,this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_ADD,ud):(this.push_cmd(protocol_def.S2C_WAR_ADD,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_del=function(ud){core.combat_tiplog("on_war_del ",ud,this.m_b_preend,ud.warid),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_LEAVE,ud):this.m_b_preend||(this.push_cmd(protocol_def.S2C_WAR_LEAVE,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_status=function(ud){core.combat_tiplog("on_war_status ",ud,ud.warid,ud.hprate),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_STATUS,ud):(this.push_cmd(protocol_def.S2C_WAR_STATUS,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_attack=function(ud){core.combat_tiplog("on_war_attackstart ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_ATTACK_NORMAL,ud):(this.push_cmd(protocol_def.S2C_WAR_ATTACK_NORMAL,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_attackend=function(ud){core.combat_tiplog("on_war_attackend ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_ATTACK_END,ud):(this.push_cmd(protocol_def.S2C_WAR_ATTACK_END,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_skill=function(ud){core.combat_tiplog("on_war_skillstart ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_PERFORM,ud):(this.push_cmd(protocol_def.S2C_WAR_PERFORM,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_skillend=function(ud){core.combat_tiplog("on_war_skillend ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_PERFORM_END,ud):(this.push_cmd(protocol_def.S2C_WAR_PERFORM_END,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_partneratk=function(ud){core.combat_tiplog("on_war_partneratk ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_PARTNER_ATTACK,ud):(this.push_cmd(protocol_def.S2C_WAR_PARTNER_ATTACK,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_backatk=function(ud){core.combat_tiplog("on_war_backatk ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_BACKATTACK,ud):(this.push_cmd(protocol_def.S2C_WAR_BACKATTACK,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_backatkend=function(ud){core.combat_tiplog("on_war_backatkend ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_BACKATTACK_END,ud):(this.push_cmd(protocol_def.S2C_WAR_BACKATTACK_END,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_shake=function(ud){core.combat_tiplog("on_war_shake ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_SHAKE,ud):(this.push_cmd(protocol_def.S2C_WAR_SHAKE,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_protect=function(ud){core.combat_tiplog("on_war_protect ",ud),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_PROTECT,ud):(this.push_cmd(protocol_def.S2C_WAR_PROTECT,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_atkstatus=function(ud){core.combat_tiplog("on_war_atkstatus ",ud,ud.target,ud.status,ud.value),this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_ATTACK_STATUS,ud):(this.push_cmd(protocol_def.S2C_WAR_ATTACK_STATUS,ud),this.is_skip_preloadres()&&this.start_playing())},combatmgr.prototype.on_war_buffdel=function(ud){core.combat_tiplog("on_war_buffdel ",ud),null!=config.Buffinfo.get_Buffinfo(ud.bid)&&(this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_BUFF_DEL,ud):(this.push_cmd(protocol_def.S2C_WAR_BUFF_DEL,ud),this.is_skip_preloadres()&&this.start_playing()))},combatmgr.prototype.on_war_buff=function(ud){core.combat_tiplog("on_war_buff ",ud),null!=config.Buffinfo.get_Buffinfo(ud.bid)&&(this.is_saving_cmd()?this.save_war_cmd(protocol_def.S2C_WAR_BUFF_ADD,ud):(this.push_cmd(protocol_def.S2C_WAR_BUFF_ADD,ud),this.is_skip_preloadres()&&this.start_playing()))},combatmgr.prototype.on_war_defeat=function(ud){var wai_id=ud.idx;this.fire_event_next_frame(game_event.EVENT_COMBAT_DEFEAT,{war_id:wai_id})},combatmgr.prototype.on_war_serial=function(ud){this.fire_event_next_frame(game_event.EVENT_COMBAT_SERIAL,{war_id:this.m_combat_id})},combatmgr.prototype.on_load_succeed=function(){Laya.loader.off(Laya.Event.ERROR,this,this.on_load_error)},combatmgr.prototype.on_load_error=function(err){},combatmgr.prototype._on_test_combat_protocol=function(ud){var eud=ud;this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_START),{type:0,subtype:0,lineup:0,playmode:1});var bout=0;(ud={}).bout=bout,bout++,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_NEXT),ud),(ud={}).warid=1,ud.type=0,ud.status=0,ud.owner=0,ud.shape=101,ud.desc=helper.init_empty_desc(),ud.grade=0,ud.classes=0,ud.name="warrior_1",ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud),(ud={}).warid=21,ud.type=0,ud.status=0,ud.owner=0,ud.shape=101,ud.desc=helper.init_empty_desc(),ud.grade=0,ud.classes=0,ud.name="warrior_21",ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud),(ud={}).warid=22,ud.type=0,ud.status=0,ud.owner=0,ud.shape=101,ud.desc=helper.init_empty_desc(),ud.grade=0,ud.classes=0,ud.name="warrior_22",ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud),(ud={}).warid=23,ud.type=0,ud.status=0,ud.owner=0,ud.shape=101,ud.desc=helper.init_empty_desc(),ud.grade=0,ud.classes=0,ud.name="warrior_23",ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud),(ud={}).warid=1,ud.hprate=1e3,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_STATUS),ud),(ud={}).warid=21,ud.hprate=1e3,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_STATUS),ud),(ud={}).warid=22,ud.hprate=1e3,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_STATUS),ud),this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_TURN),ud),(ud={}).bout=bout,bout++,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_NEXT),ud),(ud={}).att=1,ud.skillid=2,ud.lv=1,ud.lsvic=new Array,ud.lsvic.push(21),ud.lsvic.push(22),ud.round=1,null!=eud&&(ud.skillid=eud),this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_PERFORM),ud),(ud={}).warid=23,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_LEAVE),ud),(ud={warid:23,type:0,status:0,owner:0,shape:101}).desc=helper.init_empty_desc(),ud.grade=0,ud.classes=0,ud.name="warrior_23_2",ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud);for(var i=2;i<11;++i)(ud={}).warid=i,ud.type=0,ud.status=0,ud.owner=0,ud.shape=101,ud.desc=helper.init_empty_desc(),ud.grade=0,ud.classes=0,ud.name="warrior_"+i.toString(),ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud);for(i=24;i<31;++i)(ud={}).warid=i,ud.type=0,ud.status=0,ud.owner=0,ud.shape=101,ud.desc=helper.init_empty_desc(),ud.grade=0,ud.classes=0,ud.name="warrior_"+i.toString(),ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud);(ud={}).target=21,ud.status=33,ud.value=12345,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ATTACK_STATUS),ud),(ud={}).target=22,ud.status=32,ud.value=23456,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ATTACK_STATUS),ud),ud={warid:22,hprate:800},this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_STATUS),ud),ud={},this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_PERFORM_END),ud),this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_TURN),ud);return this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_PREEND),{}),void this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_END),{force:0})},combatmgr.prototype._on_test_combatpos_protocol=function(ud){this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_START),{type:0,subtype:0,lineup:0,playmode:1});var bout=0;(ud={}).bout=bout,bout++,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_NEXT),ud);for(var i=1;i<11;++i)(ud={}).warid=i,ud.type=0,ud.status=0,ud.owner=0,ud.shape=101,ud.desc=helper.init_empty_desc(),helper.set_ride_fdesc(ud.desc,1),helper.set_weapon_fdesc(ud.desc,1),helper.set_wing_fdesc(ud.desc,1),ud.grade=0,ud.classes=0,ud.name="warrior_"+i.toString(),ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud);for(i=21;i<31;++i)(ud={}).warid=i,ud.type=0,ud.status=0,ud.owner=0,ud.shape=101,ud.desc=helper.init_empty_desc(),helper.set_ride_fdesc(ud.desc,1),helper.set_weapon_fdesc(ud.desc,1),helper.set_wing_fdesc(ud.desc,1),ud.grade=0,ud.classes=0,ud.name="warrior_"+i.toString(),ud.title="",this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_ADD),ud);ud={warid:1,bid:101,overlay:1,bout:99};var arr=new Array;arr.push(1),ud.datas=arr,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_BUFF_ADD),ud),this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_TURN),ud),(ud={}).bout=bout,bout++,this.fire_event(game_event.gen_netcmd_event(protocol_def.S2C_WAR_NEXT),ud)},combatmgr.prototype.dispose=function(){this.m_combat=null,this.m_combatloading=null,this.m_combatloadingv2=null,this.m_combatplayer=null,_super.prototype.dispose.call(this)},combatmgr}(utils.game_module);game.combatmgr=combatmgr}(game||(game={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var combatplayer=function(_super){function combatplayer(){var _this=_super.call(this)||this;return _this.m_combat=null,_this.m_cmd_arr=new Array,_this.m_b_pushcmd=!1,_this.m_self_group=0,_this.m_b_preend=!1,_this.m_b_turnstart=!1,_this.m_turnnum=0,_this.m_wartype=0,_this.m_warsubtype=0,_this}return __extends(combatplayer,_super),combatplayer.prototype.start=function(){_super.prototype.start.call(this),core.combat_tiplog("combatplayer start");var game_ins=game.get_module(module_enum.MODULE_MAIN);this.m_combat=game_ins.get_combat_render()},combatplayer.prototype.push_cmd=function(cmd,ud){this.m_cmd_arr.push({cmd:cmd,ud:ud})},combatplayer.prototype.is_guaji_combat=function(){return this.m_wartype==game.WARTYPE_GUAJI},combatplayer.prototype.is_boss_combat=function(){return this.m_wartype==game.WARTYPE_BOSS},combatplayer.prototype.is_summon_caching=function(){return this.m_wartype==game.WARTYPE_CATCHSUMMON},combatplayer.prototype.is_playerend=function(){return this.m_combat.isplayerend()},combatplayer.prototype.is_turnend=function(){return this.m_combat.isturnend()},combatplayer.prototype.get_preend_cmd=function(){return this.m_b_preend},combatplayer.prototype.force_end=function(){this.m_cmd_arr.length=0,this.m_combat.end()},combatplayer.prototype.on_war_start=function(ud){core.combat_tiplog("combatplayer on_war_start ",ud),this.m_b_preend=!1;var wartype=ud.type,warsubtype=ud.subtype;(this.m_wartype=wartype,this.m_warsubtype=warsubtype,0==this.is_guaji_combat()&&0==this.is_summon_caching())&&game.get_module(module_enum.MODULE_SOUND).enter_boss();this.m_self_group=ud.lineup;var gm=game.get_module(module_enum.MODULE_MAIN);Laya.Render.isConchApp;var res_id=utils.data_ins().get_data(data_enum.DATA_PLAYER).get_scene_res_id();this.m_combat.start(null,2560,2560,gm.get_render().get_camera_x(),gm.get_render().get_camera_y(),res_id,"map/city/"+res_id.toString()+"/"+res_id.toString()+".jpg"),this.m_b_turnstart=!0,this.m_turnnum=0,this.m_combat.turnstart(this.m_turnnum),this.m_combat.change_lineup("avatar/lineup.png",-330,-210)},combatplayer.prototype.on_war_end=function(ud){core.combat_tiplog("combatplayer on_war_end ",ud.force),this.m_b_pushcmd&&this.do_cmd(),this.m_b_turnstart&&(this.m_b_turnstart=!1,this.m_combat.turnend())},combatplayer.prototype.on_war_preend=function(ud){core.combat_tiplog("combatplayer on_war_preend ",ud),this.m_b_preend=!0},combatplayer.prototype.on_war_turnstart=function(ud){core.combat_tiplog("combatplayer on_war_turnstart ",ud),this.m_b_turnstart&&this.m_combat.turnend(),this.m_b_turnstart=!0,this.m_turnnum=ud.bout,this.m_combat.turnstart(this.m_turnnum),this.m_combat.buffautocd(),this.m_combat.send_event(game_event.EVENT_COMBATTURNSCHANGE,ud.bout)},combatplayer.prototype.on_war_turnend=function(ud){core.combat_tiplog("combatplayer on_war_turnend ",ud),this.m_b_pushcmd=!1,this.m_b_turnstart=!1,this.do_cmd(),this.m_combat.turnend()},combatplayer.prototype.gen_pos=function(pos,group){return 0==group||(pos<=12?pos+=20:pos-=20),pos},combatplayer.prototype.on_war_add=function(ud){if(core.combat_tiplog("combatplayer on_war_add ",ud,ud.warid,ud.shape,ud.name),this.m_b_pushcmd)this.push_cmd(protocol_def.S2C_WAR_ADD,ud);else{0==this.m_b_turnstart&&(this.m_b_turnstart=!0,this.m_combat.turnstart(this.m_turnnum));var wdata=this.m_combat.get_warrior_ins();wdata.id=ud.warid,wdata.pos=this.gen_pos(ud.warid,this.m_self_group);ud.type;var status=ud.status;ud.owner;wdata.shape=ud.shape;var desc=ud.desc,lv=ud.grade,cls=ud.classes,name=ud.name;ud.zoomlvl;if(wdata.scale=ud.scale,wdata.name=name,wdata.lv=lv,wdata.cls=cls,wdata.b_dead=0!=(8&status),null!=desc&&desc.length){desc.pos=0;var skin=desc.getUint8();0!=skin&&null!=config.Skininfo.get_Skininfo(skin)&&(skin=config.Skininfo.get_Skininfo(skin).aid,skin=helper._get_post_value_by_shape(wdata.shape,skin),wdata.m_desc[0]=skin),desc.pos=2;var weapon=desc.getUint8();0!=weapon&&null!=config.Weaponinfo.get_Weaponinfo(weapon)&&(weapon=config.Weaponinfo.get_Weaponinfo(weapon).aid,wdata.m_desc[1]=weapon),desc.pos=4;var ride=desc.getUint8(),ride_back=0;0!=ride&&null!=config.Rideinfo.get_Rideinfo(ride)&&(ride_back=config.Rideinfo.get_Rideinfo(ride).baid,ride=config.Rideinfo.get_Rideinfo(ride).faid,wdata.m_desc[6]=ride,wdata.m_desc[7]=ride_back,wdata.m_desc[8]=30),desc.pos=6;var wing=desc.getUint8();0!=wing&&null!=config.Winginfo.get_Winginfo(wing)&&(wing=config.Winginfo.get_Winginfo(wing).aid,wdata.m_desc[2]=wing),desc.pos=8;var fairy=desc.getUint8();0!=fairy&&null!=config.Fairyinfo.get_Fairyinfo(fairy)&&(fairy=config.Fairyinfo.get_Fairyinfo(fairy).aid,wdata.m_desc[3]=fairy),desc.pos=10;var aura=desc.getUint8();0!=aura&&null!=config.Auraresinfo.get_Auraresinfo(aura)&&(aura=config.Auraresinfo.get_Auraresinfo(aura).aid,wdata.m_desc[4]=aura),desc.pos=11;var title=desc.getUint8();0!=title&&null!=config.Titleresinfo.get_Titleresinfo(title)&&(title=config.Titleresinfo.get_Titleresinfo(title).aid,wdata.m_desc[5]=title)}this.m_combat.addwarrior(wdata)}},combatplayer.prototype.on_war_del=function(ud){core.combat_tiplog("combatplayer on_war_del ",ud,this.m_b_preend,ud.warid),this.m_b_preend||(this.m_b_pushcmd?this.push_cmd(protocol_def.S2C_WAR_LEAVE,ud):(0==this.m_b_turnstart&&(this.m_b_turnstart=!0,this.m_combat.turnstart(this.m_turnnum)),this.m_combat.delwarrior(ud.warid)))},combatplayer.prototype.on_war_status=function(ud){if(core.combat_tiplog("combatplayer on_war_status ",ud,ud.warid,ud.hprate),this.m_combat.send_event(game_event.EVENT_COMBATPLAYERHPCHANGED,ud),this.m_b_pushcmd)this.push_cmd(protocol_def.S2C_WAR_STATUS,ud);else{0==this.m_b_turnstart&&(this.m_b_turnstart=!0,this.m_combat.turnstart(this.m_turnnum));var wdata=this.m_combat.get_warriorhp_ins();wdata.id=ud.warid,wdata.hp=ud.hprate,wdata.hpmax=1e3,this.m_combat.set_warrior_hp(wdata)}},combatplayer.prototype.on_war_attack=function(ud){core.combat_tiplog("combatplayer on_war_attackstart ",ud),this.m_b_pushcmd&&this.do_cmd(),this.push_cmd(protocol_def.S2C_WAR_ATTACK_NORMAL,ud),this.m_b_pushcmd=!0},combatplayer.prototype.on_war_attackend=function(ud){core.combat_tiplog("combatplayer on_war_attackend ",ud),this.m_b_pushcmd=!1,this.do_cmd()},combatplayer.prototype.on_war_skill=function(ud){core.combat_tiplog("combatplayer on_war_skillstart ",ud),this.m_b_pushcmd&&this.do_cmd(),this.push_cmd(protocol_def.S2C_WAR_PERFORM,ud),this.m_b_pushcmd=!0},combatplayer.prototype.on_war_skillend=function(ud){core.combat_tiplog("combatplayer on_war_skillend ",ud),this.m_b_pushcmd=!1,this.do_cmd()},combatplayer.prototype.on_war_partneratk=function(ud){core.combat_tiplog("combatplayer on_war_partneratk ",ud),this.m_b_pushcmd&&this.push_cmd(protocol_def.S2C_WAR_PARTNER_ATTACK,ud)},combatplayer.prototype.on_war_backatk=function(ud){core.combat_tiplog("combatplayer on_war_backatk ",ud),this.m_b_pushcmd&&this.push_cmd(protocol_def.S2C_WAR_BACKATTACK,ud)},combatplayer.prototype.on_war_backatkend=function(ud){core.combat_tiplog("combatplayer on_war_backatkend ",ud),this.m_b_pushcmd&&this.push_cmd(protocol_def.S2C_WAR_BACKATTACK_END,ud)},combatplayer.prototype.on_war_shake=function(ud){core.combat_tiplog("combatplayer on_war_shake ",ud),this.m_b_pushcmd&&this.push_cmd(protocol_def.S2C_WAR_SHAKE,ud)},combatplayer.prototype.on_war_protect=function(ud){core.combat_tiplog("combatplayer on_war_protect ",ud),this.m_b_pushcmd&&this.push_cmd(protocol_def.S2C_WAR_PROTECT,ud)},combatplayer.prototype._gen_war_atkstatus=function(ud){var id=ud.target,status=ud.status,value=ud.value,status1=3&status,status2=4&status;status2>>=2;var status3=240&status;status3>>=4;var sdata=this.m_combat.get_atkstatus_ins();return sdata.id=id,0<=(sdata.damage=value)?sdata.damagetype=combat.DAMAGETYPE_HP_SUB:(sdata.damagetype=combat.DAMAGETYPE_HP_ADD,sdata.damage=-value),status2==game.War_AttackType_Crack&&(sdata.b_crack=!0),status3==game.War_AttackedResult_FlyAway?sdata.b_fly=!0:status3==game.War_AttackedResult_Dead&&(sdata.b_dead=!0),status1==game.War_AttackedBehave_Dodge?sdata.b_dodge=!0:status1==game.War_AttackedBehave_Defence&&(sdata.b_defend=!0),sdata},combatplayer.prototype.on_war_atkstatus=function(ud){core.combat_tiplog("combatplayer on_war_atkstatus ",ud,ud.target,ud.status,ud.value);var sdata=this._gen_war_atkstatus(ud);this.m_combat.send_event(game_event.EVENT_COMBATPLAYERATTACK,sdata),this.m_b_pushcmd?this.push_cmd(protocol_def.S2C_WAR_ATTACK_STATUS,ud):(0==this.m_b_turnstart&&(this.m_b_turnstart=!0,this.m_combat.turnstart(this.m_turnnum)),this.m_combat.propchange(sdata))},combatplayer.prototype._gen_delbuff_ins=function(ud){var id=ud.warid,buffid=ud.bid,bdata=this.m_combat.get_buffstatus_ins();return bdata.id=id,bdata.buffid=buffid,bdata},combatplayer.prototype.on_war_buffdel=function(ud){if(core.combat_tiplog("combatplayer on_war_buffdel ",ud),this.m_b_pushcmd)this.push_cmd(protocol_def.S2C_WAR_BUFF_DEL,ud);else{0==this.m_b_turnstart&&(this.m_b_turnstart=!0,this.m_combat.turnstart(this.m_turnnum));var bdata=this._gen_delbuff_ins(ud);this.m_combat.delbuff(bdata)}},combatplayer.prototype._gen_addbuff_ins=function(ud){var id=ud.warid,buffid=ud.bid,shape=0,buffeffid=0,cfg=config.Buffinfo.get_Buffinfo(buffid);null!=cfg&&(shape=cfg.icon,buffeffid=cfg.aid);var overlay=ud.overlay,bout=ud.bout,blist=ud.datas,bdata=(blist.length,this.m_combat.get_buffstatus_ins());bdata.id=id,bdata.buffid=buffid,bdata.cd=bout,bdata.overlay=overlay,bdata.buffshape=shape,bdata.buffeffid=buffeffid;for(var _i=0,blist_1=blist;_i<blist_1.length;_i++){var value=blist_1[_i];bdata.datas.push(value)}return bdata},combatplayer.prototype.on_war_buff=function(ud){if(core.combat_tiplog("combatplayer on_war_buff ",ud),this.m_b_pushcmd)this.push_cmd(protocol_def.S2C_WAR_BUFF_ADD,ud);else{0==this.m_b_turnstart&&(this.m_b_turnstart=!0,this.m_combat.turnstart(this.m_turnnum));var bdata=this._gen_addbuff_ins(ud);this.m_combat.addbuff(bdata)}},combatplayer.prototype._handle_last_cmd=function(cmd_arr){for(var left_cmd_arr=new Array,j=0;j<cmd_arr.length;++j){var i=cmd_arr[j];if(i.cmd==protocol_def.S2C_WAR_ATTACK_STATUS){var sub_ud=i.ud,sdata=this._gen_war_atkstatus(sub_ud);this.m_combat.propchange(sdata)}else if(i.cmd==protocol_def.S2C_WAR_STATUS){var w_hp=this.m_combat.get_warriorhp_ins();w_hp.id=i.ud.warid,w_hp.hp=i.ud.hprate,w_hp.hpmax=1e3,this.m_combat.set_warrior_hp(w_hp)}else if(i.cmd==protocol_def.S2C_WAR_BUFF_ADD){var bdata=this._gen_addbuff_ins(i.ud);this.m_combat.addbuff(bdata)}else if(i.cmd==protocol_def.S2C_WAR_BUFF_DEL){bdata=this._gen_delbuff_ins(i.ud);this.m_combat.delbuff(bdata)}else i.cmd==protocol_def.S2C_WAR_ADD?this.on_war_add(i.ud):i.cmd==protocol_def.S2C_WAR_LEAVE?this.on_war_del(i.ud):left_cmd_arr.push(i)}return left_cmd_arr},combatplayer.prototype._do_skill_cmd=function(skill_cmd,cmd_arr){var skillatkobj=this.m_combat.get_skillatk_ins(),cmd=skill_cmd.cmd,ud=skill_cmd.ud;if(skillatkobj.m_type=0,skillatkobj.self_group=this.m_self_group,cmd==protocol_def.S2C_WAR_ATTACK_NORMAL)skillatkobj.id=ud.att,skillatkobj.skillid=1,skillatkobj.skilllv=1,skillatkobj.dst_list.push(ud.vic),skillatkobj.m_type=0;else if(cmd==protocol_def.S2C_WAR_PERFORM){skillatkobj.id=ud.att,skillatkobj.skillid=ud.skillid,skillatkobj.skilllv=ud.lv;ud.round;for(var _i=0,dstlist_1=ud.lsvic;_i<dstlist_1.length;_i++){var i=dstlist_1[_i];skillatkobj.dst_list.push(i)}this.gen_pos(skillatkobj.id,this.m_self_group)<=12?skillatkobj.m_config_id=1:skillatkobj.m_config_id=2,skillatkobj.m_type=1}else if(cmd==protocol_def.S2C_WAR_SHAKE)skillatkobj.id=ud.att,skillatkobj.skillid=2,skillatkobj.skilllv=1,skillatkobj.dst_list.push(ud.vic),skillatkobj.m_type=2;else if(cmd==protocol_def.S2C_WAR_BACKATTACK){skillatkobj.id=ud.att,skillatkobj.skillid=ud.skillid,skillatkobj.skilllv=ud.lv;ud.round;for(var _a=0,dstlist_2=ud.lsvic;_a<dstlist_2.length;_a++){i=dstlist_2[_a];skillatkobj.dst_list.push(i)}skillatkobj.m_type=3}else core.combat_errlog("do_cmd errortype ",cmd);0==skillatkobj.skillid&&(skillatkobj.skillid=2),0==skillatkobj.skilllv&&(skillatkobj.skilllv=1);for(var _b=0,_c=skillatkobj.dst_list;_b<_c.length;_b++){i=_c[_b];for(var b_find=!0,j=0;j<cmd_arr.length&&b_find;++j){if(cmd_arr[j].cmd==protocol_def.S2C_WAR_ATTACK_STATUS)if((sub_ud=cmd_arr[j].ud).target==i){var sdata=this._gen_war_atkstatus(sub_ud);skillatkobj.atkstatus_list.push(sdata),b_find=!1,cmd_arr.splice(j,1)}}}this.m_combat.attack(skillatkobj);for(var _d=0,_e=skillatkobj.dst_list;_d<_e.length;_d++)for(i=_e[_d],b_find=!0,j=cmd_arr.length-1;0<=j;--j){var sub_cmd=cmd_arr[j].cmd,sub_ud=cmd_arr[j].ud;if(sub_cmd==protocol_def.S2C_WAR_STATUS){if(sub_ud.warid==i){var w_hp=this.m_combat.get_warriorhp_ins();w_hp.id=sub_ud.warid,w_hp.hp=sub_ud.hprate,w_hp.hpmax=1e3,this.m_combat.set_warrior_hp(w_hp),cmd_arr.splice(j,1)}}else if(sub_cmd==protocol_def.S2C_WAR_BUFF_ADD){if(sub_ud.warid==i){var bdata=this._gen_addbuff_ins(sub_ud);this.m_combat.addbuff(bdata)}}else if(sub_cmd==protocol_def.S2C_WAR_BUFF_DEL&&sub_ud.warid==i){bdata=this._gen_delbuff_ins(sub_ud);this.m_combat.delbuff(bdata)}}return cmd_arr},combatplayer.prototype.do_cmd=function(){if(core.combat_tiplog("combatplayer do_cmd ",this.m_cmd_arr.length),!(this.m_cmd_arr.length<=0)){for(var cur_cmd,cur_skill_cmd=this.m_cmd_arr.shift(),shake_list=new Array,i=this.m_cmd_arr.length-1;0<=i;--i)(cur_cmd=this.m_cmd_arr[i]).cmd==protocol_def.S2C_WAR_SHAKE&&(shake_list.push(cur_cmd),this.m_cmd_arr.splice(i,1));var counteratklist=new Array,b_push=!1,cur_list=null;for(i=this.m_cmd_arr.length-1;0<=i;--i)(cur_cmd=this.m_cmd_arr[i]).cmd==protocol_def.S2C_WAR_BACKATTACK_END?(b_push=!0,null!=cur_list?core.combat_errlog("counteratk error!multi backattackend"):cur_list=new Array,this.m_cmd_arr.splice(i,1)):cur_cmd.cmd==protocol_def.S2C_WAR_BACKATTACK?(b_push=!1,null==cur_list&&(core.combat_errlog("counteratk error!have not backattackend,only start"),cur_list=new Array),cur_list.push(cur_cmd),cur_list.reverse(),counteratklist.push(cur_list),this.m_cmd_arr.splice(i,1),cur_list=null):b_push&&(cur_list.push(cur_cmd),this.m_cmd_arr.splice(i,1));if(null!=cur_list){core.combat_errlog("counteratk error!have not backattackstart,only end"),cur_list.reverse();for(var _i=0,cur_list_1=cur_list;_i<cur_list_1.length;_i++){i=cur_list_1[_i];this.m_cmd_arr.push(i)}cur_list=null}counteratklist.reverse(),this.m_cmd_arr=this._do_skill_cmd(cur_skill_cmd,this.m_cmd_arr);for(var _a=0,shake_list_1=shake_list;_a<shake_list_1.length;_a++){i=shake_list_1[_a];this.m_cmd_arr=this._do_skill_cmd(i,this.m_cmd_arr)}shake_list=null;for(var _b=0,counteratklist_1=counteratklist;_b<counteratklist_1.length;_b++){cur_cmd=(i=counteratklist_1[_b]).shift();var last_cmd_arr=this._do_skill_cmd(cur_cmd,i);0<last_cmd_arr.length&&0<(last_cmd_arr=this._handle_last_cmd(last_cmd_arr)).length&&core.combat_errlog("counteratk error! still has cmd left ",last_cmd_arr.length)}this.m_cmd_arr=this._handle_last_cmd(this.m_cmd_arr),0<this.m_cmd_arr.length&&core.combat_errlog("skillatk error! still has cmd left ",this.m_cmd_arr.length),this.m_b_pushcmd=!1,this.m_cmd_arr.length=0}},combatplayer.prototype.dispose=function(){this.m_combat=null,_super.prototype.dispose.call(this)},combatplayer}(utils.game_module);game.combatplayer=combatplayer}(game||(game={}));var game_event;__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var combat_ui_mgr=function(_super){function combat_ui_mgr(){var _this=_super.call(this)||this;return _this.b_in_war=!1,_this.war_type=0,_this.war_subType=0,_this.war_id=0,_this.war_round_max=0,_this.war_skip_roundNum=0,_this.round_detail_war_subType_arr=new Array,_this.skip_war_subType_arr=new Array,_this.b_skip_show=!1,_this.b_RoundDetail_show=!1,_this.b_hpPgBar_show=!1,_this}return __extends(combat_ui_mgr,_super),combat_ui_mgr.prototype.start=function(){_super.prototype.start.call(this),this.init_cfg(),this.register_event(game_event.EVENT_ENTERCOMBAT,this.on_enter_combat),this.register_event(game_event.EVENT_COMBATPLAYING,this.on_combat_playing),this.register_event(game_event.EVENT_OUTCOMBAT,this.on_out_combat),this.register_net_event(protocol_def.S2C_QMBOSS_FIGHT_DAMAGE,this.on_netcmd_commobn_boss_hp)},combat_ui_mgr.prototype.init_cfg=function(){var keyStr_arr;this.skip_war_subType_arr=[];for(var _i=0,keyStr_arr_1=keyStr_arr=Object.keys(config.Combat_skip_cfg.get_cfg_object());_i<keyStr_arr_1.length;_i++){var str=keyStr_arr_1[_i];this.skip_war_subType_arr.push(parseInt(str))}keyStr_arr=Object.keys(config.Cli_round_detail_cfg.get_cfg_object()),this.round_detail_war_subType_arr=[];for(var _a=0,keyStr_arr_2=keyStr_arr;_a<keyStr_arr_2.length;_a++){str=keyStr_arr_2[_a];this.round_detail_war_subType_arr.push(parseInt(str))}},combat_ui_mgr.prototype.on_enter_combat=function(ud){void 0===ud&&(ud=null)},combat_ui_mgr.prototype.on_combat_playing=function(ud){void 0===ud&&(ud=null),this.b_in_war=!0,this.war_type=ud[0],this.war_subType=ud[1],this.war_id=ud[2],this.war_round_max=ud[3],this.war_skip_roundNum=ud[4],this.war_type!=game.WARTYPE_GUAJI&&(this._show_combat_round(!0),0<=this.skip_war_subType_arr.indexOf(this.war_subType)&&this._show_skip(!0),0<=this.round_detail_war_subType_arr.indexOf(this.war_subType)&&this._show_combat_detail(!0),this.war_type!=game.WARTYPE_NORMAL&&this.war_type!=game.WARTYPE_BOSS||utils.widget_ins().show_widget(widget_enum.WIDGET_BOSS_GODX,!0,{war_subType:this.war_subType}))},combat_ui_mgr.prototype.on_out_combat=function(ud){void 0===ud&&(ud=null),this.b_in_war=!1,this.war_type=ud[0],this.war_subType=ud[1],this.war_id=ud[2],this.war_type!=game.WARTYPE_GUAJI&&(this._show_combat_round(!1),this.b_skip_show&&this._show_skip(!1),this.b_RoundDetail_show&&this._show_combat_detail(!1),this.b_hpPgBar_show&&this._show_boss_HpPgBar(!1))},combat_ui_mgr.prototype.get_cur_war_info=function(){return[this.war_type,this.war_subType,this.war_id,this.war_round_max]},combat_ui_mgr.prototype._show_combat_round=function(b_show){b_show?0==utils.widget_ins().is_widget_show(widget_enum.WIDGET_COMBAT_ROUND)&&utils.widget_ins().show_widget(widget_enum.WIDGET_COMBAT_ROUND,!0):1==utils.widget_ins().is_widget_show(widget_enum.WIDGET_COMBAT_ROUND)&&utils.widget_ins().show_widget(widget_enum.WIDGET_COMBAT_ROUND,!1)},combat_ui_mgr.prototype._show_combat_detail=function(b_show){b_show?(0==utils.widget_ins().is_widget_show(widget_enum.WIDGET_COMBAT_ROUNDDETAIL)&&utils.widget_ins().show_widget(widget_enum.WIDGET_COMBAT_ROUNDDETAIL,!0),this.b_RoundDetail_show=!0):(1==utils.widget_ins().is_widget_show(widget_enum.WIDGET_COMBAT_ROUNDDETAIL)&&utils.widget_ins().show_widget(widget_enum.WIDGET_COMBAT_ROUNDDETAIL,!1),this.b_RoundDetail_show=!1)},combat_ui_mgr.prototype._show_skip=function(b_show){b_show?(0==utils.widget_ins().is_widget_show(widget_enum.WIDGET_COMBAT_SKIP)&&utils.widget_ins().show_widget(widget_enum.WIDGET_COMBAT_SKIP,!0),this.b_skip_show=!0):(1==utils.widget_ins().is_widget_show(widget_enum.WIDGET_COMBAT_SKIP)&&utils.widget_ins().show_widget(widget_enum.WIDGET_COMBAT_SKIP,!1),this.b_skip_show=!1)},combat_ui_mgr.prototype.on_netcmd_commobn_boss_hp=function(ud){void 0===ud&&(ud=null);ud.warid;for(var my_rank=ud.myrank,my_dmg=ud.mystartdmg,start_hp=ud.starthp,total_hp=ud.hpmax,info_arr=ud.damagelist,rank_arr=new Array,_i=0,info_arr_1=info_arr;_i<info_arr_1.length;_i++){var info=info_arr_1[_i];rank_arr.push([info.id,info.name,info.damage])}var data_ins={myrank:my_rank,my_dmg:my_dmg,start_hp:start_hp,total_hp:total_hp,rank_arr:rank_arr};helper.set_transfer_data("common_boss_hp_data",data_ins),this._show_boss_HpPgBar(!0)},combat_ui_mgr.prototype._show_boss_HpPgBar=function(b_show){b_show?0==utils.widget_ins().is_widget_show(widget_enum.WIDGET_COMBAT_BOSS_HP)&&(utils.widget_ins().show_widget(widget_enum.WIDGET_COMBAT_BOSS_HP,!0),this.b_hpPgBar_show=!0):1==utils.widget_ins().is_widget_show(widget_enum.WIDGET_COMBAT_BOSS_HP)&&(utils.widget_ins().show_widget(widget_enum.WIDGET_COMBAT_BOSS_HP,!1),this.b_hpPgBar_show=!1)},combat_ui_mgr.prototype.dispose=function(){_super.prototype.dispose.call(this)},combat_ui_mgr}(utils.game_module);game.combat_ui_mgr=combat_ui_mgr}(game||(game={})),function(game_event){game_event.EVENT_TEST="test",game_event.EVENT_TEST1="test1",game_event.EVENT_TEST2="test2",game_event.EVENT_TEST3="test3",game_event.EVENT_TIMER_TICK_1S="timer_tick_1s",game_event.EVENT_PLAYERDATA_UPDATED="playerdata_updated",game_event.EVENT_SCENE_CLICK="game_click",game_event.EVENT_SCENE_STOP="scene_stop",game_event.EVENT_PLAYER_ENTER="player_enterscene",game_event.EVENT_PLAYER_OUT="player_outscene",game_event.EVENT_MAINPLAYER_MOVE="mainplayer_move",game_event.EVENT_ENTERSCENE="mainplayer_enterscene",game_event.EVENT_CLICK_PLAYER="scene_click_player",game_event.EVENT_UI_MAINTOPUPDATE="ui_maintop_update",game_event.EVENT_UI_MAINUPDATE="ui_main_update",game_event.EVENT_MSGBOX_CHOOSED="msgbox_choosed",game_event.EVENT_CARD_UPDATEHANDS="card_updatehands",game_event.EVENT_CARD_UPDATECARDS="card_updatecards",game_event.EVENT_CARD_REQ_START="card_req_start",game_event.EVENT_CARD_UPDATEDLV="card_updatedlv",game_event.EVENT_CARD_CARDCHANGED="card_cardchanged",game_event.EVENT_CARD_ATTACK="card_attack",game_event.EVENT_CARD_DELCARD="card_delcard",game_event.EVENT_CARD_OPENCARD="card_open",game_event.EVENT_CARD_PLAYERINFO="card_playerinfo",game_event.EVENT_CARD_END="card_end",game_event.EVENT_CHAT="chat",game_event.EVENT_CHAT_HYPERLINK="chat_hyperlink",game_event.EVENT_CHATWND_SIZE="chatwnd_size",game_event.EVENT_CHATWND_SYSMSG="chatwnd_sysmsg",game_event.EVENT_CHANGE_INPUT_LIMIT="cancel_input_limit",game_event.EVENT_SELECT_EMOTION="select_emotion",game_event.EVENT_SELECT_EMOTION_FCHAT="select_emotion_fchat",game_event.EVENT_KEYBOARD_SHOW="keyboard_show",game_event.EVENT_KEYBOARD_HIDDEN="keyboard_hidden",game_event.EVENT_KEYBOARD_HEIGHT_CHANGE="keyboard_height_change",game_event.EVENT_CHAT_INPUT_MSG="chat_input_msg",game_event.EVENT_CHAT_INPUT_SEND="chat_input_send",game_event.EVENT_CHAT_CLEAR="chat_clear",game_event.EVENT_SOUND_OPEN="sound_open",game_event.EVENT_SOUND_CLOSE="sound_close",game_event.EVENT_BUTTON_CLICK="button_click",game_event.EVENT_TAB_SHOW="tab_show",game_event.EVENT_GAMELOADINGUI_PROGRESS="gameloadingui_progress",game_event.EVENT_ENTERCOMBAT="enter_combat",game_event.EVENT_OUTCOMBAT="out_combat",game_event.EVENT_COMBATPLAYING="combatplaying",game_event.EVENT_COMBATLOADINGUI_PROGRESS="combatloadingui_progress",game_event.EVENT_COMBATPLAYERATTACK="combat_playerattack",game_event.EVENT_COMBATPLAYERHPCHANGED="combat_playerhpchanged",game_event.EVENT_COMBAT_DEFEAT="combat_defeat",game_event.EVENT_COMBAT_SERIAL="combat_serial",game_event.EVENT_COMBAT_NORMAL="combat_normal",game_event.EVENT_COMBAT_QUICK="combat_quick",game_event.EVENT_COMBAT_SPDCHANGED="combat_spdchanged",game_event.EVENT_COMBATTURNSCHANGE="combat_turnchanged",game_event.EVENT_COMBATLOADINGMGR_COMPLETE="combatloadingmgr_complete",game_event.EVENT_COMBATLOADINGMGRV2_COMPLETE="combatloadingmgrv2_complete",game_event.EVENT_COMBATLOADINGMGR_ERROR="combatloadingmgr_error",game_event.EVENT_COMBATGO2NEXT="combatgo2next",game_event.EVENT_LOADINGUI_PROGRESS="loadingui_progress",game_event.EVENT_LOADINGMGR_ERROR="loadingmgr_error",game_event.EVENT_LOADINGMGR_COMPLETE="loadingmgr_complete"}(game_event||(game_event={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var game_main=function(_super){function game_main(){var _this=_super.call(this)||this;return _this.m_ui_sp=null,_this.m_render_sp=null,_this.m_render=null,_this.m_combat_render=null,_this.m_b_combat=!1,_this.m_b_combatplaying=!1,_this.m_combat_spd=1,_this.m_b_net_inited=!1,_this.m_b_gamestart=!1,_this.m_curtime=0,_this.m_itemlist=new Array,_this.m_svr_tm=0,_this.m_svr_clitm=0,_this.m_b_req_guestaccount=!1,_this.m_b_logining=!1,_this.m_b_RC_sp=!0,frametask.add_task(_this,_this.update30,1),frametask.add_task(_this,_this.update20,2),frametask.add_task(_this,_this.update10,6),frametask.add_task(_this,_this.update1,60),_this}return __extends(game_main,_super),game_main.prototype.on_1s_tick=function(){this.fire_event_next_frame(game_event.EVENT_TIMER_TICK_1S)},game_main.prototype.start=function(){_super.prototype.start.call(this),core.game_tiplog("game_main start"),this.m_ui_sp=new laya.display.Sprite,this.m_render_sp=new laya.display.Sprite,this.m_combat_sp=new laya.display.Sprite,utils.widget_ins().set_root(this.m_ui_sp),this.m_combat_render=new combat.combatimpl(this.m_combat_sp),this.m_combat_render.set_skill_config(config.Skillperform.get_Skillperform),this.m_combat_render.set_skillperform_config(config.Skillperformconfig.get_Skillperformconfig),this.m_render=new core.renderagent,this.m_render.set_walk_spd(200),this.m_render.set_avatar_config(config.Avatarinfo.get_Avatarinfo),this.m_render.set_map_config(config.Mapinfo.get_Mapinfo),this.m_render.set_ani_config(config.Aniinfo.get_Aniinfo),this.m_render.set_eff_config(config.Effectinfo.get_Effectinfo),this.m_render.initstage(this.m_render_sp),this.m_render.m_render.setworldwh(2560,2560),this.m_render.setviewport(Laya.stage.designWidth,Laya.stage.designHeight),this.m_combat_render.m_scene.set_viewport(Laya.stage.designWidth,Laya.stage.designHeight),this.m_render.setcamerapos(0,0),this.m_render_sp.width=2560,this.m_render_sp.height=2560,this.m_render_sp.on(Laya.Event.CLICK,this,this.on_click_sp),this.register_net_event(protocol_def.S2C_NOTIFY_MESSAGE,this.on_svr_messagebox),this.register_net_event(protocol_def.S2C_WEBSOCKET_HELLO,this.on_svr_notify),this.register_net_event(protocol_def.S2C_LOGIN,this.on_login_err),this.register_net_event(protocol_def.S2C_LOGIN_OK,this.on_login_ok),this.register_net_event(protocol_def.S2C_LOGIN_RELOGIN,this.on_relogin),this.register_net_event(protocol_def.S2C_NOTIFY_FLOAT,this.on_notifyfloat),this.register_net_event(protocol_def.S2C_LOGIN_SELECTROLE,this.on_selectrole),this.register_net_event(protocol_def.S2C_LOGIN_ROLEINFO,this.on_roleid),this.register_net_event(protocol_def.S2C_ITEM_LIST,this.on_get_itemlist),this.register_net_event(protocol_def.S2C_ASYNTIME,this.on_sync_svrtime),this.register_net_event(protocol_def.S2C_ACCOUNT_GUEST,this.on_account_guest),this.register_event(game_event.EVENT_NET_CONNECTED,this.on_net_connected),this.register_event(game_event.EVENT_NET_CLOSED,this.on_net_closed),this.register_event(game_event.EVENT_NET_ERROR,this.on_net_error),this.register_event(game_event.EVENT_TEST,this.on_testfunc),this.register_event(game_event.EVENT_TEST1,this.on_testfunc1),this.register_event(game_event.EVENT_TEST2,this.on_testfunc2),this.register_event(game_event.EVENT_TEST3,this.on_testfunc3),timer.timer_ins().add_timer(1e3,this,this.on_1s_tick),game.get_module(module_enum.MODULE_SOUND).start(),game.get_module(module_enum.MODULE_PLAYER).start(),game.get_module(module_enum.MODULE_CARD).start(),game.get_module(module_enum.MODULE_SCENE).start(),game.get_module(module_enum.MODULE_CHAT_MSG).start(),game.get_module(module_enum.MODULE_COMBAT).start(),utils.widget_ins().show_widget(widget_enum.WIDGET_MAINUI,!0),utils.widget_ins().show_widget(widget_enum.WIDGET_MAINTOPUI,!0),this.register_event(game_event.EVENT_ENTERCOMBAT,this.on_entercombat),this.register_event(game_event.EVENT_COMBATPLAYING,this.on_combatplaying),this.register_event(game_event.EVENT_OUTCOMBAT,this.on_outcombat),this.register_event(game_event.EVENT_COMBAT_NORMAL,this.on_combat_normal),this.register_event(game_event.EVENT_COMBAT_QUICK,this.on_combat_quick),this.register_event(game_event.EVENT_COMBAT_SPDCHANGED,this.on_combatspd_changed),game.get_module(module_enum.MODULE_LOADING).start(),game.get_module(module_enum.MODULE_COMBATLOADING).start(),game.get_module(module_enum.MODULE_COMBATLOADINGV2).start(),net.net_ins().connect("129.204.91.54",11009),this.on_outcombat()},game_main.prototype.get_render=function(){return this.m_render},game_main.prototype.get_combat_render=function(){return this.m_combat_render},game_main.prototype.on_combat_normal=function(ud){void 0===ud&&(ud=null),this.m_combat_spd=1},game_main.prototype.on_combat_quick=function(ud){void 0===ud&&(ud=null),this.m_combat_spd=1.5},game_main.prototype.on_combatspd_changed=function(ud){void 0===ud&&(ud=null),1<this.m_combat_spd?this.m_combat_spd=1:this.m_combat_spd=2},game_main.prototype.on_entercombat=function(user_data){void 0===user_data&&(user_data=null),this.m_b_combat=!0,game.get_module(module_enum.MODULE_SOUND).enter_boss()},game_main.prototype.on_combatplaying=function(user_data){void 0===user_data&&(user_data=null),1==this.m_b_RC_sp&&(this.m_render_sp.removeSelf(),this.m_combat_sp.removeSelf(),Laya.stage.addChild(this.m_combat_sp),Laya.stage.addChild(this.m_ui_sp)),this.m_b_combatplaying=!0},game_main.prototype.on_outcombat=function(user_data){void 0===user_data&&(user_data=null),1==this.m_b_RC_sp&&(this.m_render_sp.removeSelf(),this.m_combat_sp.removeSelf(),Laya.stage.addChild(this.m_render_sp),Laya.stage.addChild(this.m_ui_sp)),game.get_module(module_enum.MODULE_SOUND).enter_scene(),this.m_b_combat=!1,this.m_b_combatplaying=!1},game_main.prototype.on_tab_show=function(ud){void 0===ud&&(ud=null),1==ud.flag?this._remove_RC_sp():this._add_RC_sp()},game_main.prototype._add_RC_sp=function(){0==this.m_b_RC_sp&&(this.m_combat_sp.removeSelf(),this.m_render_sp.removeSelf(),1==this.m_b_combatplaying?Laya.stage.addChild(this.m_combat_sp):Laya.stage.addChild(this.m_render_sp),Laya.stage.addChild(this.m_ui_sp),this.m_b_RC_sp=!0)},game_main.prototype._remove_RC_sp=function(){1==this.m_b_RC_sp&&(this.m_combat_sp.removeSelf(),this.m_render_sp.removeSelf(),this.m_b_RC_sp=!1)},game_main.prototype.on_click_sp=function(e){core.game_tiplog("onClick sp ",e.stageX,e.stageY),this.fire_event_next_frame(game_event.EVENT_SCENE_CLICK,[e.stageX,e.stageY])},game_main.prototype.on_net_error=function(ud){void 0===ud&&(ud=null),core.net_errlog("on_net_error"),this.m_b_logining=!1,this.m_b_req_guestaccount=!1,helper.show_msgbox("net error")},game_main.prototype.on_net_closed=function(ud){void 0===ud&&(ud=null),core.net_errlog("on_net_closed"),this.m_b_logining=!1,this.m_b_req_guestaccount=!1,helper.show_msgbox("net closed")},game_main.prototype.on_net_connected=function(ud){void 0===ud&&(ud=null),core.net_tiplog("on_net_connected");var account=helper.get_local("my_demo_account"),pwd=helper.get_local("my_demo_pwd");null==account||account.length<=0?this.req_guest_account():this.req_login(account,pwd)},game_main.prototype.req_guest_account=function(){this.m_b_req_guestaccount||(this.m_b_req_guestaccount=!0,net.net_ins().send(protocol_def.C2S_ACCOUNT_GUEST,{}))},game_main.prototype.on_account_guest=function(ud){void 0===ud&&(ud=null),console.log("on_account_guest ",ud,this.m_b_req_guestaccount),this.m_b_req_guestaccount=!1;var account=ud.account,pwd=ud.pwd;helper.set_local("my_demo_account",account),helper.set_local("my_demo_pwd",pwd),this.req_login(account,pwd)},game_main.prototype.req_login=function(account,pwd){if(core.net_tiplog("req_login ",account,pwd,this.m_b_logining),!this.m_b_logining){this.m_b_logining=!0;var ld={clientver:{major:0,minor:0,patch:0},scriptver:{major:0,minor:0,patch:0},productver:{major:0,minor:0,patch:0}};ld.account=account,ld.pwd=pwd,ld.platform=0,ld.client_type=0,ld.device="",ld.ret_session=0,ld.token="",ld.hwinfo="",ld.idfa="",net.net_ins().send(protocol_def.C2S_LOGIN,ld)}},game_main.prototype.on_notifyfloat=function(ud){void 0===ud&&(ud=null),console.log("on_notifyfloat ",ud)},game_main.prototype.on_relogin=function(ud){void 0===ud&&(ud=null),console.log("on_relogin ",ud)},game_main.prototype.on_login_ok=function(ud){void 0===ud&&(ud=null),console.log("on_login_ok ",ud),this.m_b_logining=!1},game_main.prototype.req_svr_tm=function(){console.log("req_svr_tm ");var curtm=laya.utils.Browser.now()/1e3;net.net_ins().send(protocol_def.C2S_LOGIN_ASYN_TIME,{time:curtm,sign:""})},game_main.prototype.get_svr_tm=function(){if(0==this.m_svr_clitm)return 0;var delta=laya.utils.Browser.now()/1e3-this.m_svr_clitm;return this.m_svr_tm+delta},game_main.prototype.on_sync_svrtime=function(ud){void 0===ud&&(ud=null),console.log("on_sync_svrtime ",ud);var clitm=ud.time,svrtm=ud.srvtime;this.m_svr_tm=svrtm,this.m_svr_clitm=clitm,console.log("on_sync_svrtime cur svrtm ",clitm,this.m_svr_tm)},game_main.prototype.on_testfunc2=function(ud){void 0===ud&&(ud=null),console.log("on_testfunc2",ud)},game_main.prototype.on_testfunc3=function(ud){void 0===ud&&(ud=null),console.log("on_testfunc3 buyitem",ud)},game_main.prototype.on_testfunc1=function(ud){void 0===ud&&(ud=null),console.log("on_testfunc1 refresh",ud)},game_main.prototype.on_testfunc=function(ud){void 0===ud&&(ud=null),console.log("on_testfunc")},game_main.prototype.on_roleid=function(ud){void 0===ud&&(ud=null),console.log("on_roleinfo ",ud);var roleid=ud.roles[0].rid,shape=ud.roles[0].shape,name=ud.roles[0].name,mp=data.get_data(data_enum.DATA_PLAYER);mp.m_pid=roleid,mp.m_name=name,mp.m_shape=shape,console.log("request select ",roleid),net.net_ins().send(protocol_def.C2S_LOGIN_SELECTROLE,{rid:roleid})},game_main.prototype.on_get_itemlist=function(ud){void 0===ud&&(ud=null),console.log("on_get_itemlist ",ud);var items=ud.items;this.m_itemlist=new Array;for(var idx=0,_i=0,items_1=items;_i<items_1.length;_i++){var i=items_1[_i],id=i.id,shape=i.sid,pos=i.pos,used=i.key;console.log("item:",idx,id,shape,pos,used),idx+=1,this.m_itemlist.push(i)}},game_main.prototype.on_selectrole=function(ud){void 0===ud&&(ud=null),console.log("on_selectrole ",ud),net.net_ins().send(protocol_def.C2S_ROLE_INFO,{}),net.net_ins().send(protocol_def.C2S_ITEM_GETLIST,{}),this.req_svr_tm()},game_main.prototype.on_login_err=function(ud){void 0===ud&&(ud=null),console.log("on_login_err ",ud),this.m_b_logining=!1},game_main.prototype.on_svr_notify=function(ud){void 0===ud&&(ud=null),console.log("on_svr_notify ",ud)},game_main.prototype.on_svr_messagebox=function(ud){void 0===ud&&(ud=null)},game_main.prototype.update30=function(){if(0==this.m_curtime)this.m_curtime=laya.utils.Browser.now();else{var nowtime=laya.utils.Browser.now(),delta=nowtime-this.m_curtime;this.m_curtime=nowtime,this.m_b_combatplaying?this.m_combat_render.update(delta*this.m_combat_spd):this.m_render.update(delta)}timer.timer_ins().update(laya.utils.Browser.now())},game_main.prototype.update20=function(){},game_main.prototype.update10=function(){utils.event_ins().dispatch_all_delay_event(),net.net_ins().update()},game_main.prototype.update1=function(){utils.widget_ins().check_release(),null==this.m_render||this.m_b_combatplaying||this.m_render.check_release()},game_main.prototype.update=function(d){var nowtime=laya.utils.Browser.now();this.m_b_combatplaying?this.m_combat_render.render():this.m_render.render();var nowtimeafterrender=laya.utils.Browser.now();frametask.run(17-nowtimeafterrender+nowtime)},game_main.prototype.dispose=function(){null!=this.m_render&&(this.m_render.dispose(),this.m_render=null),null!=this.m_combat_render&&(this.m_combat_render.dispose(),this.m_combat_render=null),this.m_ui_sp.removeSelf(),this.m_render_sp.removeSelf(),this.m_combat_sp.removeSelf(),this.m_combat_sp=null,this.m_ui_sp=null,this.m_render_sp=null,_super.prototype.dispose.call(this)},game_main}(utils.game_module);game.game_main=game_main}(game||(game={}));var module_enum;__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var loadingmgr=function(_super){function loadingmgr(){var _this=_super.call(this)||this;return _this.m_assets=null,_this.m_caller=null,_this.m_min_time=3e3,_this.m_start_time=0,_this.m_cur_progress=0,_this.m_temp_show=!1,_this.m_b_loginsucceed=!1,_this}return __extends(loadingmgr,_super),loadingmgr.prototype.start=function(){_super.prototype.start.call(this),core.game_tiplog("loadingmgr start"),timer.timer_ins().add_timer(50,this,this.on_time_func)},loadingmgr.prototype.login_succeed=function(flag){this.m_b_loginsucceed=flag},loadingmgr.prototype.on_time_func=function(){if(this.m_temp_show){var cur_time=helper.get_cur_milltime();cur_time>=this.m_start_time+this.m_min_time?(this.notify_end(),this.m_temp_show=!1):(this.m_cur_progress+=(1-this.m_cur_progress)*(this.m_start_time+this.m_min_time-cur_time)/this.m_min_time,1<this.m_cur_progress&&(this.m_cur_progress=1),this.m_b_loginsucceed?this.fire_event_next_frame(game_event.EVENT_GAMELOADINGUI_PROGRESS,this.m_cur_progress):this.fire_event_next_frame(game_event.EVENT_LOADINGUI_PROGRESS,this.m_cur_progress))}},loadingmgr.prototype.start_load=function(assets,caller,state){void 0===state&&(state=0),null==this.m_caller&&(this.m_caller=caller,this.m_assets=assets,this.m_b_loginsucceed?utils.widget_ins().show_widget(widget_enum.WIDGET_GAMELOADING,!0):utils.widget_ins().show_widget(widget_enum.WIDGET_LOADING_UI,!0),core.myload(assets,laya.utils.Handler.create(this,this.on_load),laya.utils.Handler.create(this,this.on_progress,null,!1)),Laya.loader.on(Laya.Event.ERROR,this,this.onError),core.res_warnlog("loading 加载开始 ",this.m_assets,this.m_caller),this.m_start_time=helper.get_cur_milltime(),this.m_cur_progress=0,this.m_temp_show=!1)},loadingmgr.prototype.is_loading=function(){return null!=this.m_caller},loadingmgr.prototype.end_load=function(){utils.widget_ins().show_widget(widget_enum.WIDGET_LOADING_UI,!1),utils.widget_ins().show_widget(widget_enum.WIDGET_GAMELOADING,!1),this.m_caller=null,this.m_temp_show=!1},loadingmgr.prototype.on_progress=function(v){core.game_tiplog("loading 加载进度 ",v,this.m_assets),this.m_cur_progress=v,1<this.m_cur_progress&&(this.m_cur_progress=1),this.m_b_loginsucceed?this.fire_event_next_frame(game_event.EVENT_GAMELOADINGUI_PROGRESS,this.m_cur_progress):this.fire_event_next_frame(game_event.EVENT_LOADINGUI_PROGRESS,this.m_cur_progress)},loadingmgr.prototype.on_load=function(ud){void 0===ud&&(ud=null),Laya.loader.off(Laya.Event.ERROR,this,this.onError),core.res_warnlog("loading 加载完成 ",this.m_assets),helper.get_cur_milltime()<this.m_start_time+this.m_min_time?this.m_temp_show=!0:this.notify_end()},loadingmgr.prototype.notify_end=function(){this.fire_event(game_event.EVENT_LOADINGMGR_COMPLETE,this.m_caller),this.m_caller=null},loadingmgr.prototype.onError=function(err){Laya.loader.off(Laya.Event.ERROR,this,this.onError),core.game_tiplog("loading 加载失败 ",err,this.m_assets),this.fire_event(game_event.EVENT_LOADINGMGR_ERROR,this.m_caller),this.m_caller=null},loadingmgr.prototype.dispose=function(){_super.prototype.dispose.call(this)},loadingmgr}(utils.game_module);game.loadingmgr=loadingmgr}(game||(game={})),function(game){game.init_game_module=function(){utils.module_ins().register_module(module_enum.MODULE_MAIN,game.game_main),utils.module_ins().register_module(module_enum.MODULE_PLAYER,game.player_main),utils.module_ins().register_module(module_enum.MODULE_CARD,game.card_main),utils.module_ins().register_module(module_enum.MODULE_TIPS,game.tips_mgr),utils.module_ins().register_module(module_enum.MODULE_SYS_MSG,game.sys_msg),utils.module_ins().register_module(module_enum.MODULE_SCENE,game.scene),utils.module_ins().register_module(module_enum.MODULE_CHAT_MSG,game.chat_msg),utils.module_ins().register_module(module_enum.MODULE_SOUND,game.soundmgr),utils.module_ins().register_module(module_enum.MODULE_COMBATLOADING,game.combatloadingmgr),utils.module_ins().register_module(module_enum.MODULE_COMBATPLAYER,game.combatplayer),utils.module_ins().register_module(module_enum.MODULE_COMBATLOADINGV2,game.combatloadingmgrV2),utils.module_ins().register_module(module_enum.MODULE_COMBAT,game.combatmgr),utils.module_ins().register_module(module_enum.MODULE_COMBATUI,game.combat_ui_mgr),utils.module_ins().register_module(module_enum.MODULE_LOADING,game.loadingmgr)},game.get_module=function(module_name){return utils.module_ins().get_module(module_name)}}(game||(game={})),function(module_enum){module_enum.MODULE_MAIN="game_main",module_enum.MODULE_PLAYER="player_main",module_enum.MODULE_CARD="card_main",module_enum.MODULE_TIPS="tips_main",module_enum.MODULE_SYS_MSG="sys_msgbox",module_enum.MODULE_SCENE="scene",module_enum.MODULE_CHAT_MSG="chat_msg",module_enum.MODULE_SOUND="sound",module_enum.MODULE_COMBATLOADING="combatloading",module_enum.MODULE_COMBATLOADINGV2="combatloadingv2",module_enum.MODULE_COMBAT="combat",module_enum.MODULE_COMBATPLAYER="combatplayer",module_enum.MODULE_COMBATUI="combatUI",module_enum.MODULE_LOADING="loading"}(module_enum||(module_enum={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var player_main=function(_super){function player_main(){var _this=_super.call(this)||this;return _this.m_pdata_ins=null,_this.m_gamemain_ins=null,_this}return __extends(player_main,_super),player_main.prototype.start=function(){_super.prototype.start.call(this),this.register_event(game_event.EVENT_TIMER_TICK_1S,this.on_1s_tick),this.register_net_event(protocol_def.S2C_ROLE_INFO,this.on_get_roleinfo),this.m_pdata_ins=data.get_data(data_enum.DATA_PLAYER),this.m_gamemain_ins=game.get_module(module_enum.MODULE_MAIN)},player_main.prototype.on_1s_tick=function(ud){void 0===ud&&(ud=null);var curtm=this.m_gamemain_ins.get_svr_tm();if(0!=curtm){var gold=this.m_pdata_ins.m_gold,goldspd=this.m_pdata_ins.m_goldspd,exp=this.m_pdata_ins.m_exp,expspd=this.m_pdata_ins.m_expspd,stamina=this.m_pdata_ins.m_stamina,lasttm=this.m_pdata_ins.m_last_time;gold+=goldspd*(curtm-lasttm),exp+=expspd*(curtm-lasttm),this.fire_event_next_frame(game_event.EVENT_UI_MAINTOPUPDATE,[gold,stamina]),this.fire_event_next_frame(game_event.EVENT_UI_MAINUPDATE,[exp,this.m_pdata_ins.m_expmax])}},player_main.prototype.on_get_roleinfo=function(ud){void 0===ud&&(ud=null),console.log("on_get_roleinfo ",ud);var lv=ud.lv,shape=ud.shape,exp=ud.exp,gold=ud.gold,expspd=ud.expspd,goldspd=ud.goldspd,stamina=ud.stamina,tm=ud.tm;console.log("info:",lv,shape,exp,gold,expspd,goldspd,stamina,tm);var pdata=this.m_pdata_ins;pdata.m_lv=lv,pdata.m_shape=shape,pdata.m_exp=exp,pdata.m_gold=gold,pdata.m_expspd=expspd,pdata.m_goldspd=goldspd,pdata.m_stamina=stamina,pdata.m_last_time=tm;var exp_obj=config.Player_exp.get_Player_exp(pdata.m_lv);if(null!=exp_obj){var expmax=exp_obj.exp;pdata.m_expmax=expmax}this.fire_event_next_frame(game_event.EVENT_UI_MAINTOPUPDATE)},player_main.prototype.dispose=function(){_super.prototype.dispose.call(this)},player_main}(utils.game_module);game.player_main=player_main}(game||(game={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var scene=function(_super){function scene(){var _this=_super.call(this)||this;return _this.m_role_obj=null,_this.m_b_start_run=!1,_this.m_b_run_start_x=-1,_this.m_b_run_start_y=-1,_this}return __extends(scene,_super),scene.prototype.start=function(){_super.prototype.start.call(this),core.game_tiplog("scene start"),this.register_net_event(protocol_def.S2C_HERO_GOTO,this.on_main_force_goto),this.register_net_event(protocol_def.S2C_HERO_ENTERSCENE,this.on_main_enterscene),this.register_net_event(protocol_def.S2C_MAP_TRACK,this.on_net_rolemove),this.register_net_event(protocol_def.S2C_MAP_DEL,this.on_net_scenedel),this.register_net_event(protocol_def.S2C_MAP_ADDPLAYER,this.on_net_addplayer),this.register_net_event(protocol_def.S2C_MAP_REGIONCHANGE,this.on_regionchanged),this.register_event(game_event.EVENT_SCENE_CLICK,this.on_scene_click),this.register_event(game_event.EVENT_SCENE_STOP,this.on_scene_stop);var game_ins=game.get_module(module_enum.MODULE_MAIN);this.m_render=game_ins.get_render(),this.register_event(game_event.EVENT_TIMER_TICK_1S,this.on_check_mainplayer_pos)},scene.prototype.dispose=function(){_super.prototype.dispose.call(this)},scene.prototype._get_mainrole_id=function(){return data.get_data(data_enum.DATA_PLAYER).m_scene_roleid},scene.prototype.is_mainplayer=function(pid){return pid==data.get_data(data_enum.DATA_PLAYER).m_pid},scene.prototype.on_role_enter=function(id,name,shape,lv,cls,x,y,desc){core.game_tiplog("scene on_role_enter ",id,name,shape,lv,cls,x,y);var scenedata=data.get_data(data_enum.DATA_SCENE),sroledata=scenedata.getrole(id),role_id=0;null!=sroledata&&(core.game_tiplog("error! already have this role ",id),role_id=sroledata.m_role_id,this.m_render.delunit(role_id),scenedata.delrole(id)),scenedata.addrole(id,shape,name,lv,cls,x,y,desc),sroledata=scenedata.getrole(id);var sx=x*this.m_render.getmap_gridw(),sy=y*this.m_render.getmap_gridh();0==shape&&(shape=102),role_id=this.m_render.addunit(name,shape,sx,sy),sroledata.set_role_id(role_id),sroledata.m_desc=desc;var ra=this.m_render.getunit(role_id);null!=ra&&(ra.change_action(0),ra.change_weapon(10001),ra.change_ride(20001,30001),ra.set_ride_h(30),ra.change_wing(40001)),this.fire_event_next_frame(game_event.EVENT_PLAYER_ENTER)},scene.prototype.on_role_out=function(id){core.game_tiplog("scene on_role_out ",id);var scenedata=data.get_data(data_enum.DATA_SCENE),sroledata=scenedata.getrole(id);if(null!=sroledata){var role_id=sroledata.m_role_id;return this.m_render.delunit(role_id),scenedata.delrole(id),void this.fire_event_next_frame(game_event.EVENT_PLAYER_OUT)}if(null!=(sroledata=scenedata.getnpc(id))){role_id=sroledata.m_role_id;return this.m_render.delunit(role_id),void scenedata.delnpc(id)}},scene.prototype.on_role_move=function(id,x,y){core.game_tiplog("scene on_role_move ",id,x,y);var scenedata=data.get_data(data_enum.DATA_SCENE),sroledata=scenedata.getrole(id);if(null!=sroledata||null!=(sroledata=scenedata.getnpc(id))){sroledata.set_pos(x,y);var role_id=sroledata.m_role_id,pt=this.m_render.unit_walk2(role_id,x*this.m_render.getmap_gridw(),y*this.m_render.getmap_gridh()),mavatar=this.m_render.getunit(role_id);null==pt&&null!=mavatar&&this.m_render.is_scene_block(mavatar.x,mavatar.y)&&(pt=this.m_render.unit_walk2(role_id,x*this.m_render.getmap_gridw(),y*this.m_render.getmap_gridh(),!0))}else core.game_tiplog("scene have not this role ",id,x,y)},scene.prototype.on_enter_scene=function(ssid,resid,x,y){core.game_tiplog("scene on_enter_scene ",ssid,resid,x,y),this.m_b_start_run=!1,this.m_b_run_start_x=-1,this.m_b_run_start_y=-1,null!=this.m_render.getunit(this._get_mainrole_id())&&this.m_render.unit_stop(this._get_mainrole_id()),this.m_render.clear();var scenedata=data.get_data(data_enum.DATA_SCENE);scenedata.clearallrole(),scenedata.clearallnpc(),scenedata.clear_all_cli_npc();var mp=data.get_data(data_enum.DATA_PLAYER);mp.m_sid=ssid,mp.m_sresid=resid,mp.x=x,mp.y=y,scenedata.addrole(mp.m_pid,mp.m_shape,mp.m_name,mp.m_lv,mp.m_class,mp.x,mp.y,mp.m_desc),this.m_render.entermap(resid,!1),this.m_render.setmapbk("map/city/"+resid.toString()+"/"+resid.toString()+".jpg");var sx=x*this.m_render.getmap_gridw(),sy=y*this.m_render.getmap_gridh();core.game_tiplog("enter scene create main player ",mp.m_name,mp.m_shape,sx,sy,x,y);var m_role_id=this.m_render.addunit(mp.m_name,mp.m_shape,sx,sy);scenedata.setroleid(mp.m_pid,m_role_id),mp.m_scene_roleid=m_role_id;var unit=this.m_render.getunit(this._get_mainrole_id());null!=unit&&(unit.change_action(0),unit.change_weapon(10001),unit.change_ride(20001,30001),unit.set_ride_h(30),unit.change_wing(40001),this.m_render.cameralookat(unit),this.m_role_obj=unit),this.fire_event_next_frame(game_event.EVENT_MAINPLAYER_MOVE,[x,y]),this.fire_event_next_frame(game_event.EVENT_ENTERSCENE,{scene_id:ssid})},scene.prototype.req_unit_move=function(uid,sx,sy){var sroledata=data.get_data(data_enum.DATA_SCENE).getrole(uid);if(null!=sroledata){uid=sroledata.m_role_id;var wpos=new Laya.Point;wpos.x=sx*this.m_render.getmap_gridw(),wpos.y=sy*this.m_render.getmap_gridh();var ret=this.m_render.unit_walk2(uid,wpos.x,wpos.y),mavatar=this.m_render.getunit(uid);return null==ret&&null!=mavatar&&this.m_render.is_scene_block(mavatar.x,mavatar.y)&&(ret=this.m_render.unit_walk2(uid,wpos.x,wpos.y,!0)),ret}},scene.prototype.req_main_move=function(sx,sy){var wpos=new Laya.Point;wpos.x=sx*this.m_render.getmap_gridw(),wpos.y=sy*this.m_render.getmap_gridh(),this.m_render.addeff(1003,wpos.x,wpos.y,!0,!0);var mp=data.get_data(data_enum.DATA_PLAYER),ret=this.req_unit_move(mp.m_pid,sx,sy);if(null!=ret){var mx=ret.x,my=ret.y;mx=Math.floor(mx/this.m_render.getmap_gridw()),my=Math.floor(my/this.m_render.getmap_gridh()),this.m_b_start_run=!0;var mavatar=this.m_render.getunit(this._get_mainrole_id()),cx=mavatar.x,cy=mavatar.y;cx=Math.floor(cx/this.m_render.getmap_gridw()),cy=Math.floor(cy/this.m_render.getmap_gridh()),-1==this.m_b_run_start_x&&(this.m_b_run_start_x=cx,this.m_b_run_start_y=cy),mp.x=mx,mp.y=my}},scene.prototype.wpos2spos=function(x,y){var wpos=new laya.maths.Point(x*this.m_render.getmap_gridw(),y*this.m_render.getmap_gridh()),spos=this.m_render.worldpos2stagepos(wpos);return spos.x=1*spos.x,spos.y=1*spos.y,spos},scene.prototype.on_click_sp=function(sx,sy){if(0!=this._get_mainrole_id()){var spos=new laya.maths.Point(sx,sy),wpos=this.m_render.stagepos2worldpos(spos),click_id=this.m_render.check_point(wpos.x,wpos.y);if(0!=click_id){for(var scenedata=data.get_data(data_enum.DATA_SCENE),_i=0,_a=scenedata.m_npc_mgr.m_role_list;_i<_a.length;_i++){if((i=_a[_i]).m_role_id==click_id)return void net.net_ins().send(protocol_def.C2S_NPC_LOOK,{id:i.m_pid})}for(var _b=0,_c=scenedata.m_role_mgr.m_role_list;_b<_c.length;_b++){var i;if((i=_c[_b]).m_role_id==click_id&&!this.is_mainplayer(i.m_pid))return void this.fire_event_next_frame(game_event.EVENT_CLICK_PLAYER,{pid:i.m_pid})}}this.req_main_move(wpos.x/this.m_render.getmap_gridw(),wpos.y/this.m_render.getmap_gridh())}},scene.prototype._get_move_dir=function(pt){return 0==pt.x&&0==pt.y?(alert("get_move_dir error!!"),0):0==pt.x&&0<pt.y?0:0==pt.x&&pt.y<0?4:0<pt.x&&0==pt.y?6:pt.x<0&&0==pt.y?2:0<pt.x&&0<pt.y?7:0<pt.x&&pt.y<0?5:pt.x<0&&0<pt.y?1:pt.x<0&&pt.y<0?3:(alert("get_move_dir error end!!"),0)},scene.prototype.send_move_step=function(sx,sy,step_list){var sendbuff=new Laya.Byte;for(sendbuff.endian=Laya.Byte.BIG_ENDIAN;0<step_list.length;){sendbuff.clear(),sendbuff.writeUint16(sx),sendbuff.writeUint16(sy);var step_count=step_list.length;16<step_count&&(step_count=16),sendbuff.writeUint8(step_count);for(var idx=0,tmp=sx.toString()+" "+sy.toString(),step_obj=new Array;idx<step_count;){var pt=step_list.shift(),dir=this._get_move_dir(pt)+1;sendbuff.writeUint8(dir),sx+=pt.x,sy+=pt.y,idx+=1,tmp+=" "+pt.x.toString()+" "+pt.y.toString()+" "+dir.toString(),step_obj.push(dir)}core.game_tiplog("s2c movestep ",tmp),net.net_ins().send_raw_buff(320,sendbuff)}},scene.prototype.on_check_mainplayer_pos=function(ud){if(void 0===ud&&(ud=null),null!=this.m_role_obj){var x=this.m_role_obj.x,y=this.m_role_obj.y,ret=this.m_render.is_scene_mask(x,y);this.m_role_obj.alpha=ret?.5:1}if(this.m_b_start_run){core.game_tiplog("on_check_mainplayer_pos start");var mavatar=this.m_render.getunit(this._get_mainrole_id()),cx=mavatar.x,cy=mavatar.y;if(cx=Math.floor(cx/this.m_render.getmap_gridw()),cy=Math.floor(cy/this.m_render.getmap_gridh()),core.game_tiplog("on_check_mainplayer_pos ",this.m_b_run_start_x,this.m_b_run_start_y,cx,cy),cx==this.m_b_run_start_x&&cy==this.m_b_run_start_y)return 0==this.m_render.is_unit_walk(this._get_mainrole_id())&&(this.m_b_start_run=!1),this.fire_event_next_frame(game_event.EVENT_MAINPLAYER_MOVE,[cx,cy]),void core.game_tiplog("on_check_mainplayer_pos end1");var dx=cx-this.m_b_run_start_x,dy=cy-this.m_b_run_start_y;0!=dx&&(dx/=Math.abs(dx)),0!=dy&&(dy/=Math.abs(dy));for(var step_list=new Array,stepx=this.m_b_run_start_x,stepy=this.m_b_run_start_y;stepx!=cx||stepy!=cy;)step_list.push(new laya.maths.Point(dx,dy)),(stepx+=dx)==cx&&(dx=0),(stepy+=dy)==cy&&(dy=0);this.send_move_step(this.m_b_run_start_x,this.m_b_run_start_y,step_list),this.m_b_run_start_x=cx,this.m_b_run_start_y=cy,this.fire_event_next_frame(game_event.EVENT_MAINPLAYER_MOVE,[cx,cy]),core.game_tiplog("on_check_mainplayer_pos end2")}},scene.prototype.on_scene_stop=function(ud){void 0===ud&&(ud=null),this.m_b_start_run=!1,this.m_b_run_start_x=-1,this.m_b_run_start_y=-1},scene.prototype.on_main_force_goto=function(ud){void 0===ud&&(ud=null),this.m_b_start_run=!1,this.m_b_run_start_x=-1,this.m_b_run_start_y=-1;var x=ud.x,y=ud.y;core.game_errlog("on_main_force_goto ",x,y);var mavatar=this.m_render.getunit(this._get_mainrole_id());null!=mavatar&&(this.m_render.unit_stop(this._get_mainrole_id()),mavatar.set_pos(x*this.m_render.getmap_gridw(),y*this.m_render.getmap_gridh()))},scene.prototype.on_main_enterscene=function(ud){void 0===ud&&(ud=null);ud.id,ud.scid;var ssid=ud.scsid,resid=ud.resid,x=(ud.scname,ud.x),y=ud.y;core.game_tiplog("on_main_enterscene ",ud,x,y),this.on_enter_scene(ssid,resid,x,y)},scene.prototype.on_net_addplayer=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_net_addplayer ",ud);var id=ud.id,name=ud.name,shape=ud.shape,x=ud.x,y=ud.y,desc=ud.desc;this.on_role_enter(id,name,shape,1,1,x,y,desc)},scene.prototype.on_regionchanged=function(ud){core.game_tiplog("on_regionchanged ",ud);var left=ud.x,top=ud.y,right=ud.rw,bottom=ud.rh;core.game_tiplog("on_regionchanged ",left,top,right,bottom);for(var _i=0,_a=data.get_data(data_enum.DATA_SCENE).m_role_mgr.m_role_list;_i<_a.length;_i++){var i=_a[_i];this.is_mainplayer(i.m_pid)||(i.x<left||i.x>right||i.y<top||i.y>bottom)&&this.on_role_out(i.m_pid)}},scene.prototype.on_net_scenedel=function(ud){core.game_tiplog("on_net_scenedel ",ud);var id=ud.id;this.on_role_out(id)},scene.prototype.on_net_rolemove=function(ud){void 0===ud&&(ud=null),core.game_tiplog("on_net_rolemove ",ud);var id=ud.id,x=ud.x,y=ud.y,dx=ud.dx,dy=ud.dy;core.game_tiplog("on_net_rolemove data ",id,x,y,dx,dy),this.on_role_move(id,dx,dy)},scene.prototype.on_scene_click=function(user_data){void 0===user_data&&(user_data=null),core.game_tiplog("scene ins on_game_click ",user_data),this.on_click_sp(user_data[0],user_data[1])},scene}(utils.game_module);game.scene=scene}(game||(game={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var soundmgr=function(_super){function soundmgr(){var _this=_super.call(this)||this;return _this.m_state=-1,_this.m_b_stop=!1,_this.m_sound_savekey="xiaomi_game_sound",_this.m_cur_musicurl="",_this.m_cur_soundurl="",_this.b_stop_music=!1,_this}return __extends(soundmgr,_super),soundmgr.prototype.start=function(){_super.prototype.start.call(this),this.register_event(game_event.EVENT_SOUND_OPEN,this.on_sound_open),this.register_event(game_event.EVENT_SOUND_CLOSE,this.on_sound_close),this.register_event(game_event.EVENT_BUTTON_CLICK,this.on_button_click);var open_str=helper.get_local(this.m_sound_savekey);if(null==open_str||open_str.length<=0)this.m_b_stop=!1;else{var flag=parseInt(open_str);this.m_b_stop=0==flag}Laya.SoundManager.autoReleaseSound=!1},soundmgr.prototype._stopmusic=function(){0<this.m_cur_musicurl.length&&(Laya.SoundManager.stopMusic(),1==this.b_stop_music&&Laya.SoundManager.destroySound(this.m_cur_musicurl),this.m_cur_musicurl="")},soundmgr.prototype._stopsound=function(){0<this.m_cur_soundurl.length&&(Laya.SoundManager.stopSound(this.m_cur_soundurl),1==this.b_stop_music&&Laya.SoundManager.destroySound(this.m_cur_soundurl),this.m_cur_soundurl="")},soundmgr.prototype.on_sound_close=function(ud){void 0===ud&&(ud=null),this.m_b_stop=!0,helper.set_local(this.m_sound_savekey,"0"),Laya.SoundManager.stopAll(),this._stopmusic(),this._stopsound()},soundmgr.prototype.is_open=function(){return this.m_b_stop},soundmgr.prototype.on_sound_open=function(ud){void 0===ud&&(ud=null),this.m_b_stop=!1,helper.set_local(this.m_sound_savekey,"1"),1==this.m_state?this.m_state=-1:2==this.m_state?(this.m_state=-1,this.enter_scene()):3==this.m_state&&(this.m_state=-1,this.enter_boss())},soundmgr.prototype.on_button_click=function(ud){void 0===ud&&(ud=null),1!=this.m_b_stop&&(this.m_cur_soundurl="sound/mousedown_btn.wav",Laya.SoundManager.playSound(this.m_cur_soundurl))},soundmgr.prototype.enter_game=function(){1!=this.m_state&&(this.m_state=1,this.m_b_stop||(this._stopmusic(),this.m_cur_musicurl="sound/login.mp3",Laya.SoundManager.playMusic(this.m_cur_musicurl)))},soundmgr.prototype.enter_scene=function(){2!=this.m_state&&(this.m_state=2,this.m_b_stop||(this._stopmusic(),this.m_cur_musicurl="sound/normal.mp3",Laya.SoundManager.playMusic(this.m_cur_musicurl)))},soundmgr.prototype.enter_boss=function(){3!=this.m_state&&(this.m_state=3,this.m_b_stop||(this._stopmusic(),this.m_cur_musicurl="sound/boss.mp3",Laya.SoundManager.playMusic(this.m_cur_musicurl)))},soundmgr.prototype.play_sound=function(url){this.m_b_stop||(this._stopsound(),this.m_cur_soundurl=url,Laya.SoundManager.playSound(this.m_cur_soundurl))},soundmgr.prototype.stop_sound=function(url){Laya.SoundManager.stopSound(url),1==this.b_stop_music&&Laya.SoundManager.destroySound(url),this.m_cur_soundurl==url&&(this.m_cur_soundurl="")},soundmgr.prototype.dispose=function(){_super.prototype.dispose.call(this)},soundmgr}(utils.game_module);game.soundmgr=soundmgr}(game||(game={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var sys_msg=function(_super){function sys_msg(){return _super.call(this)||this}return __extends(sys_msg,_super),sys_msg.prototype.start=function(){_super.prototype.start.call(this),this.register_net_event(protocol_def.S2C_CLIENT_COMMAND,this.on_netcmd_client_cmd)},sys_msg.prototype.show_msgbox=function(p_content){data.get_data(data_enum.DATA_MSGBOX).set_msgbox_data(1,p_content,null,null,""),0==utils.widget_ins().is_widget_show(widget_enum.WIDGET_MSGBOX)&&utils.widget_ins().show_widget(widget_enum.WIDGET_MSGBOX,!0)},sys_msg.prototype.show_msg_box=function(p_caller,p_content,p_user_data,NoTips_keys){void 0===p_user_data&&(p_user_data=null),void 0===NoTips_keys&&(NoTips_keys="");var mb_data=data.get_data(data_enum.DATA_MSGBOX);mb_data.set_msgbox_data(2,p_content,p_caller,p_user_data,NoTips_keys),1==mb_data.get_NoTips_flag(NoTips_keys)?this.fire_choosed(p_caller,!0,p_user_data):0==utils.widget_ins().is_widget_show(widget_enum.WIDGET_MSGBOX)&&utils.widget_ins().show_widget(widget_enum.WIDGET_MSGBOX,!0)},sys_msg.prototype.fire_choosed=function(p_caller,b_choosed,p_user_data){void 0===p_user_data&&(p_user_data=null),this.fire_event_next_frame(game_event.EVENT_MSGBOX_CHOOSED,[p_caller,b_choosed,p_user_data])},sys_msg.prototype.on_netcmd_client_cmd=function(ud){void 0===ud&&(ud=null);var data_arr=ud.msg.split(" ");helper.do_test(data_arr)},sys_msg.prototype.dispose=function(){_super.prototype.dispose.call(this)},sys_msg}(utils.game_module);game.sys_msg=sys_msg}(game||(game={}));var game;__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(game){var Tips=function(_super){function Tips(){var _this=_super.call(this)||this;return _this.count=0,_this.b_icon=!1,_this.s_w=0,_this.bk=new Laya.Image,_this.bk.height=90,_this.bk.skin="bigpic/tipsbk.png",_this.bk.sizeGrid="0,220,0,220",_this.addChild(_this.bk),_this.msg=new Laya.HTMLDivElement,_this.msg.x=170,_this.msg.y=19,_this.msg.style.font="42px h5font",_this.msg.style.color="#ffffff",_this.msg.style.width=1100,_this.addChild(_this.msg),_this.cacheAs="bitmap",_this}return __extends(Tips,_super),Tips.prototype.set_msg=function(t_node){try{this.msg.innerHTML=t_node.msg}catch(error){this.msg.innerHTML="",core.game_errlog("ScreenTips XML Error:",t_node.type,t_node.msg,t_node.item_shape,t_node.icon)}if(0==t_node.type||1==t_node.type){this.b_icon=!1;var d_v=this.msg.contextWidth-300;d_v<0?(this.s_w=640,this.msg.x=170-d_v/2):(this.s_w=640+d_v,this.msg.x=170)}this.bk.width=this.s_w},Tips.prototype.show=function(flag){this.visible=flag},Tips.prototype.reset=function(){this.visible=!1,this.count=0,this.s_w=0,1==this.b_icon&&(this.b_icon=!1)},Tips}(Laya.Sprite);game.Tips=Tips;var tips_mgr=function(_super){function tips_mgr(){var _this=_super.call(this)||this;return _this.pool_arr=new Array,_this}return __extends(tips_mgr,_super),tips_mgr.prototype.start=function(){_super.prototype.start.call(this)},tips_mgr.prototype._create_tips_ins=function(){var tips_ins=new Tips;this.pool_arr.push(tips_ins)},tips_mgr.prototype.get_tips_ins=function(){return 0==this.pool_arr.length&&this._create_tips_ins(),this.pool_arr.pop()},tips_mgr.prototype.revert_tips_ins=function(ins){this.pool_arr.push(ins)},tips_mgr.prototype.revert_tips_ins_arr=function(ins_arr){this.pool_arr=this.pool_arr.concat(ins_arr)},tips_mgr.prototype.show_tips=function(ud){void 0===ud&&(ud=null);var text=ud.text;null!=text&&(data.get_data(data_enum.DATA_TIPS).add_tips_node(0,text),0==utils.widget_ins().is_widget_show(widget_enum.WIDGET_TIPS)&&utils.widget_ins().show_widget(widget_enum.WIDGET_TIPS,!0))},tips_mgr.prototype.dispose=function(){_super.prototype.dispose.call(this)},tips_mgr}(utils.game_module);game.tips_mgr=tips_mgr}(game||(game={}));