var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(combat){var warrior=function(){function warrior(){this.id=0,this.roleid=0,this.pos=0,this.shape=0,this.group=0,this.cls=0,this.lv=0,this.scale=1,this.name="undefine",this.b_dead=!1,this.desc=null,this.m_desc=new Array;for(var i=0;i<10;++i)this.m_desc.push(0)}return warrior.prototype.clone_data=function(d){if(d.id=this.id,d.roleid=this.roleid,d.pos=this.pos,d.shape=this.shape,d.group=this.group,d.cls=this.cls,d.lv=this.lv,d.scale=this.scale,d.name=this.name,d.b_dead=this.b_dead,null!=this.desc)for(d.desc=new Laya.Byte,this.desc.pos=0;0<this.desc.bytesAvailable;)d.desc.writeByte(this.desc.getByte());if(0<this.m_desc.length)for(var i=0;i<this.m_desc.length;++i)d.m_desc.push(this.m_desc[i])},warrior}();combat.warrior=warrior;var warrior_hp=function(){this.id=0,this.hp=0,this.hpmax=0,this.mp=0,this.mpmax=0};combat.warrior_hp=warrior_hp;var atk_status=function(){this.damagetype=0,this.b_crack=!1,this.b_dead=!1,this.b_vanish=!1,this.b_fly=!1,this.b_revive=!1,this.b_defend=!1,this.b_dodge=!1};combat.atk_status=atk_status;var buff_status=function(){this.datas=new Array};combat.buff_status=buff_status;var skillatk=function(){this.self_group=0,this.dst_list=new Array,this.atkstatus_list=new Array,this.addbuff_list=new Array,this.subbuff_list=new Array,this.m_config_id=1};combat.skillatk=skillatk;var combat_turn=function(){function combat_turn(num){this.m_num=0,this.m_action_list=new Array,this.m_action_idx=0,this.m_add_list=new Array,this.m_sethp_list=new Array,this.m_num=num}return combat_turn.prototype.is_end=function(){return this.m_action_idx>=this.m_action_list.length},combat_turn.prototype.do=function(){0==this.is_end()&&(this.m_action_list[this.m_action_idx].do(),this.m_action_idx+=1)},combat_turn.prototype.dispose=function(){},combat_turn}();combat.combat_turn=combat_turn;var combatimpl=function(_super){function combatimpl(sp){var _this=_super.call(this)||this;return _this.m_scene=null,_this.m_turn_list=new Array,_this.m_turn_idx=0,_this.m_cur_turn=null,_this.m_player=new combat.combat_player,_this.m_b_end=!0,_this.m_skillperform_config=null,_this.m_skill_config=null,_this.m_skill_configmap=new Object,_this.m_skillperform_cache=new Object,_this.m_scene=new combat.combatscene(_this,sp),_this}return __extends(combatimpl,_super),combatimpl.prototype.set_tm=function(tp,tm){switch(tp){case 0:combat.combat_action.ATTACKED_TM=tm;break;case 1:combat.combat_action.DEAD_ATTACKED_TM=tm;break;case 2:combat.combat_action.DEAD_TM=tm;break;case 3:combat.combat_action.FLY_ATTACKED_TM=tm;break;case 4:combat.combat_action.FLY_TM=tm;break;case 5:combat.combat_action.DODGE_TM=tm;break;case 6:combat.combat_action.DEFEND_TM=tm;break;case 7:combat.combat_action.REVIVE_TM=tm}},combatimpl.prototype.get_skillperformcryout=function(skillid){var skillconfig=this.m_skillperform_config(skillid);return null==skillconfig||null==skillconfig?"未知技能"+skillid.toString():skillconfig.cryout},combatimpl.prototype.parse_skillcfg_by_s=function(id,s){var ret=new Object;ret.id=id,ret.data=[];for(var _i=0,l_1=s.split("\r\n");_i<l_1.length;_i++){var p=l_1[_i].split(",");if(1<p.length){var tm=parseInt(p[0]),action=p[1],o=new Object;o.tm=tm,o.action=action;for(var p_idx=1,j=2;j<p.length;++j){var param=p[j];o["param"+p_idx.toString()]=param,p_idx+=1}ret.data.push(o)}}return ret},combatimpl.prototype.set_skillperformcfg_cache=function(id,cfg){this.m_skillperform_cache[id]=cfg},combatimpl.prototype.get_skillperformcfg_cache_frompack=function(id){if(null!=this.m_skillperform_cache[id])return this.m_skillperform_cache[id];var file_name="/"+id.toString()+".txt",n=core.filepack_ins().get_file_len("skillperform",file_name);if(0<n){var s=core.filepack_ins().get_file("skillperform",file_name).getUTFBytes(n),s_o=this.parse_skillcfg_by_s(id,s);this.set_skillperformcfg_cache(id,s_o)}return this.m_skillperform_cache[id]},combatimpl.prototype.get_skillperformcfg=function(id){var ret=this.get_skillperformcfg_cache_frompack(id);return null!=ret&&null!=ret||(ret=this.m_skill_config(id)),null==ret&&(ret=this.m_skill_config(1)),ret},combatimpl.prototype.get_skillperformconfig=function(skillid,skilllv,config_id){var skillconfigkey=1e4*skillid+10*skilllv+config_id;if(null==this.m_skill_configmap[skillconfigkey]){var skillconfig=this.m_skillperform_config(skillid);if(null==skillconfig||null==skillconfig)return core.combat_errlog("get skillperform config error! ",skillid,skilllv),null;for(var cfg=null,_i=0,_a=skillconfig.data;_i<_a.length;_i++){var i=_a[_i];if(i.skilllv==skilllv){cfg=i;break}}null==cfg&&(cfg=skillconfig.data[0]),1==config_id?null!=cfg.config1?this.m_skill_configmap[skillconfigkey]=this.get_skillperformcfg(cfg.config1):null!=cfg.config2?this.m_skill_configmap[skillconfigkey]=this.get_skillperformcfg(cfg.config2):this.m_skill_configmap[skillconfigkey]=this.get_skillperformcfg(1):null!=cfg.config2?this.m_skill_configmap[skillconfigkey]=this.get_skillperformcfg(cfg.config2):null!=cfg.config1?this.m_skill_configmap[skillconfigkey]=this.get_skillperformcfg(cfg.config1):this.m_skill_configmap[skillconfigkey]=this.get_skillperformcfg(1)}return this.m_skill_configmap[skillconfigkey]},combatimpl.prototype.set_skill_config=function(cfg){this.m_skill_config=cfg},combatimpl.prototype.set_skillperform_config=function(cfg){this.m_skillperform_config=cfg},combatimpl.prototype.addplayernode=function(node){this.m_player.addnode(node)},combatimpl.prototype.clearplayernode=function(){for(var _i=0,_a=this.m_player.m_arr;_i<_a.length;_i++){var i=_a[_i];this._del_player_ins(i)}this.m_player.clear()},combatimpl.prototype.startplayernode=function(){this.m_player.start()},combatimpl.prototype.isplayerend=function(){return this.m_player.is_end()},combatimpl.prototype.isturnend=function(){return!(this.m_turn_idx<this.m_turn_list.length)},combatimpl.prototype._get_turn_ins=function(num){return new combat_turn(num)},combatimpl.prototype._del_turn_ins=function(ins){},combatimpl.prototype._get_action_ins=function(type,data){return new combat.combat_action(type,data,this)},combatimpl.prototype._del_action_ins=function(ins){},combatimpl.prototype._get_player_ins=function(tm,event,user_data){return new combat.combat_playernode(tm,event,user_data,this)},combatimpl.prototype._del_player_ins=function(ins){},combatimpl.prototype.get_warrior_ins=function(){return new warrior},combatimpl.prototype.del_warrior_ins=function(warrior_ins){},combatimpl.prototype.get_skillatk_ins=function(){return new skillatk},combatimpl.prototype.del_skillatk_ins=function(skillatk_ins){},combatimpl.prototype.get_atkstatus_ins=function(){return new atk_status},combatimpl.prototype.del_atkstatus_ins=function(ins){},combatimpl.prototype.get_buffstatus_ins=function(){return new buff_status},combatimpl.prototype.del_buffstatus_ins=function(ins){},combatimpl.prototype.get_warriorhp_ins=function(){return new warrior_hp},combatimpl.prototype.del_warriorhp_ins=function(ins){},combatimpl.prototype.start=function(hc,w,h,x,y,scene_id,scene_res){void 0===hc&&(hc=null),void 0===w&&(w=0),void 0===h&&(h=0),void 0===x&&(x=0),void 0===y&&(y=0),void 0===scene_id&&(scene_id=0),void 0===scene_res&&(scene_res=null),core.combat_errlog("combat start");for(var _i=0,_a=this.m_turn_list;_i<_a.length;_i++){for(var i=_a[_i],_b=0,_c=i.m_action_list;_b<_c.length;_b++){var j=_c[_b];this._del_action_ins(j)}this._del_turn_ins(i)}this.m_turn_list=new Array,this.m_turn_idx=0,this.m_cur_turn=null,this.m_b_end=!1,this.m_scene.start();var newturn=this._get_turn_ins(-1);newturn.m_action_list.push(this._get_action_ins(combat.ACTION_ENTER,[hc,w,h,x,y,scene_id,scene_res])),this.m_turn_list.push(newturn)},combatimpl.prototype.end=function(){core.combat_errlog("combat end"),this.m_b_end=!0;for(var _i=0,_a=this.m_turn_list;_i<_a.length;_i++){for(var i=_a[_i],_b=0,_c=i.m_action_list;_b<_c.length;_b++){var j=_c[_b];this._del_action_ins(j)}this._del_turn_ins(i)}this.m_turn_list=new Array,this.m_turn_idx=0,this.m_cur_turn=null,this.m_scene.clear(),this.m_player.clear()},combatimpl.prototype.combatend=function(){var newturn=this._get_turn_ins(-1);newturn.m_action_list.push(this._get_action_ins(combat.ACTION_END,null)),this.m_turn_list.push(newturn)},combatimpl.prototype.addwarrior=function(data){0==this.m_cur_turn.m_num?this.m_cur_turn.m_add_list.push(data):this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_ADDWARRIOR,data))},combatimpl.prototype.change_lineup=function(res,dx,dy){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_CHANGELINEUP,[res,dx,dy]))},combatimpl.prototype.changeweapon=function(wid,aid){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETWARRIORADORN,[wid,1,aid]))},combatimpl.prototype.changewing=function(wid,aid){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETWARRIORADORN,[wid,2,aid]))},combatimpl.prototype.changeride=function(wid,aid,abid,ride_h){void 0===ride_h&&(ride_h=30),this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETWARRIORADORN,[wid,3,[aid,abid,ride_h]]))},combatimpl.prototype.changehair=function(wid,aid){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETWARRIORADORN,[wid,4,aid]))},combatimpl.prototype.changeshape=function(wid,aid){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETWARRIORADORN,[wid,0,aid]))},combatimpl.prototype.changeaurn=function(wid,aid){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETWARRIORADORN,[wid,5,aid]))},combatimpl.prototype.changetitle=function(wid,aid){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETWARRIORADORN,[wid,6,aid]))},combatimpl.prototype.changefairy=function(wid,aid){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETWARRIORADORN,[wid,7,aid]))},combatimpl.prototype.attack=function(data){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SKILL,data))},combatimpl.prototype.send_event=function(event,user_data){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_CUSTOMEVENT,[event,user_data]))},combatimpl.prototype.delwarrior=function(id){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_DELWARRIOR,id))},combatimpl.prototype.addbuff=function(data){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_ADDBUFF,data))},combatimpl.prototype.delbuff=function(data){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_DELBUFF,data))},combatimpl.prototype.buffcd=function(data){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_BUFFCD,data))},combatimpl.prototype.buffautocd=function(){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_BUFFAUTOCD,null))},combatimpl.prototype.propchange=function(data){this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_PROPCHANGE,data))},combatimpl.prototype.set_warrior_hp=function(data){0==this.m_cur_turn.m_num?this.m_cur_turn.m_sethp_list.push(data):this.m_cur_turn.m_action_list.push(this._get_action_ins(combat.ACTION_SETHP,data))},combatimpl.prototype.turnstart=function(count){null!=this.m_cur_turn&&(0<this.m_cur_turn.m_sethp_list.length&&this.m_cur_turn.m_action_list.unshift(this._get_action_ins(combat.ACTION_INITWARRIORHPS,this.m_cur_turn.m_sethp_list.concat([]))),0<this.m_cur_turn.m_add_list.length&&this.m_cur_turn.m_action_list.unshift(this._get_action_ins(combat.ACTION_INITWARRIORS,this.m_cur_turn.m_add_list.concat([]))),this.m_turn_list.push(this.m_cur_turn)),this.m_cur_turn=this._get_turn_ins(count)},combatimpl.prototype.turnend=function(){null!=this.m_cur_turn&&(0<this.m_cur_turn.m_sethp_list.length&&this.m_cur_turn.m_action_list.unshift(this._get_action_ins(combat.ACTION_INITWARRIORHPS,this.m_cur_turn.m_sethp_list.concat([]))),0<this.m_cur_turn.m_add_list.length&&this.m_cur_turn.m_action_list.unshift(this._get_action_ins(combat.ACTION_INITWARRIORS,this.m_cur_turn.m_add_list.concat([]))),this.m_turn_list.push(this.m_cur_turn)),this.m_cur_turn=null},combatimpl.prototype.update=function(delta){if(!this.m_b_end){if(this.m_player.is_end()&&this.m_turn_idx<this.m_turn_list.length){var turn=this.m_turn_list[this.m_turn_idx];turn.is_end()?this.m_turn_idx+=1:turn.do()}this.dispatch_all_delay_event(),this.m_scene.update(delta),this.m_player.update(delta)}},combatimpl.prototype.render=function(){this.m_scene.render()},combatimpl.prototype.dispose=function(){null!=this.m_scene&&(this.m_scene.dispose(),this.m_scene=null),_super.prototype.dispose.call(this)},combatimpl}(utils.game_event_dispatcher);combat.combatimpl=combatimpl}(combat||(combat={}));__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(combat){var combat_warrior_action=function(){function combat_warrior_action(){this.m_id=0,this.m_warrior=null,this.m_is_end=!0,this.m_start_tm=0}return combat_warrior_action.prototype.re_init=function(){this.m_id=0,this.m_warrior=null,this.m_is_end=!0,this.m_start_tm=0},combat_warrior_action.prototype.start=function(tm){this.m_start_tm=tm},combat_warrior_action.prototype.update=function(delta){},combat_warrior_action.prototype.is_end=function(){return this.m_is_end},combat_warrior_action.prototype.clear=function(){},combat_warrior_action.prototype.dispose=function(){this.m_warrior=null},combat_warrior_action}(),dead_action=function(_super){function dead_action(){var _this=_super.call(this)||this;return _this.m_b_open=!0,_this.m_fade_max=6,_this.m_fade_tm=200,_this.m_cur_fadeidx=0,_this.m_cur_tm=0,_this.m_fadeout=!0,_this}return __extends(dead_action,_super),dead_action.prototype.start=function(tm){if(this.m_start_tm=tm,this.m_b_open)return this.m_is_end=!1,this.m_fadeout=!0,this.m_cur_fadeidx=0,this.m_cur_tm=this.m_start_tm,void this.m_warrior.change_action(0);this.m_warrior.change_action(5,!1),this.m_is_end=!0},dead_action.prototype.update=function(delta){if(!this.m_is_end){if(this.m_cur_tm+=delta,this.m_cur_tm>this.m_start_tm+this.m_fade_tm){if(this.m_cur_fadeidx+=1,this.m_cur_fadeidx>=this.m_fade_max)return this.m_is_end=!0,void(this.m_warrior.alpha=1);this.m_start_tm=this.m_cur_tm,this.m_fadeout=!this.m_fadeout}var rate=1;1<(rate=(this.m_cur_tm-this.m_start_tm)/this.m_fade_tm)&&(rate=1),rate<0&&(rate=0),this.m_fadeout&&(rate=1-rate),this.m_warrior.alpha=rate}},dead_action.prototype.is_end=function(){return this.m_is_end},dead_action.prototype.dispose=function(){null!=this.m_warrior&&(this.m_warrior.alpha=1,this.m_warrior=null),utils.recover("dead_action",this)},dead_action}(combat.combat_warrior_action=combat_warrior_action);combat.dead_action=dead_action;var fly_action=function(_super){function fly_action(){var _this=_super.call(this)||this;return _this.m_start_pt=new Laya.Point,_this.m_from_pt=new Laya.Point,_this.m_lt_pt=new Laya.Point,_this.m_rb_pt=new Laya.Point,_this.m_collision_max=2,_this.m_collision_num=0,_this.m_a=0,_this.m_b=0,_this.m_cur_tm=0,_this.m_cur_rtm=0,_this.m_start_rtm=0,_this.m_rspeed=1800,_this.m_speed=1800,_this.m_bsign=1,_this}return __extends(fly_action,_super),fly_action.prototype.start=function(tm){this.m_start_pt.x!=this.m_from_pt.x&&this.m_start_pt.y!=this.m_from_pt.y?(this.m_start_tm=tm,this.m_cur_rtm=this.m_start_tm,this.m_start_rtm=this.m_start_tm,this.m_collision_num=this.m_collision_max,this.m_warrior.change_action(0),this.m_cur_tm=this.m_start_tm,this.m_warrior.rotation=0,this.m_is_end=!1,this._cal_param()):this.m_is_end=!0},fly_action.prototype._cal_param=function(){this.m_a=utils.genafrom2point(this.m_from_pt.x,this.m_from_pt.y,this.m_start_pt.x,this.m_start_pt.y),this.m_b=utils.genbfrom2point(this.m_from_pt.x,this.m_from_pt.y,this.m_a),this.m_bsign=(this.m_start_pt.x-this.m_from_pt.x)/Math.abs(this.m_start_pt.x-this.m_from_pt.x)},fly_action.prototype._rotate=function(delta){this.m_cur_rtm+=delta;var a=(this.m_cur_rtm-this.m_start_rtm)*this.m_rspeed/1e3;a%=360,this.m_warrior.rotation=a},fly_action.prototype._is_out=function(x,y){return x<this.m_lt_pt.x||x>this.m_rb_pt.x||(y<this.m_lt_pt.y||y>this.m_rb_pt.y)},fly_action.prototype._collision=function(){var ty=0;if((ty=this.m_bsign<0?this.m_a*this.m_lt_pt.x+this.m_b:this.m_a*this.m_rb_pt.x+this.m_b)!=this.m_lt_pt.y&&ty!=this.m_rb_pt.y){if(ty<this.m_lt_pt.y){this.m_start_pt.x=(this.m_lt_pt.y-this.m_b)/this.m_a,this.m_start_pt.y=this.m_lt_pt.y;var temp=2*(this.m_from_pt.y-this.m_lt_pt.y);this.m_from_pt.y-=temp}else if(ty>this.m_rb_pt.y){this.m_start_pt.x=(this.m_rb_pt.y-this.m_b)/this.m_a,this.m_start_pt.y=this.m_rb_pt.y;temp=2*(this.m_rb_pt.y-this.m_from_pt.y);this.m_from_pt.y+=temp}else if(this.m_bsign<0){this.m_start_pt.x=this.m_lt_pt.x,this.m_start_pt.y=this.m_a*this.m_start_pt.x+this.m_b;temp=2*(this.m_from_pt.x-this.m_lt_pt.x);this.m_from_pt.x-=temp}else{this.m_start_pt.x=this.m_rb_pt.x,this.m_start_pt.y=this.m_a*this.m_start_pt.x+this.m_b;temp=2*(this.m_rb_pt.x-this.m_from_pt.x);this.m_from_pt.x+=temp}this._cal_param()}else this.m_collision_num=-1},fly_action.prototype.update=function(delta){if(!this.m_is_end){this._rotate(delta),this.m_cur_tm+=delta;var dx=this.m_speed*(this.m_cur_tm-this.m_start_tm)/1e3,cur_x=this.m_start_pt.x+dx*this.m_bsign,cur_y=this.m_a*cur_x+this.m_b;if(this._is_out(cur_x,cur_y)){if(this.m_collision_num-=1,this.m_collision_num<0)return void(this.m_is_end=!0);if(this._collision(),this.m_collision_num<0)return void(this.m_is_end=!0);this.m_start_tm=this.m_cur_tm}this.m_warrior.set_pos(cur_x,cur_y)}},fly_action.prototype.is_end=function(){return this.m_is_end},fly_action.prototype.dispose=function(){null!=this.m_warrior&&(this.m_warrior.alpha=0,this.m_warrior=null),utils.recover("fly_action",this)},fly_action}(combat_warrior_action);combat.fly_action=fly_action;var combatscene=function(_super){function combatscene(mgr,sp){var _this=_super.call(this)||this;return _this.m_combat_mgr=null,_this.m_render=null,_this.m_pos_map=new Object,_this.m_warrior_map=new Object,_this.m_mw=2560,_this.m_mh=2560,_this.m_map="1704.jpg",_this.m_camera_x=0,_this.m_camera_y=0,_this.m_pos_centerx=0,_this.m_pos_centerdx=40,_this.m_pos_centerdy=-60,_this.m_pos_centery=0,_this.m_view_w=0,_this.m_view_h=0,_this.m_pos_dx=92,_this.m_pos_dy=52,_this.m_pos_c2dx=0+_this.m_pos_dx,_this.m_pos_c2dy=120+_this.m_pos_dy,_this.m_numpic_list=new Array,_this.m_tempnumpic_list=new Array,_this.m_cryout_list=new Array,_this.m_tempcryout_list=new Array,_this.m_waction_list=new Array,_this.m_bk_htmlcanvas=null,_this.m_bk_htmltexture=null,_this.m_bk_sp=null,_this.m_lineupsp=null,_this.m_combat_mgr=mgr,_this._init_event(),_this.m_render=new core.renderagent,_this.m_render.initstage(sp),_this.m_render.m_render.setworldwh(_this.m_mw,_this.m_mh),_this.m_view_w=720,_this.m_view_h=1280,_this.m_render.setviewport(_this.m_view_w,_this.m_view_h),sp.width=_this.m_mw,sp.height=_this.m_mh,_this.m_render.setcamerapos(_this.m_camera_x,_this.m_camera_y),_this._init_pos_map(),sp.on(Laya.Event.CLICK,_this,_this.onClick),_this}return __extends(combatscene,_super),combatscene.prototype._init_pos_map=function(){var dx=this.m_pos_dx,dy=this.m_pos_dy,cx=this.m_pos_centerx,cy=this.m_pos_centery;this.m_pos_map[1]=[cx+this.m_pos_c2dx,cy+this.m_pos_c2dy,3],this.m_pos_map[2]=[this.m_pos_map[1][0]-this.m_pos_dx,this.m_pos_map[1][1]+this.m_pos_dy,3],this.m_pos_map[3]=[this.m_pos_map[1][0]+this.m_pos_dx,this.m_pos_map[1][1]-this.m_pos_dy,3],this.m_pos_map[4]=[this.m_pos_map[2][0]-this.m_pos_dx,this.m_pos_map[2][1]+this.m_pos_dy,3],this.m_pos_map[5]=[this.m_pos_map[3][0]+this.m_pos_dx,this.m_pos_map[3][1]-this.m_pos_dy,3];for(var i=6;i<11;++i){var tx=this.m_pos_map[i-5][0]-dx,ty=this.m_pos_map[i-5][1]-dy;this.m_pos_map[i]=[tx,ty,3]}var ddx=2*this.m_pos_c2dx,ddy=2*this.m_pos_c2dy;for(i=21;i<26;++i){tx=this.m_pos_map[i-15][0]-ddx,ty=this.m_pos_map[i-15][1]-ddy;this.m_pos_map[i]=[tx,ty,7]}for(i=26;i<31;++i){tx=this.m_pos_map[i-5][0]+dx,ty=this.m_pos_map[i-5][1]+dy;this.m_pos_map[i]=[tx,ty,7]}this.m_pos_map[11]=[100,100,3],this.m_pos_map[12]=[100,100,3],this.m_pos_map[31]=[100,100,7],this.m_pos_map[32]=[100,100,7]},combatscene.prototype.get_pos=function(id){var x=this.m_pos_map[id][0],y=this.m_pos_map[id][1];return new laya.maths.Point(x,y)},combatscene.prototype.get_dir=function(id){return this.m_pos_map[id][2]},combatscene.prototype.get_warrior=function(id){return null==this.m_warrior_map[id]?null:this.m_warrior_map[id]},combatscene.prototype.get_warrior_avatar=function(id){var wobj=this.get_warrior(id);return null==wobj?null:this.m_render.getunit(wobj.roleid)},combatscene.prototype.get_warrior_avatarid=function(id){var wobj=this.get_warrior(id);return null==wobj?0:wobj.roleid},combatscene.prototype.onClick=function(e){var sx=e.stageX,sy=e.stageY;sx*=.5,sy*=.5;var spos=new laya.maths.Point(sx,sy),wpos=this.m_render.stagepos2worldpos(spos);core.combat_tiplog("combatscene onClick ",e.stageX,e.stageY,wpos.x,wpos.y)},combatscene.prototype._init_event=function(){this.register_event(combat.COMBATSCENE_ENTER,this.on_enter),this.register_event(combat.COMBATSCENE_CHANGELINEUP,this.on_change_lineup),this.register_event(combat.COMBATSCENE_QUIT,this.on_quit),this.register_event(combat.COMBATSCENE_POPNUMBER,this.on_popnumber),this.register_event(combat.COMBATSCENE_CRYOUT,this.on_cryout),this.register_event(combat.COMBATSCENE_ADDWARRIOR,this.on_addwarrior),this.register_event(combat.COMBATSCENE_ADDCLONEWARRIOR,this.on_addclonewarrior),this.register_event(combat.COMBATSCENE_INITWARRIOR,this.on_initwarrior),this.register_event(combat.COMBATSCENE_SETADORN,this.on_setadorn),this.register_event(combat.COMBATSCENE_DELWARRIOR,this.on_delwarrior),this.register_event(combat.COMBATSCENE_DELNINJA,this.on_delninja),this.register_event(combat.COMBATSCENE_ADDBUFF,this.on_addbuff),this.register_event(combat.COMBATSCENE_DELBUFF,this.on_delbuff),this.register_event(combat.COMBATSCENE_BUFFCD,this.on_buffcd),this.register_event(combat.COMBATSCENE_BUFFAUTOCD,this.on_buffautocd),this.register_event(combat.COMBATSCENE_WARRIORACTION,this.on_warrioraction),this.register_event(combat.COMBATSCENE_WARRIORDEAD,this.on_warriordead),this.register_event(combat.COMBATSCENE_WARRIORDEADVANISH,this.on_warriordeadvanish),this.register_event(combat.COMBATSCENE_WARRIORFLY,this.on_warriorfly),this.register_event(combat.COMBATSCENE_WARRIORREVIVE,this.on_warriorrevive),this.register_event(combat.COMBATSCENE_WARRIORDEFEND,this.on_warriordefend),this.register_event(combat.COMBATSCENE_WARRIORDODGE,this.on_warriordodge),this.register_event(combat.COMBATSCENE_WARRIORATTACKED,this.on_warriorattacked),this.register_event(combat.COMBATSCENE_WARRIORBACKMOVE,this.on_warriorbackmove),this.register_event(combat.COMBATSCENE_WARRIORSETPOS,this.on_warriorsetpos),this.register_event(combat.COMBATSCENE_WARRIORMOVE,this.on_warriormove),this.register_event(combat.COMBATSCENE_WARRIORMOVEBACK,this.on_warriormoveback),this.register_event(combat.COMBATSCENE_WARRIORMOVE2WARRIOR,this.on_warriormove2warrior),this.register_event(combat.COMBATSCENE_EFFECT,this.on_effect),this.register_event(combat.COMBATSCENE_EFFECT_SCREENPOS,this.on_effect_screenpos),this.register_event(combat.COMBATSCENE_EFFECT2W,this.on_effect2w),this.register_event(combat.COMBATSCENE_ACTIONBEGIN,this.on_actionbegin),this.register_event(combat.COMBATSCENE_ACTIONEND,this.on_actionend),this.register_event(combat.COMBATSCENE_WARRIORDIR,this.on_warriordir),this.register_event(combat.COMBATSCENE_WARRIORDIR2W,this.on_warriordir2w),this.register_event(combat.COMBATSCENE_WARRIORREADY,this.on_warriorready),this.register_event(combat.COMBATSCENE_SETHP,this.on_sethp),this.register_event(combat.COMBATSCENE_BLACKSCENE,this.on_blackscene),this.register_event(combat.COMBATSCENE_CUSTOMEVENT,this.on_customevent)},combatscene.prototype.on_actionend=function(user_data){},combatscene.prototype.on_actionbegin=function(user_data){},combatscene.prototype.clearallwarrior=function(){for(var _i=0,_a=this.m_waction_list;_i<_a.length;_i++){(i=_a[_i]).dispose()}for(var i in this.m_waction_list.length=0,this.m_warrior_map)if(this.m_warrior_map.hasOwnProperty(i)){var wdata=this.m_warrior_map[i];if(null!=wdata){var wrolea=this.m_render.getunit(wdata.roleid);null!=wrolea&&laya.utils.Tween.clearAll(wrolea),this.m_render.delunit(wdata.roleid)}}this.m_warrior_map=new Object},combatscene.prototype.init_bk_htmlcanvas=function(hc,w,h){this.clear_bk_htmlcanvas(),null!=hc&&(this.m_bk_htmlcanvas=hc,this.m_bk_htmltexture=new Laya.Texture(this.m_bk_htmlcanvas),this.m_bk_sp=new Laya.Sprite,this.m_bk_sp.graphics.fillTexture(this.m_bk_htmltexture,0,0,w,h,"no-repeat"))},combatscene.prototype.clear_bk_htmlcanvas=function(){null!=this.m_bk_sp&&(this.m_bk_sp.graphics.clear(),this.m_bk_sp.destroy(!0),this.m_bk_sp=null),null!=this.m_bk_htmlcanvas&&(this.m_bk_htmlcanvas.clear(),this.m_bk_htmlcanvas.releaseResource(!0),this.m_bk_htmlcanvas.destroy(),this.m_bk_htmltexture.destroy(!0),this.m_bk_htmlcanvas=null,this.m_bk_htmltexture=null)},combatscene.prototype.on_change_lineup=function(user_data){this.clear_lineupsp();var path=user_data[0],dx=user_data[1],dy=user_data[2];core.combat_tiplog("combatscene on_change_lineup ",path,dx,dy);var ret=utils.getitembycls("combat_lineup",combat.combat_lineup);ret.re_init(),ret.set_respath(path,dx,dy),ret.m_obj_id=this.m_render.addsprite(ret,this.m_pos_centerx,this.m_pos_centery,!1),this.m_lineupsp=ret},combatscene.prototype.clear_lineupsp=function(){null!=this.m_lineupsp&&(this.m_render.delsprite(this.m_lineupsp.m_obj_id),this.m_lineupsp.dispose(),this.m_lineupsp=null)},combatscene.prototype.set_viewport=function(w,h){this.m_view_w=w,this.m_view_h=h,this.m_render.setviewport(w,h)},combatscene.prototype.on_enter=function(user_data){var hc=user_data[0],w=user_data[1],h=user_data[2],x=user_data[3],y=user_data[4],sid=user_data[5],s_res=user_data[6];if(this.m_render.clearmapbksp(),this.m_camera_x=this.m_mw>>1,this.m_camera_y=this.m_mh>>1,this.m_pos_centerx=this.m_camera_x+this.m_pos_centerdx,this.m_pos_centery=this.m_camera_y+this.m_pos_centerdy,null!=hc)this.init_bk_htmlcanvas(hc,w,h),this.m_render.setmapbksp(this.m_bk_sp),this.m_bk_sp.x=this.m_camera_x-x,this.m_bk_sp.y=this.m_camera_y-y;else if(0==sid)this.m_render.setmapbk(this.m_map);else{var b_slot=null==s_res;this.m_render.entermap(sid,b_slot),b_slot||this.m_render.setmapbk(s_res),this.m_camera_x=x,this.m_camera_y=y,this.m_pos_centerx=this.m_camera_x+this.m_pos_centerdx,this.m_pos_centery=this.m_camera_y+this.m_pos_centerdy}this._init_pos_map(),core.combat_tiplog("combatscene on_enter setcamerapos ",this.m_mw>>1,this.m_mh>>1),this.m_render.setcamerapos(this.m_camera_x,this.m_camera_y);for(var _i=0,_a=this.m_waction_list;_i<_a.length;_i++){_a[_i].dispose()}this.m_waction_list.length=0,this.m_render.show_map_mask(!0,.5)},combatscene.prototype.on_quit=function(user_data){},combatscene.prototype.on_setadorn=function(user_data){var wid=user_data[0],pos=user_data[1],aid=user_data[2];if(null!=this.get_warrior(wid)){var wavatar=this.get_warrior_avatar(wid);if(null!=wavatar)switch(pos){case 0:wavatar.change_shape(aid);break;case 1:wavatar.change_weapon(aid);break;case 2:wavatar.change_wing(aid);break;case 3:wavatar.change_ride(aid[0],aid[1]),0!=aid[0]?(wavatar.set_ride_h(30),2<aid.length&&wavatar.set_ride_h(aid[2])):wavatar.set_ride_h(30);break;case 4:wavatar.change_hair(aid);break;case 5:wavatar.change_aura(aid);break;case 6:wavatar.change_title(aid);break;case 7:var fid=aid;if(this.m_render.clear_all_follow(wid),0!=fid){var pid=this.get_warrior_avatarid(wid),chase_id=this.m_render.addunit("",fid,0,0);this.m_render.set_follow_id(chase_id,pid),this.m_render.getunit(chase_id).set_dxy(0,-100)}}}},combatscene.prototype.get_posid_bywid=function(wid){var wdata=this.get_warrior(wid);return null!=wdata?wdata.pos:wid},combatscene.prototype.on_initwarrior=function(user_data){var arr=user_data;core.combat_tiplog("combatscene initwarrior ",arr);for(var _i=0,arr_1=arr;_i<arr_1.length;_i++){var i=arr_1[_i];this.on_addwarrior(i)}},combatscene.prototype.on_addclonewarrior=function(user_data){core.combat_tiplog("combatscene on_addclonewarrior ",user_data);var src=user_data.src,dst=user_data.dst,x=user_data.x,y=user_data.y,dir=user_data.dir;if(null!=this.get_warrior(src)){null!=this.get_warrior(dst)&&this.on_delwarrior(dst);var wdata=this.get_warrior(src),new_data=new combat.warrior;wdata.clone_data(new_data),new_data.id=dst,new_data.roleid=this._add_warrior_ins(new_data,x,y),this.m_warrior_map[new_data.id]=new_data;var wrolea=this.m_render.getunit(new_data.roleid);wrolea.change_action(2),wrolea.change_dir(dir)}else core.combat_errlog("on_addclonewarrior have not this warrior ",src,dst)},combatscene.prototype._add_warrior_ins=function(wdata,x,y){core.combat_tiplog("combatscene _add_warrior_ins ",wdata.id,x,y);var wrolea=null;wdata.roleid=this.m_render.addunit(wdata.name,wdata.shape,x,y),(wrolea=this.m_render.getunit(wdata.roleid)).set_scale(wdata.scale,wdata.scale);var v=wdata.m_desc[0];if(0!=v&&wrolea.change_shape(v),0!=(v=wdata.m_desc[1])&&wrolea.change_weapon(v),0!=(v=wdata.m_desc[2])&&wrolea.change_wing(v),0!=(v=wdata.m_desc[3])){var chase_id=this.m_render.addunit("",v,0,0);this.m_render.set_follow_id(chase_id,wdata.roleid),this.m_render.getunit(chase_id).set_dxy(0,-100)}if(0!=(v=wdata.m_desc[4])&&wrolea.change_aura(v),0!=(v=wdata.m_desc[5])&&wrolea.change_title(v),0!=(v=wdata.m_desc[6])){var vb=wdata.m_desc[7],rh=wdata.m_desc[8];0==rh&&(rh=30),wrolea.change_ride(v,vb),wrolea.set_ride_h(rh)}else wrolea.set_ride_h(30);return wdata.roleid},combatscene.prototype.on_addwarrior=function(user_data){var wdata=user_data,wrolea=null;null!=this.get_warrior(wdata.id)&&(null!=(wrolea=this.m_render.getunit(this.get_warrior(wdata.id).roleid))&&laya.utils.Tween.clearAll(wrolea),this.m_render.delunit(this.get_warrior(wdata.id).roleid));var pos=this.get_pos(wdata.pos),dir=this.get_dir(wdata.pos);core.combat_tiplog("combatscene addwarrior ",wdata.id,pos.x,pos.y,dir),wdata.roleid=this._add_warrior_ins(wdata,pos.x,pos.y),this.m_warrior_map[wdata.id]=wdata,this.on_warriorready({src:wdata.id})},combatscene.prototype.on_delninja=function(user_data){var id=user_data;core.combat_tiplog("combatscene on_delninja ",id);for(var _i=0,_a=Object.keys(this.m_warrior_map);_i<_a.length;_i++){var k=_a[_i];if(this.m_warrior_map.hasOwnProperty(k)){var tid=parseInt(k);id<=tid&&this.on_delwarrior(tid)}}},combatscene.prototype.on_delwarrior=function(user_data){var id=user_data;if(core.combat_tiplog("combatscene on_delwarrior ",id),this._del_waction_obj(id),null!=this.get_warrior(id)){var wrolea=this.m_render.getunit(this.get_warrior(id).roleid);null!=wrolea&&laya.utils.Tween.clearAll(wrolea),this.m_render.delunit(this.get_warrior(id).roleid),this.m_warrior_map[id]=null}},combatscene.prototype._add_waction_obj=function(obj){return this._del_waction_obj(obj.m_id),this.m_waction_list.push(obj),!0},combatscene.prototype._del_waction_obj=function(id){for(var idx=0,_i=0,_a=this.m_waction_list;_i<_a.length;_i++){var i=_a[_i];if(i.m_id==id)return i.dispose(),void this.m_waction_list.splice(idx,1);idx+=1}},combatscene.prototype.on_warrioraction=function(user_data){var src=user_data.src,actionid=user_data.actionid,wavatar=this.get_warrior_avatar(src);null!=wavatar&&(this.m_render.unit_stop(wavatar.m_obj_id),wavatar.change_action(actionid,!1,0))},combatscene.prototype.on_addbuff=function(user_data){var src=user_data.src,id=user_data.buffid,shape=user_data.shape,buffeffid=user_data.buffeffid,cd=user_data.cd,overlap=user_data.overlay,datas=user_data.datas,wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var buffui=wavatar.get_buffui(),effid=0;effid=null==buffui.getbuff(id)?wavatar.add_buffeff(buffeffid):buffui.getbuff(id).m_effid,buffui.addbuff(id,shape,cd,overlap,datas,effid)}},combatscene.prototype.on_delbuff=function(user_data){var src=user_data.src,id=user_data.buffid,wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var buffui=wavatar.get_buffui(),b=buffui.getbuff(id);null!=b&&(wavatar.del_buffeff(b.m_effid),buffui.delbuff(id))}},combatscene.prototype.on_buffcd=function(user_data){var src=user_data.src,id=user_data.buffid,cd=user_data.cd,wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var buffins=wavatar.get_buffui().getbuff(id);null!=buffins&&buffins.set_cd(cd)}},combatscene.prototype.on_buffautocd=function(user_data){for(var i in this.m_warrior_map)if(this.m_warrior_map.hasOwnProperty(i)){var wdata=this.m_warrior_map[i];if(null!=wdata){var wavatar=this.m_render.getunit(wdata.roleid);if(null!=wavatar)wavatar.get_buffui().buffautocd()}}},combatscene.prototype.on_cryout=function(user_data){var src=user_data.src,v=user_data.content,wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var cn=this._get_combatcryout(v);cn.start();var x=wavatar.x,y=wavatar.y;cn.m_obj_id=this.m_render.addsprite(cn,x,y),this.m_cryout_list.push(cn)}},combatscene.prototype.clearallcryout=function(){for(var _i=0,_a=this.m_cryout_list;_i<_a.length;_i++){var i=_a[_i];i.dispose(),this.m_render.delsprite(i.m_obj_id)}this.m_cryout_list.length=0},combatscene.prototype.on_popnumber=function(user_data){var src=user_data.src,tp=user_data.type,v=user_data.damage;user_data.crack&&(tp=combat.DAMAGETYPE_CRACK);var wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var cn;(cn=tp==combat.DAMAGETYPE_CRACK?this._get_combatcrack(v,tp):this._get_combatnum(v,tp)).start();var x=wavatar.x,y=wavatar.y;cn.m_obj_id=this.m_render.addsprite(cn,x,y),this.m_numpic_list.push(cn)}},combatscene.prototype.on_warriorfly=function(user_data){var src=user_data.src;if(null!=this.get_warrior(src)){var wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var fly_a=utils.getitembycls("fly_action",fly_action);fly_a.re_init(),fly_a.m_id=src,fly_a.m_warrior=wavatar;fly_a.m_lt_pt.x=this.m_camera_x-this.m_view_w/2-0,fly_a.m_lt_pt.y=this.m_camera_y-this.m_view_h/2-0,fly_a.m_rb_pt.x=this.m_camera_x+this.m_view_w/2+0,fly_a.m_rb_pt.y=this.m_camera_y+this.m_view_h/2+0,fly_a.m_start_pt.x=wavatar.x,fly_a.m_start_pt.y=wavatar.y,this.is_downteam(this.get_posid_bywid(src))?(fly_a.m_from_pt.x=wavatar.x-this.m_pos_dx,fly_a.m_from_pt.y=wavatar.y-this.m_pos_dy):(fly_a.m_from_pt.x=wavatar.x+this.m_pos_dx,fly_a.m_from_pt.y=wavatar.y+this.m_pos_dy),fly_a.start(utils.get_render_milltm()),this._add_waction_obj(fly_a)}else core.combat_errlog("combatscene on_warriorfly error!have not this role ",src)}},combatscene.prototype.on_warriordeadvanish=function(user_data){var src=user_data.src,wobj=this.get_warrior(src);if(null!=wobj){wobj.b_dead=!0;var wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var d_a=utils.getitembycls("dead_action",dead_action);d_a.re_init(),d_a.m_id=src,d_a.m_warrior=wavatar,d_a.start(utils.get_render_milltm()),this._add_waction_obj(d_a)}else core.combat_errlog("combatscene on_warriordeadvanish error!have not this guy!",src)}},combatscene.prototype.on_warriordead=function(user_data){var src=user_data.src,wobj=this.get_warrior(src);if(null!=wobj){wobj.b_dead=!0;var wavatar=this.get_warrior_avatar(src);null!=wavatar?wavatar.change_action(5,!1):core.combat_errlog("combatscene on_warriordead error!have not this guy!",src)}},combatscene.prototype.on_warriorrevive=function(user_data){var src=user_data.src,wobj=this.get_warrior(src);null!=wobj&&(wobj.b_dead=!0,this.on_warriorready({src:src}))},combatscene.prototype.on_warriordodge=function(user_data){var src=user_data.src,wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var x=wavatar.x,y=wavatar.y;this.is_downteam(this.get_posid_bywid(src))?(x+=this.m_pos_dx,y+=this.m_pos_dy):(x-=this.m_pos_dx,y-=this.m_pos_dy),laya.utils.Tween.to(wavatar,{set_x:x,set_y:y},500,laya.utils.Ease.strongOut);var cn=this._get_combatnum(0,combat.DAMAGETYPE_DODGE);cn.start();var x1=wavatar.x-(cn.m_w>>1),y1=wavatar.y-100;cn.m_obj_id=this.m_render.addsprite(cn,x1,y1),this.m_numpic_list.push(cn)}},combatscene.prototype.clearallnumpic=function(){for(var _i=0,_a=this.m_numpic_list;_i<_a.length;_i++){var i=_a[_i];i.dispose(),this.m_render.delsprite(i.m_obj_id)}this.m_numpic_list.length=0},combatscene.prototype.on_warriorsetpos=function(user_data){var src=user_data.src,x=user_data.x,y=user_data.y,wavatar=this.get_warrior_avatar(src);null!=wavatar?wavatar.set_pos(x,y):core.combat_errlog("combatscene on_warriorsetpos error!have not this guy!",src)},combatscene.prototype.on_warriorbackmove=function(user_data){var src=user_data.src,dst=user_data.dst,wavatar=this.get_warrior_avatar(src);if(null!=wavatar){var x=wavatar.x,y=wavatar.y;this.is_downteam(this.get_posid_bywid(src))?(x+=this.m_pos_dx*dst,y+=this.m_pos_dy*dst):(x-=this.m_pos_dx*dst,y-=this.m_pos_dy*dst),laya.utils.Tween.to(wavatar,{set_x:x,set_y:y},500,laya.utils.Ease.elasticOut)}else core.combat_errlog("combatscene on_warriorbackmove error!have not this guy!",src)},combatscene.prototype.on_warriorattacked=function(user_data){var src=user_data.src,stopf=user_data.stopf,bcycle=!0;null!=stopf&&null!=stopf&&(bcycle=!1);var wavatar=this.get_warrior_avatar(src);null!=wavatar?wavatar.change_action(4,bcycle,stopf):core.combat_errlog("combatscene on_warriorattacked error!have not this guy!",src)},combatscene.prototype.on_warriordefend=function(user_data){var src=user_data.src,wavatar=this.get_warrior_avatar(src);null!=wavatar&&wavatar.change_action(6)},combatscene.prototype.on_warriorready=function(user_data){var src=user_data.src;core.combat_tiplog("combatscene warrior ready ",src);var wavatar=this.get_warrior_avatar(src);if(null!=wavatar){laya.utils.Tween.clearAll(wavatar),wavatar.change_action(2);var pos=this.get_pos(this.get_posid_bywid(src)),dir=this.get_dir(this.get_posid_bywid(src));wavatar.change_dir(dir),wavatar.set_pos(pos.x,pos.y)}},combatscene.prototype.on_sethp=function(user_data){var hpins=user_data;core.combat_tiplog("combatscene on_sethp ",hpins.id,hpins.hp,hpins.hpmax);var wavatar=this.get_warrior_avatar(hpins.id);null!=wavatar&&wavatar.set_hp(hpins.hp,hpins.hpmax)},combatscene.prototype.on_warriormove=function(user_data){var src=user_data.src,x=user_data.x,y=user_data.y;this.m_render.unit_walk2(this.get_warrior_avatarid(src),x,y,!0,!0);var fdir=-1;if(null!=user_data.forcedir){fdir=user_data.forcedir;var p=this.m_render.get_unit_walk(this.get_warrior_avatarid(src));null!=p&&(p.m_force_dir=fdir)}},combatscene.prototype.on_warriormoveback=function(user_data){var src=user_data.src,pos=this.get_pos(this.get_posid_bywid(src));this.m_render.unit_walk2(this.get_warrior_avatarid(src),pos.x,pos.y,!0,!0);var fdir=-1;if(null!=user_data.forcedir){fdir=user_data.forcedir;var p=this.m_render.get_unit_walk(this.get_warrior_avatarid(src));null!=p&&(p.m_force_dir=fdir)}},combatscene.prototype.on_warriormove2warrior=function(user_data){var src=user_data.src,dst=user_data.dst,pos=this.get_pos(this.get_posid_bywid(dst));this.is_downteam(this.get_posid_bywid(src))?(pos.x+=this.m_pos_dx,pos.y+=this.m_pos_dy):(pos.x-=this.m_pos_dx,pos.y-=this.m_pos_dy),this.m_render.unit_walk2(this.get_warrior_avatarid(src),pos.x,pos.y,!0,!0);var fdir=-1;if(null!=user_data.forcedir){fdir=user_data.forcedir;var p=this.m_render.get_unit_walk(this.get_warrior_avatarid(src));null!=p&&(p.m_force_dir=fdir)}},combatscene.prototype.on_warriordir2w=function(user_data){var src=user_data.src,dst=user_data.dst,srcavatar=this.m_render.getunit(this.get_warrior_avatarid(src)),dstavatar=this.m_render.getunit(this.get_warrior_avatarid(dst));if(null!=srcavatar&&null!=dstavatar){var dir=utils.gendir(dstavatar.x-srcavatar.x,dstavatar.y-srcavatar.y);srcavatar.change_dir(dir)}},combatscene.prototype.on_warriordir=function(user_data){var src=user_data.src,dir=user_data.dir,wavatar=this.m_render.getunit(this.get_warrior_avatarid(src));null!=wavatar&&wavatar.change_dir(dir)},combatscene.prototype.on_effect_screenpos=function(user_data){var effectid=user_data.effectid,x=user_data.x,y=user_data.y,pos=this.m_render.stagepos2worldpos(new Laya.Point(x,y));this.m_render.addeff(effectid,pos.x,pos.y,!1,!0)},combatscene.prototype.on_effect=function(user_data){var effectid=user_data.effectid,x=user_data.x,y=user_data.y;this.m_render.addeff(effectid,x,y,!1,!0)},combatscene.prototype.on_effect2w=function(user_data){var effectid=user_data.effectid,srcid=user_data.src,wavatar=this.get_warrior_avatar(srcid);if(null!=wavatar){var x=wavatar.x,y=wavatar.y;this.m_render.addeff(effectid,x,y,!1,!0)}},combatscene.prototype.on_customevent=function(user_data){core.combat_tiplog("combatscene customevent ",user_data),utils.event_ins().fire_event_next_frame(user_data[0],user_data[1])},combatscene.prototype.on_blackscene=function(user_data){var tm=user_data.tm;this.m_render.blackscene(tm)},combatscene.prototype.is_downteambywid=function(wid,self_group){var pos=wid;return 0!=self_group&&(pos<=12?pos+=20:pos-=20),this.is_downteam(pos)},combatscene.prototype.is_downteam=function(id){return id<=12},combatscene.prototype.mgr=function(){return this.m_combat_mgr},combatscene.prototype.register_event=function(event,func){this.mgr().register_event(event,this),this.register_event_func(event,func)},combatscene.prototype.unregister_event=function(event){this.mgr().unregister_event(event,this),this.unregister_event_func(event)},combatscene.prototype.fire_event=function(event,user_data){void 0===user_data&&(user_data=null),this.mgr().fire_event(event,user_data)},combatscene.prototype.unregister_allevent=function(){this.mgr().unregister_allevent(this),this.unregister_all_event_func()},combatscene.prototype.fire_event_next_frame=function(event,user_data){void 0===user_data&&(user_data=null),this.mgr().fire_event_next_frame(event,user_data)},combatscene.prototype.start=function(){},combatscene.prototype._get_combatnum=function(v,tp,content){void 0===content&&(content="");var ret=utils.getitembycls("combat_number",combat.combat_number);return ret.re_init(v,tp,content),ret},combatscene.prototype._get_combatcrack=function(v,tp,content){void 0===content&&(content="");var ret=utils.getitembycls("combat_crack",combat.combat_crack);return ret.re_init(v,tp,content),ret},combatscene.prototype._get_combatcryout=function(content){void 0===content&&(content="");var ret=utils.getitembycls("combat_cryout",combat.combat_cryout);return ret.re_init(content),ret},combatscene.prototype.clear=function(){this.clear_bk_htmlcanvas(),this.clearallwarrior();for(var _i=0,_a=this.m_waction_list;_i<_a.length;_i++){_a[_i].dispose()}this.m_waction_list.length=0,this.clear_lineupsp(),this.clearallnumpic(),this.clearallcryout(),this.m_render.clearmapbksp(),this.m_render.clear()},combatscene.prototype.update=function(delta){for(var _i=this.m_tempnumpic_list.length=0,_a=this.m_numpic_list;_i<_a.length;_i++){(i=_a[_i]).is_end()?(i.dispose(),this.m_render.delsprite(i.m_obj_id)):(i.tick(delta),this.m_tempnumpic_list.push(i))}var temp=this.m_numpic_list;this.m_numpic_list=this.m_tempnumpic_list,this.m_tempnumpic_list=temp;for(var _b=this.m_tempcryout_list.length=0,_c=this.m_cryout_list;_b<_c.length;_b++){(i=_c[_b]).is_end()?(i.dispose(),this.m_render.delsprite(i.m_obj_id)):(i.tick(delta),this.m_tempcryout_list.push(i))}var temp1=this.m_cryout_list;this.m_cryout_list=this.m_tempcryout_list,this.m_tempcryout_list=temp1;for(var i=this.m_waction_list.length-1;0<=i;--i){var wa=this.m_waction_list[i];wa.update(delta),wa.is_end()&&(wa.dispose(),this.m_waction_list.splice(i,1))}this.m_render.update(delta)},combatscene.prototype.render=function(){this.m_render.render()},combatscene.prototype.dispose=function(){this.clear(),null!=this.m_render&&(this.m_render.dispose(),this.m_render=null),this.m_combat_mgr=null,_super.prototype.dispose.call(this),this.unregister_allevent()},combatscene}(utils.game_event_receiver);combat.combatscene=combatscene}(combat||(combat={})),function(combat){var combat_action=function(){function combat_action(tp,data,mgr){this.m_type=0,this.m_mgr=null,this.m_type=tp,this.m_data=data,this.m_mgr=mgr}return combat_action.prototype.do=function(){switch(this.m_mgr.clearplayernode(),this.m_type){case combat.ACTION_ADDWARRIOR:this.do_addwarrior();break;case combat.ACTION_INITWARRIORS:this.do_initwarrior();break;case combat.ACTION_INITWARRIORHPS:this.do_initwarriorhps();break;case combat.ACTION_SETWARRIORADORN:this.do_setadorn();break;case combat.ACTION_CUSTOMEVENT:this.do_customevent();break;case combat.ACTION_ENTER:this.do_enter();break;case combat.ACTION_CHANGELINEUP:this.do_changelineup();break;case combat.ACTION_SKILL:this.do_skill();break;case combat.ACTION_DELWARRIOR:this.do_delwarrior();break;case combat.ACTION_SETHP:this.do_sethp();break;case combat.ACTION_ADDBUFF:this.do_addbuff();break;case combat.ACTION_DELBUFF:this.do_delbuff();break;case combat.ACTION_BUFFCD:this.do_buffcd();break;case combat.ACTION_BUFFAUTOCD:this.do_buffautocd();break;case combat.ACTION_PROPCHANGE:this.do_propchange()}this.m_mgr.startplayernode()},combat_action.prototype._get_skill_unitid=function(param){return"dst"==param?this.m_data.dst_list[0]:this.m_data.id},combat_action.prototype._pop_skill_dst=function(){this.m_data.dst_list.pop()},combat_action.prototype._parse_skill_move=function(tm,data,self_group){var src_id=this._get_skill_unitid(data.param1),ud={src:src_id,dst:this._get_skill_unitid(data.param2),forcedir:null!=data.param3?parseInt(data.param3):this._is_downteam(src_id,self_group)?3:7};this._add_node(tm,combat.COMBATSCENE_WARRIORMOVE2WARRIOR,ud)},combat_action.prototype._parse_skill_move2=function(tm,data,self_group){var src_id=this._get_skill_unitid(data.param1),ud={src:src_id,x:parseInt(data.param2),y:parseInt(data.param3),forcedir:null!=data.param4?parseInt(data.param4):this._is_downteam(src_id,self_group)?3:7};this._add_node(tm,combat.COMBATSCENE_WARRIORMOVE,ud)},combat_action.prototype._is_downteam=function(id,self_group){return this.m_mgr.m_scene.is_downteambywid(id,self_group)},combat_action.prototype._parse_skill_blacks=function(tm,data){var ud={tm:parseInt(data.param1)};this._add_node(tm,combat.COMBATSCENE_BLACKSCENE,ud)},combat_action.prototype._parse_skill_dir=function(tm,data,self_group){var src_id=this._get_skill_unitid(data.param1),param=data.param2;if("self"==param)if(this._is_downteam(src_id,self_group)){var ud={src:src_id,dir:7};this._add_node(tm,combat.COMBATSCENE_WARRIORDIR,ud)}else{ud={src:src_id,dir:3};this._add_node(tm,combat.COMBATSCENE_WARRIORDIR,ud)}else if("enemy"==param)if(this._is_downteam(src_id,self_group)){ud={src:src_id,dir:3};this._add_node(tm,combat.COMBATSCENE_WARRIORDIR,ud)}else{ud={src:src_id,dir:7};this._add_node(tm,combat.COMBATSCENE_WARRIORDIR,ud)}else if("dst"==param){ud={src:src_id,dst:this.m_data.dst_list[0]};this._add_node(tm,combat.COMBATSCENE_WARRIORDIR2W,ud)}else if("src"==param){ud={src:src_id,dst:this.m_data.id};this._add_node(tm,combat.COMBATSCENE_WARRIORDIR2W,ud)}},combat_action.prototype._parse_skill_act=function(tm,data){var ud={src:this._get_skill_unitid(data.param1),actionid:parseInt(data.param2)};this._add_node(tm,combat.COMBATSCENE_WARRIORACTION,ud)},combat_action.prototype._get_skill_atkstatus=function(data,id){for(var _i=0,_a=data.atkstatus_list;_i<_a.length;_i++){var i=_a[_i];if(i.id==id)return i}return null},combat_action.prototype._parse_ninjaatk=function(tm,data,self_group){var src=this.m_data.id,dir=3,dx=0,dy=0;this._is_downteam(src,self_group)?(dir=3,dx=this.m_mgr.m_scene.m_pos_dx,dy=this.m_mgr.m_scene.m_pos_dy):(dir=7,dx=-this.m_mgr.m_scene.m_pos_dx,dy=-this.m_mgr.m_scene.m_pos_dy);var src_pt=this.m_mgr.m_scene.get_pos(src),srcud={src:src,x:-1e3,y:-1e3};this._add_node(tm,combat.COMBATSCENE_WARRIORSETPOS,srcud);for(var _i=0,_a=this.m_data.dst_list;_i<_a.length;_i++){var i=_a[_i],atk_id=i,clone_id=1e4+i,dst_pos=this.m_mgr.m_scene.get_pos(atk_id);dst_pos.x+3*dx,dst_pos.y+3*dy;var ud={src:src,dst:clone_id,x:src_pt.x,y:src_pt.y,dir:dir};this._add_node(tm,combat.COMBATSCENE_ADDCLONEWARRIOR,ud);var mud={src:clone_id,x:dst_pos.x+dx,y:dst_pos.y+dy,forcedir:dir};this._add_node(tm+10,combat.COMBATSCENE_WARRIORMOVE,mud);var dud={src:clone_id,dir:dir};this._add_node(tm+310,combat.COMBATSCENE_WARRIORDIR,dud);var aud={src:clone_id,actionid:3};this._add_node(tm+400,combat.COMBATSCENE_WARRIORACTION,aud)}},combat_action.prototype._parse_clearninja=function(tm,data){var mud={src:this.m_data.id};this._add_node(tm,combat.COMBATSCENE_WARRIORREADY,mud),this._add_node(tm,combat.COMBATSCENE_DELNINJA,1e4)},combat_action.prototype._parse_skill_attacked=function(tm,data){var dst_list=new Array;if("dst"==data.param1)dst_list.push(this.m_data.dst_list[0]);else for(var _i=0,_a=this.m_data.dst_list;_i<_a.length;_i++){var i=_a[_i];dst_list.push(i)}for(var skillatkdata=this.m_data,_b=0,dst_list_1=dst_list;_b<dst_list_1.length;_b++){i=dst_list_1[_b];var atkstatus=this._get_skill_atkstatus(skillatkdata,i);null!=atkstatus&&this._gen_propchange(i,tm,atkstatus)}for(var _c=0,_d=skillatkdata.subbuff_list;_c<_d.length;_c++){var ud={src:(buffobj=i=_d[_c]).id,buffid:buffobj.buffid,shape:buffobj.buffshape};this._add_node(tm,combat.COMBATSCENE_DELBUFF,ud)}for(var _e=0,_f=skillatkdata.addbuff_list;_e<_f.length;_e++){var buffobj;ud={src:(buffobj=i=_f[_e]).id,buffid:buffobj.buffid,shape:buffobj.buffshape,cd:buffobj.cd,overlay:buffobj.overlay,datas:buffobj.datas,buffeffid:buffobj.buffeffid};this._add_node(tm,combat.COMBATSCENE_ADDBUFF,ud)}},combat_action.prototype._parse_skill_effect=function(tm,data,self_group){var effectid=parseInt(data.param1),pos=data.param2;if("src"==pos){var ud={src:this.m_data.id,effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT2W,ud)}else if("dst"==pos){ud={src:this.m_data.dst_list[0],effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT2W,ud)}else if("all"==pos)for(var _i=0,_a=this.m_data.dst_list;_i<_a.length;_i++){ud={src:_a[_i],effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT2W,ud)}else if("center"==pos){var src_pos=this.m_mgr.m_scene.get_pos(1),dst_pos=this.m_mgr.m_scene.get_pos(21);ud={x:src_pos.x+(dst_pos.x-src_pos.x)/2,y:src_pos.y+(dst_pos.y-src_pos.y)/2,effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT,ud)}else if("self"==pos)if(this._is_downteam(this.m_data.id,self_group)){ud={x:(src_pos=this.m_mgr.m_scene.get_pos(1)).x,y:src_pos.y,effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT,ud)}else{ud={x:(src_pos=this.m_mgr.m_scene.get_pos(21)).x,y:src_pos.y,effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT,ud)}else if("enemy"==pos)if(this._is_downteam(this.m_data.id,self_group)){ud={x:(src_pos=this.m_mgr.m_scene.get_pos(21)).x,y:src_pos.y,effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT,ud)}else{ud={x:(src_pos=this.m_mgr.m_scene.get_pos(1)).x,y:src_pos.y,effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT,ud)}else{ud={x:parseInt(data.param2),y:parseInt(data.param3),effectid:effectid};this._add_node(tm,combat.COMBATSCENE_EFFECT_SCREENPOS,ud)}},combat_action.prototype._parse_skill_moveback=function(tm,data,self_group){var src_id=this._get_skill_unitid(data.param1),fdir=-1,ud={src:src_id,forcedir:fdir=this._is_downteam(src_id,self_group)?3:7};this._add_node(tm,combat.COMBATSCENE_WARRIORMOVEBACK,ud);var dud={src:src_id,dir:fdir};this._add_node(tm+100,combat.COMBATSCENE_WARRIORDIR,dud)},combat_action.prototype._add_node=function(tm,node_type,user_data){var node=this.m_mgr._get_player_ins(tm,node_type,user_data);this.m_mgr.addplayernode(node)},combat_action.prototype._parse_skill_end=function(tm,data){this._add_node(tm,combat.COMBATSCENE_EMPTY,this.m_data)},combat_action.prototype._parse_skill_action=function(tm,action,data,self_group){switch(action){case"move":this._parse_skill_move(tm,data,self_group);break;case"ninjaatk":this._parse_ninjaatk(tm,data,self_group);break;case"clearninja":this._parse_clearninja(tm,data);break;case"move2":this._parse_skill_move2(tm,data,self_group);break;case"dir":this._parse_skill_dir(tm,data,self_group);break;case"action":this._parse_skill_act(tm,data);break;case"attacked":this._parse_skill_attacked(tm,data);break;case"effect":this._parse_skill_effect(tm,data,self_group);break;case"black":this._parse_skill_blacks(tm,data);break;case"moveback":this._parse_skill_moveback(tm,data,self_group);break;case"nextdst":this._pop_skill_dst();break;case"end":this._parse_skill_end(tm,data)}},combat_action.prototype._gen_propchange=function(i,tm,atkstatus){if(0==atkstatus.b_dodge){var ud={src:i,type:atkstatus.damagetype,damage:atkstatus.damage,crack:atkstatus.b_crack};if(this._add_node(tm,combat.COMBATSCENE_POPNUMBER,ud),atkstatus.b_dead||atkstatus.b_fly){var hpins=new combat.warrior_hp;hpins.hp=0,hpins.hpmax=1e3,hpins.id=i,this._add_node(tm,combat.COMBATSCENE_SETHP,hpins)}}if(atkstatus.b_dead){ud={src:i,stopf:1};this._add_node(tm,combat.COMBATSCENE_WARRIORATTACKED,ud),ud={src:i,dst:1},this._add_node(tm,combat.COMBATSCENE_WARRIORBACKMOVE,ud),ud.effectid=106,this._add_node(tm,combat.COMBATSCENE_EFFECT2W,ud),atkstatus.b_vanish?this._add_node(tm+combat_action.DEAD_ATTACKED_TM,combat.COMBATSCENE_WARRIORDEADVANISH,ud):this._add_node(tm+combat_action.DEAD_ATTACKED_TM,combat.COMBATSCENE_WARRIORDEAD,ud),this._add_node(tm+combat_action.DEAD_TM,combat.COMBATSCENE_EMPTY,null)}else if(atkstatus.b_fly){ud=null;ud={src:i,dst:1},this._add_node(tm,combat.COMBATSCENE_WARRIORBACKMOVE,ud),ud={src:i,stopf:1},this._add_node(tm,combat.COMBATSCENE_WARRIORATTACKED,ud),ud.effectid=106,this._add_node(tm,combat.COMBATSCENE_EFFECT2W,ud),this._add_node(tm+combat_action.FLY_ATTACKED_TM,combat.COMBATSCENE_WARRIORFLY,ud),this._add_node(tm+combat_action.FLY_TM,combat.COMBATSCENE_EMPTY,null)}else if(atkstatus.b_dodge){ud={src:i};this._add_node(tm,combat.COMBATSCENE_WARRIORDODGE,ud),this._add_node(tm+combat_action.DODGE_TM,combat.COMBATSCENE_WARRIORREADY,ud)}else if(atkstatus.b_defend){ud={src:i,stopf:0};this._add_node(tm,combat.COMBATSCENE_WARRIORDEFEND,ud),ud.effectid=102,this._add_node(tm,combat.COMBATSCENE_EFFECT2W,ud),ud={src:i,dst:1},this._add_node(tm,combat.COMBATSCENE_WARRIORBACKMOVE,ud),this._add_node(tm+combat_action.DEFEND_TM,combat.COMBATSCENE_WARRIORREADY,ud)}else if(atkstatus.b_revive){ud={src:i};this._add_node(tm,combat.COMBATSCENE_WARRIORREVIVE,ud),this._add_node(tm+combat_action.REVIVE_TM,combat.COMBATSCENE_EMPTY,null)}else if(atkstatus.damagetype!=combat.DAMAGETYPE_HP_ADD){ud={src:i,stopf:1};this._add_node(tm,combat.COMBATSCENE_WARRIORATTACKED,ud),ud.effectid=101,this._add_node(tm,combat.COMBATSCENE_EFFECT2W,ud),this._add_node(tm+combat_action.ATTACKED_TM,combat.COMBATSCENE_WARRIORREADY,ud)}},combat_action.prototype.do_propchange=function(){var atkstatus=this.m_data;this._gen_propchange(atkstatus.id,0,atkstatus)},combat_action.prototype.do_skill=function(){var skilldata=this.m_data,delta=200;if(2==skilldata.m_type){var ud={src:skilldata.id,content:"反震"};this._add_node(0,combat.COMBATSCENE_CRYOUT,ud)}else if(3==skilldata.m_type){ud={src:skilldata.id,content:"反击"};this._add_node(0,combat.COMBATSCENE_CRYOUT,ud)}else if(0==skilldata.m_type){ud={src:skilldata.id,content:"普通攻击"};delta=0}else if(1==skilldata.m_type){var cstring=this.m_mgr.get_skillperformcryout(skilldata.skillid);if(null==cstring||null==cstring||cstring.length<=0)delta=0;else{ud={src:skilldata.id,content:cstring};this._add_node(0,combat.COMBATSCENE_CRYOUT,ud)}}else delta=0;var skillcfgobj=this.m_mgr.get_skillperformconfig(skilldata.skillid,skilldata.skilllv,skilldata.m_config_id);null==skillcfgobj&&(skillcfgobj=this.m_mgr.get_skillperformconfig(10001,1,skilldata.m_config_id));var skillcfg=skillcfgobj.data;core.combat_errlog("combat_action do_skill ",skilldata.skillid,skilldata.skilllv,skillcfg);for(var _i=0,skillcfg_1=skillcfg;_i<skillcfg_1.length;_i++){var i=skillcfg_1[_i];core.combat_errlog("do_skill ",i);var tm=i.tm,action=i.action;this._parse_skill_action(tm+delta,action,i,skilldata.self_group)}},combat_action.prototype.do_enter=function(){this._add_node(0,combat.COMBATSCENE_ENTER,this.m_data)},combat_action.prototype.do_changelineup=function(){this._add_node(0,combat.COMBATSCENE_CHANGELINEUP,this.m_data)},combat_action.prototype.do_customevent=function(){this._add_node(0,combat.COMBATSCENE_CUSTOMEVENT,this.m_data)},combat_action.prototype.do_addwarrior=function(){this._add_node(0,combat.COMBATSCENE_ADDWARRIOR,this.m_data)},combat_action.prototype.do_initwarrior=function(){this._add_node(0,combat.COMBATSCENE_INITWARRIOR,this.m_data)},combat_action.prototype.do_setadorn=function(){this._add_node(0,combat.COMBATSCENE_SETADORN,this.m_data)},combat_action.prototype.do_delwarrior=function(){this._add_node(0,combat.COMBATSCENE_DELWARRIOR,this.m_data)},combat_action.prototype.do_sethp=function(){this._add_node(0,combat.COMBATSCENE_SETHP,this.m_data)},combat_action.prototype.do_initwarriorhps=function(){for(var _i=0,_a=this.m_data;_i<_a.length;_i++){var i=_a[_i];this._add_node(0,combat.COMBATSCENE_SETHP,i)}},combat_action.prototype.do_addbuff=function(){var buffobj=this.m_data,ud={src:buffobj.id,buffid:buffobj.buffid,shape:buffobj.buffshape,cd:buffobj.cd,overlay:buffobj.overlay,datas:buffobj.datas,buffeffid:buffobj.buffeffid};this._add_node(0,combat.COMBATSCENE_ADDBUFF,ud)},combat_action.prototype.do_delbuff=function(){var buffobj=this.m_data,ud={src:buffobj.id,buffid:buffobj.buffid,shape:buffobj.buffshape};this._add_node(0,combat.COMBATSCENE_DELBUFF,ud)},combat_action.prototype.do_buffcd=function(){var buffobj=this.m_data,ud={src:buffobj.id,buffid:buffobj.buffid,cd:buffobj.cd};this._add_node(0,combat.COMBATSCENE_BUFFCD,ud)},combat_action.prototype.do_buffautocd=function(){this.m_data;this._add_node(0,combat.COMBATSCENE_BUFFAUTOCD,null)},combat_action.ATTACKED_TM=450,combat_action.DEAD_ATTACKED_TM=500,combat_action.DEAD_TM=400,combat_action.FLY_ATTACKED_TM=500,combat_action.FLY_TM=400,combat_action.DODGE_TM=300,combat_action.DEFEND_TM=200,combat_action.REVIVE_TM=400,combat_action}();combat.combat_action=combat_action}(combat||(combat={})),function(combat){combat.COMBATSCENE_ENTER="combatscene_enter",combat.COMBATSCENE_CHANGELINEUP="combatscene_changelineup",combat.COMBATSCENE_QUIT="combatscene_quit",combat.COMBATSCENE_POPNUMBER="combatscene_popnumber",combat.COMBATSCENE_ADDWARRIOR="combatscene_addwarrior",combat.COMBATSCENE_ADDCLONEWARRIOR="combatscene_addclonewarrior",combat.COMBATSCENE_INITWARRIOR="combatscene_initwarrior",combat.COMBATSCENE_SETADORN="combatscene_setadorn",combat.COMBATSCENE_DELWARRIOR="combatscene_delwarrior",combat.COMBATSCENE_DELNINJA="combatscene_delninja",combat.COMBATSCENE_ADDBUFF="combatscene_addbuff",combat.COMBATSCENE_DELBUFF="combatscene_delbuff",combat.COMBATSCENE_BUFFCD="combatscene_buffcd",combat.COMBATSCENE_BUFFAUTOCD="combatscene_buffautocd",combat.COMBATSCENE_WARRIORACTION="combatscene_warrioraction",combat.COMBATSCENE_WARRIORDEAD="combatscene_warriordead",combat.COMBATSCENE_WARRIORDEADVANISH="combatscene_warriordeadvanish",combat.COMBATSCENE_WARRIORFLY="combatscene_warriorfly",combat.COMBATSCENE_WARRIORREVIVE="combatscene_warriorrevive",combat.COMBATSCENE_WARRIORDODGE="combatscene_warriordodge",combat.COMBATSCENE_WARRIORDEFEND="combatscene_warriordefend",combat.COMBATSCENE_WARRIORATTACKED="combatscene_warriorattacked",combat.COMBATSCENE_WARRIORBACKMOVE="combatscene_warriorbackmove",combat.COMBATSCENE_WARRIORMOVE="combatscene_warriormove",combat.COMBATSCENE_WARRIORSETPOS="combatscene_warriorsetpos",combat.COMBATSCENE_WARRIORMOVEBACK="combatscene_warriormoveback",combat.COMBATSCENE_WARRIORMOVE2WARRIOR="combatscene_warriormove2warrior",combat.COMBATSCENE_WARRIORDIR="combatscene_warriordir",combat.COMBATSCENE_WARRIORDIR2W="combatscene_warriordir2w",combat.COMBATSCENE_EFFECT="combatscene_effect",combat.COMBATSCENE_EFFECT_SCREENPOS="combatscene_effect_screenpos",combat.COMBATSCENE_EFFECT2W="combatscene_effect2w",combat.COMBATSCENE_WARRIORREADY="combatscene_warriorready",combat.COMBATSCENE_ACTIONBEGIN="combatscene_actionbegin",combat.COMBATSCENE_ACTIONEND="combatscene_actionend",combat.COMBATSCENE_EMPTY="combatscene_empty",combat.COMBATSCENE_SETHP="combatscene_sethp",combat.COMBATSCENE_CRYOUT="combatscene_cryout",combat.COMBATSCENE_BLACKSCENE="combatscene_blackscene",combat.COMBATSCENE_CUSTOMEVENT="combatscene_customevent",combat.ACTION_INVALID=0,combat.ACTION_ADDWARRIOR=1,combat.ACTION_DELWARRIOR=2,combat.ACTION_SKILL=3,combat.ACTION_ADDBUFF=4,combat.ACTION_DELBUFF=5,combat.ACTION_BUFFCD=6,combat.ACTION_BUFFAUTOCD=7,combat.ACTION_PROPCHANGE=8,combat.ACTION_END=9,combat.ACTION_ENTER=10,combat.ACTION_SETHP=11,combat.ACTION_SETWARRIORADORN=12,combat.ACTION_CUSTOMEVENT=13,combat.ACTION_INITWARRIORS=14,combat.ACTION_INITWARRIORHPS=15,combat.ACTION_CHANGELINEUP=16,combat.DAMAGETYPE_HP_SUB=0,combat.DAMAGETYPE_HP_ADD=1,combat.DAMAGETYPE_CRACK=6,combat.DAMAGETYPE_DODGE=2,combat.DAMAGETYPE_SHAKE=3,combat.DAMAGETYPE_COUNTERATK=4,combat.DAMAGETYPE_CRYOUT=5}(combat||(combat={}));var combat;__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(combat){var combat_number_sp=function(_super){function combat_number_sp(){var _this=_super.call(this)||this;return _this.m_value=0,_this.m_root="combat_num/",_this.m_prex="damage_",_this.m_w=0,_this.m_h=0,_this.m_type=combat.DAMAGETYPE_HP_SUB,_this.m_text=null,_this}return __extends(combat_number_sp,_super),combat_number_sp.prototype.re_init=function(tp){this.m_type=tp,this.m_type==combat.DAMAGETYPE_HP_ADD?this.m_prex="heal_":this.m_type==combat.DAMAGETYPE_CRACK?this.m_prex="countdown_":this.m_prex="damage_"},combat_number_sp.prototype.set_content=function(c){this.release_pic(),null==this.m_text&&(this.m_text=new Laya.Label,this.m_text.color="#0000ff",this.m_text.stroke=1,this.m_text.strokeColor="#ffffff",this.m_text.fontSize=32,this.m_text.bold=!0,this.m_text.align="center",this.m_text.size(120,40),this.addChild(this.m_text)),this.m_text.text=c,this.init_wh()},combat_number_sp.prototype.set_value=function(v){this.m_value=v,this.release_pic(),this.m_type==combat.DAMAGETYPE_DODGE?0==this.m_value?this.loadImage(this.m_root+"damage_shan.png"):this.loadImage(this.m_root+"damage_bi.png"):this.m_type==combat.DAMAGETYPE_SHAKE?(null==this.m_text&&(this.m_text=new Laya.Label,this.m_text.color="#0000ff",this.m_text.stroke=1,this.m_text.strokeColor="#ffffff",this.m_text.fontSize=32,this.m_text.bold=!0,this.m_text.align="center",this.m_text.size(120,40),this.addChild(this.m_text)),this.m_text.text="反震"):this.m_type==combat.DAMAGETYPE_COUNTERATK?(null==this.m_text&&(this.m_text=new Laya.Label,this.m_text.color="#0000ff",this.m_text.stroke=1,this.m_text.strokeColor="#ffffff",this.m_text.fontSize=32,this.m_text.bold=!0,this.m_text.align="center",this.m_text.size(120,40),this.addChild(this.m_text)),this.m_text.text="反击"):this.loadImage(this.m_root+this.m_prex+v.toString()+".png"),this.init_wh()},combat_number_sp.prototype._init_cryout_wh=function(){this.m_w=120,this.m_h=40},combat_number_sp.prototype._init_counteratk_wh=function(){this.m_w=120,this.m_h=40},combat_number_sp.prototype._init_shake_wh=function(){this.m_w=120,this.m_h=40},combat_number_sp.prototype._init_dodge_wh=function(){this.m_w=32,this.m_h=32},combat_number_sp.prototype._init_sub_wh=function(){switch(this.m_w=16,this.m_h=16,this.m_value){case 0:this.m_w=34,this.m_h=34;break;case 1:this.m_w=22,this.m_h=33;break;case 2:case 3:this.m_w=32,this.m_h=34;break;case 4:case 5:this.m_w=34,this.m_h=34;break;case 6:this.m_w=32,this.m_h=34;break;case 7:this.m_w=34,this.m_h=36;break;case 8:case 9:this.m_w=32,this.m_h=34}},combat_number_sp.prototype.init_add_wh=function(){switch(this.m_w=16,this.m_h=16,this.m_value){case 0:this.m_w=34,this.m_h=31;break;case 1:this.m_w=18,this.m_h=31;break;case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:this.m_w=34,this.m_h=31}},combat_number_sp.prototype._init_countdown_wh=function(){switch(this.m_w=16,this.m_h=16,this.m_value){case 0:this.m_w=48,this.m_h=47;break;case 1:this.m_w=32,this.m_h=47;break;case 2:case 3:case 4:this.m_w=48,this.m_h=47;break;case 5:this.m_w=50,this.m_h=47;break;case 6:this.m_w=48,this.m_h=47;break;case 7:this.m_w=50,this.m_h=47;break;case 8:this.m_w=48,this.m_h=47;break;case 9:this.m_w=50,this.m_h=47}this.m_w-=2},combat_number_sp.prototype._init_crack_wh=function(){switch(this.m_w=16,this.m_h=16,this.m_value){case 0:this.m_w=32,this.m_h=30;break;case 1:this.m_w=20,this.m_h=30;break;case 2:case 3:this.m_w=32,this.m_h=30;break;case 4:this.m_w=30,this.m_h=30;break;case 5:case 6:case 7:case 8:case 9:this.m_w=32,this.m_h=30}},combat_number_sp.prototype.init_wh=function(){this.m_type==combat.DAMAGETYPE_HP_ADD?this.init_add_wh():this.m_type==combat.DAMAGETYPE_HP_SUB?this._init_sub_wh():this.m_type==combat.DAMAGETYPE_DODGE?this._init_dodge_wh():this.m_type==combat.DAMAGETYPE_SHAKE?this._init_shake_wh():this.m_type==combat.DAMAGETYPE_CRYOUT?this._init_cryout_wh():this.m_type==combat.DAMAGETYPE_COUNTERATK?this._init_counteratk_wh():this.m_type==combat.DAMAGETYPE_CRACK&&this._init_countdown_wh()},combat_number_sp.prototype.release_pic=function(){this.removeChildren(),null!=this.m_text&&(this.m_text=null),this.graphics.clear()},combat_number_sp.prototype.dispose=function(){this.release_pic()},combat_number_sp}(laya.display.Sprite);combat.combat_number_sp=combat_number_sp;var combat_number=function(_super){function combat_number(){var _this=_super.call(this)||this;return _this.m_value=0,_this.m_type=0,_this.m_life=0,_this.m_obj_id=0,_this.m_text="",_this.m_sp_list=new Array,_this}return __extends(combat_number,_super),combat_number.prototype.re_init=function(v,tp,content){void 0===content&&(content=""),this.m_value=v,this.m_type=tp,this.m_sp_list.length=0,this.m_text=content},combat_number.prototype.release_allsp=function(){this.removeChildren();for(var _i=0,_a=this.m_sp_list;_i<_a.length;_i++){var i=_a[_i];laya.utils.Tween.clearAll(i),this._del_sp(i)}this.m_sp_list=new Array},combat_number.prototype._get_sp=function(tp){var ret=utils.getitembycls("combat_number_sp",combat_number_sp);return ret.re_init(tp),ret},combat_number.prototype._del_sp=function(ins){ins.dispose(),utils.recover("combat_number_sp",ins)},combat_number.prototype.start=function(){this.release_allsp();var dx=0,idx=0,totalw=0;if(this.m_type==combat.DAMAGETYPE_DODGE){(shan=this._get_sp(this.m_type)).set_value(0),this.m_sp_list.push(shan),shan.x=0,shan.y=150,this.addChild(shan),laya.utils.Tween.to(shan,{y:50},300,laya.utils.Ease.elasticOut,null,0);var bi=this._get_sp(this.m_type);bi.set_value(1),this.m_sp_list.push(bi),bi.x=shan.m_w,bi.y=150,this.addChild(bi),laya.utils.Tween.to(bi,{y:50},300,laya.utils.Ease.elasticOut,null,0),this.m_w=shan.m_w+bi.m_w,this.m_h=200,this.m_life=500}else if(this.m_type==combat.DAMAGETYPE_SHAKE||this.m_type==combat.DAMAGETYPE_COUNTERATK){(shan=this._get_sp(this.m_type)).set_value(0),this.m_sp_list.push(shan),shan.x=0,shan.y=0,this.addChild(shan),laya.utils.Tween.from(shan,{y:-160},300,laya.utils.Ease.elasticOut,null,0),this.m_w=shan.m_w,this.m_h=200,this.m_life=500}else if(this.m_type==combat.DAMAGETYPE_CRYOUT){var shan;(shan=this._get_sp(this.m_type)).set_content(this.m_text),this.m_sp_list.push(shan),shan.x=0,shan.y=0,this.addChild(shan),laya.utils.Tween.to(shan,{y:-50},500,laya.utils.Ease.elasticOut,null,0),this.m_w=shan.m_w,this.m_h=200,this.m_life=700}else{for(var _i=0,v_str_1=this.m_value.toString();_i<v_str_1.length;_i++){var i=v_str_1[_i],snum=this._get_sp(this.m_type);snum.set_value(parseInt(i)),this.m_sp_list.push(snum),snum.x=dx,snum.y=0,this.addChild(snum),laya.utils.Tween.from(snum,{y:-50},300,laya.utils.Ease.elasticOut,null,50*idx),idx+=1,dx+=snum.m_w}this.m_life=50*(idx-1)+300,totalw=dx,this.m_w=totalw,this.m_h=200}this.y=-100,this.x=0-this.m_w/2},combat_number.prototype.tick=function(delta){this.m_life-=delta},combat_number.prototype.is_end=function(){return this.m_life<=0},combat_number.prototype.dispose=function(){this.release_allsp(),utils.recover("combat_number",this)},combat_number.prototype.selfremove=function(){},combat_number}(core.renderspcontent);combat.combat_number=combat_number;var combat_cryout=function(_super){function combat_cryout(){var _this=_super.call(this)||this;return _this.m_graphic=null,_this.m_life=0,_this.m_obj_id=0,_this.m_text=null,_this.m_framecurrent=0,_this.m_framemillsec=0,_this.m_frametotalmillsec=0,_this.m_framecurrenttm=0,_this.m_graphic=new laya.display.Animation,_this.m_text=new Laya.Label,_this.m_text.color="#ffffff",_this.m_text.stroke=1,_this.m_text.strokeColor="#1794f9",_this.m_text.fontSize=24,_this.m_text.align="center",_this.m_text.font="h5font",_this.m_text.x=-40,_this.m_text.y=-10,_this.m_text.size(120,40),_this.addChild(_this.m_graphic),_this.addChild(_this.m_text),_this}return __extends(combat_cryout,_super),combat_cryout.prototype.re_init=function(content){void 0===content&&(content=""),this.m_text.text=content,this.m_graphic.visible=!1,this.m_text.visible=!1},combat_cryout.prototype.start=function(){this.m_text.visible=!0,this.m_graphic.visible=!0,this.m_graphic.loadAnimation("game_ani/combat/cryout.ani"),this.m_graphic.stop(),this.m_graphic.play(0,!1,"ani1"),this.m_graphic.gotoAndStop(0),this.m_life=1500,this.y=-150,this.x=-20,this.m_framecount=5,this.m_framespeed=10,this.m_framecurrenttm=0,this.m_framemillsec=1e3/this.m_framespeed,this.m_frametotalmillsec=1e3*this.m_framecount/this.m_framespeed},combat_cryout.prototype.tick=function(delta){this.m_life-=delta,this.m_framecurrenttm+=delta;var framecount=Math.floor(this.m_framecurrenttm/this.m_framemillsec);this.m_framecurrent=framecount%this.m_framecount,this.m_framecurrenttm>=this.m_frametotalmillsec&&(this.m_framecurrent=this.m_framecount-1),this.m_graphic.gotoAndStop(this.m_framecurrent)},combat_cryout.prototype.is_end=function(){return this.m_life<=0},combat_cryout.prototype.dispose=function(){utils.recover("combat_cryout",this)},combat_cryout.prototype.selfremove=function(){},combat_cryout}(core.renderspcontent);combat.combat_cryout=combat_cryout;var combat_crack=function(_super){function combat_crack(){var _this=_super.call(this)||this;return _this.m_graphic=null,_this.m_framecurrent=0,_this.m_framemillsec=0,_this.m_frametotalmillsec=0,_this.m_framecurrenttm=0,_this.m_graphic=new laya.display.Animation,_this.addChild(_this.m_graphic),_this}return __extends(combat_crack,_super),combat_crack.prototype.re_init=function(v,tp,content){void 0===content&&(content=""),_super.prototype.re_init.call(this,v,tp,content),this.m_graphic.visible=!1,this.m_graphic.scale(2,2)},combat_crack.prototype.start=function(){this.release_allsp(),this.addChild(this.m_graphic);for(var dx=0,totalw=0,_i=0,v_str_2=this.m_value.toString();_i<v_str_2.length;_i++){var i=v_str_2[_i],snum=this._get_sp(this.m_type);snum.set_value(parseInt(i)),this.m_sp_list.push(snum),snum.x=dx,snum.y=0,this.addChild(snum),1,dx+=snum.m_w,totalw+=snum.m_w}this.m_graphic.visible=!0,this.m_graphic.loadAnimation("game_ani/combat/crack.ani"),this.m_graphic.stop(),this.m_graphic.play(0,!1,"ani1"),this.m_graphic.gotoAndStop(0),this.m_framecount=11,this.m_framespeed=20,this.m_framemillsec=1e3/this.m_framespeed,this.m_frametotalmillsec=1e3*this.m_framecount/this.m_framespeed,this.m_life=800,this.m_w=totalw,this.m_h=200,this.y=-100,this.x=0-this.m_w/2,this.m_graphic.x=this.m_w/2,this.m_graphic.y=20,this.m_framecurrenttm=0},combat_crack.prototype.tick=function(delta){this.m_life-=delta,this.m_framecurrenttm+=delta;var framecount=Math.floor(this.m_framecurrenttm/this.m_framemillsec);if(this.m_framecurrent=framecount%this.m_framecount,this.m_framecurrenttm>=this.m_frametotalmillsec)return this.m_framecurrent=this.m_framecount-1,void(this.m_graphic.visible=!1);this.m_graphic.gotoAndStop(this.m_framecurrent)},combat_crack.prototype.is_end=function(){return this.m_life<=0},combat_crack.prototype.dispose=function(){this.release_allsp(),utils.recover("combat_crack",this)},combat_crack.prototype.selfremove=function(){},combat_crack}(combat_number);combat.combat_crack=combat_crack;var combat_lineup=function(_super){function combat_lineup(){var _this=_super.call(this)||this;return _this.m_graphic=null,_this.m_obj_id=0,_this.m_graphic=new Laya.Sprite,_this.addChild(_this.m_graphic),_this}return __extends(combat_lineup,_super),combat_lineup.prototype.re_init=function(){this.m_obj_id=0,this.m_graphic.x=0,this.m_graphic.y=0,this.m_graphic.graphics.clear()},combat_lineup.prototype.set_respath=function(path,x,y){this.m_graphic.graphics.loadImage(path),this.m_graphic.x=x,this.m_graphic.y=y},combat_lineup.prototype.dispose=function(){utils.recover("combat_lineup",this)},combat_lineup.prototype.selfremove=function(){},combat_lineup}(core.renderspcontent);combat.combat_lineup=combat_lineup}(combat||(combat={})),function(combat){function player_sort(a,b){return a.m_sortnum-b.m_sortnum}var combat_playernode=function(){function combat_playernode(tm,event,user_data,mgr){this.m_tm=0,this.m_idx=0,this.m_sortnum=0,this.m_event="",this.m_ud=null,this.m_tm=tm,this.m_event=event,this.m_ud=user_data,this.m_mgr=mgr}return combat_playernode.prototype.set_idx=function(idx){this.m_idx=idx,this.m_sortnum=this.m_tm+1*this.m_idx/100},combat_playernode.prototype.do=function(tm){return!(tm<this.m_tm)&&(this.m_mgr.fire_event(this.m_event,this.m_ud),!0)},combat_playernode}();combat.combat_playernode=combat_playernode;var combat_player=function(){function combat_player(){this.m_arr=new Array,this.m_b_end=!1,this.m_cur_tm=0,this.m_cur_idx=0,this.m_max_idx=0}return combat_player.prototype.addnode=function(node){node.set_idx(this.m_arr.length),this.m_arr.push(node)},combat_player.prototype.start=function(){this.m_arr.sort(player_sort),this.m_cur_tm=0,this.m_cur_idx=0,this.m_max_idx=this.m_arr.length,this.m_b_end=!1},combat_player.prototype.clear=function(){this.m_arr=new Array,this.m_b_end=!0},combat_player.prototype.is_end=function(){return this.m_b_end},combat_player.prototype.update=function(delta){if(!this.is_end()){this.m_cur_tm=this.m_cur_tm+delta;for(var i=this.m_cur_idx;i<this.m_max_idx;++i){if(0==this.m_arr[i].do(this.m_cur_tm))return void(this.m_cur_idx=i)}this.m_b_end=!0}},combat_player}();combat.combat_player=combat_player}(combat||(combat={}));